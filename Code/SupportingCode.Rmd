---
title: "Supporting Code"
description: |
  "for _Rewiring the carbon cycle: a theoretical framework for animal-driven ecosystem carbon sequestration_"
author:
  - first_name: "Matteo" 
    last_name: "Rizzuto" 
    url: https://matteorizzuto.github.io
    affiliation: School of the Environment, Yale University
    affiliation_url: https://environment.yale.edu
    orcid_id: https://orcid.org/0000-0003-3065-9140
  - first_name: "Shawn J." 
    last_name: "Leroux" 
    url: https://shawnleroux.wixsite.com/lerouxlab
    affiliation: Department of Biology, Memorial University of Newfoundland
    affiliation_url: https://mun.ca/biology
    orcid_id: https://orcid.org/0000-0001-9580-0294  
  - first_name: "Oswald J." 
    last_name: "Schmitz" 
    url: http://schmitz.environment.yale.edu
    affiliation: School of the Environment, Yale University
    affiliation_url: https://environment.yale.edu
    orcid_id: https://orcid.org/0000-0003-1515-2667    
date: "`r Sys.Date()`"
creative_commons: CC BY-NC-ND
repository_url: https://github.com/matteorizzuto/RewiringCarbonCycle
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
    code_folding: true
    self_contained: true
    highlight_downlit: true
    creative_commons: CC BY-SA
    fig.retina: 3
bibliography: Bibliography.bib
---

```{r setup, echo=TRUE, tidy=TRUE}
# Notebook setup

# note: this notebooks uses package "downlit" in the YAML 
# options to provide contextual linking of functions called in
# code chunk to their online documentation on https://rdrr.io
# a short description precedes each package 

# package loading

# collection of pkgs, including ggplot2, dplyr, forcats, etc, for cleaner code
library("tidyverse")
# latin hypercube sampling
library("lhs")
# additional geoms for ggplot2 to plot half-geoms 
library("gghalves") 
# color palette collection, based on art masterpieces stored at the MET
library("MetBrewer")
library("MoMAColors")
# easy table creation
library("gt")
# data summary table creation
library("gtsummary")
# easily combine multiple ggplot2 object
library("patchwork")
# access to more markdown functions
library("rmarkdown")
# keep track of pkgs used & their version
library("renv")
# utilities
library("utils")
# extra utilities for ggplot2
library("ggh4x")
# extra themes and functions for ggplot2
library("cowplot")
# file system operations
library("fs")
# fit randomForest models as part of a global sensitivity analysis
library("randomForest")
# save ggplot2 objects as .svg or .eps
library("svglite")
# produce plots with insets
# remotes::install_github("hughjonesd/ggmagnify")
library("ggmagnify")

# save an image of the package library in use in renv for ease of transfer
snapshot()

# set the theme for all ggplot2 objects
theme_set(theme_classic())

# set width and height for 16:9 graphs
width <- 10
height <- (9/16)*width

# palette for colors in patchwork graphs
palt <- met.brewer("Egypt", 2, "discrete")

# palette to highlight pos/neg values in scatterplots
pp_highlight_pos <- c("grey", "#00BFC4")
pp_highlight_neg <- c("grey", "#F8766D")

# formula to print scientific notation as "10^" instead of "e+", from:
# https://stackoverflow.com/a/24241954

fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # to 0 show up as 0
     l <- gsub("0e\\+00", "0", l)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}
```

# Introduction

In this notebook, we analyse a novel ecosystem carbon budget model that accounts
for and quantifies the effects of animal consumers---herbivores and predators---
on ecosystem carbon accounting. We refer the interested reader to our manuscript 
[@Rizzuto2023preprint] for details on the rationale of this model, and to the 
Mathematica [@Mathematica2022] notebook in this same repository for details of 
the model's mathematical development.

In section [Numerical analyses], we use a randomly-drawn parameter set to 
explore the behavior of the model in the three modeling scenarios described in
the manuscript---namely, (i) a control scenario with not animals, (ii) a first 
experimental scenario with only herbivores present in the ecosystem, and (iii) a
second experimental scenario with herbivores and predators present. The 
parameter set we use are assembled using a latin hypercube sampling design 
[@lhs2022], scaled to match empirical and theoretical constraints on the range 
of values of each parameter. The following section [Sensitivity analyses] 
contains the code and results of a global sensitivity analysis 
[@Harper2011;@Bellmore2014] of the relative importance of each parameter within 
the model, in each of the three modeling scenarios. In the 
[Ecosystem function analyses] section, we detail our analyses of animal impacts 
on three key ecosystem functions---plant biomass accumulation, 
primary production, and net ecosystem carbon balance. In section 
[Visual deliverables], we produce produce graphs to interpret
the results of our modeling exercise. Finally, in the [Publication figures] 
section, we present the code used to produce the figures in the manuscript.

#### Analyses setup

We compiled this notebook on a machine using the following version of 
R, operative system, and necessary packages:

```{r session-information, echo=FALSE}
utils:::print.sessionInfo(sessionInfo()[-8])
```

Furthermore, this notebook relies on relative paths to load and save objects 
throughout and, as such, is designed to use this folder structure or a similar 
one:

```{r dir-tree, echo=TRUE, tidy=TRUE}
dir_tree(path = "../", recurse = 0 , all = FALSE, type = "directory")
```

# Numerical analyses

Here, we perform numerical analyses of the stability and dynamics of the 
equilibria found for our model, across the three modeling scenarios listed in 
the [Introduction]. For each scenario, we will be using the single equilibrium 
were all state variables are feasible (i.e., \(S_{i}, P_{i}, H_{i}, R_{i} > 0\),
where \(i \in [N, C]\); see manuscript for further details), as 
derived in Mathematica [@Mathematica2022].

First, we load the datasets that were pre-generated using the same code reported
below and stored as .csv files for ease of reproducing the results. 

```{r data-load, eval=TRUE, echo=TRUE, tidy=TRUE}
# random parameter values for parameters scaled 0--10 
pDATA1 <- read.csv("../Data/pDATA1.csv", header = T, sep = ",")
# random parameter values for parameters scaled 0--1
pDATA2 <- read.csv("../Data/pDATA2.csv", header = T, sep = ",")
# random parameter values for C:N parameters
cnDATA <- read.csv("../Data/cnDATA.csv", header = T, sep = ",")
```

Next, we set a value of 0.5 for parameter _k_, the loss rate of N from the soil 
compartment, based on previous studies [@Leroux2012].

```{r k-value, echo=TRUE,tidy=TRUE}
# parameter k will remain the same throughout analyses
k <- 0.5
```

Alternatively, we can generate a new set of 10000 randomly-drawn values for the 
model's parameters, to use in fitting the model. The parameters can be grouped 
into three main categories:

* random parameters, including _I_, _a~j~_, _r~j~_, _q~S~_, _δ_, _π_, and _τ_
* C:N ratio parameters, including _α_ and _β_
* fixed parameters, _k_

where \(j \in [P, H, R]\). We separate the C:N ratio parameters because, unlike 
the other parameters, their random draw is constrained within a certain range of
values informed by empirical data reported in the literature [@Buchkowski2019]. 
Note also that parameters _δ_, _π_, and _τ_ are scaled $\in [0, 1]$ as they are 
proportions (see **Table 2** in the manuscript). The only fixed parameter is the
nutrient loss rate from the soil compartment, _k_.

First, we will use a latin hypercube sampling design [@lhs2022] to randomly draw 
values for parameters _I_, _a~j~_, _r~j~_, and _q~S~_, scaling them 
$\in [0, 10]$. Then, we will draw random values for parameters _δ_, _π_, and _τ_ 
and scale them $\in [0, 1]$. 

<aside>
Note: this code chunk is disabled. To run it, change the value of `eval` to 
`TRUE` in the chunk 
</aside>
```{r param-value-gen, eval=FALSE,echo=TRUE,tidy=TRUE}
# use a latin hypercube (lhs) to generate random data to fit the model
# lhs has 100 bins
# stack bins together to produce 10k data for the model
# we have 5 parameters scaled 0-10 in the model, so lhs has 5 columns

# NOTE: this excludes C:N ratio data, see below

# allocate empty object to store parameter values
pDATA1 <- NULL

# use a loop to create 10k parameter values
for (i in seq(1, 100, 1)) {
  # create random latin hypercube
  pLHS <- randomLHS(100, 8)  
  # stack lhs results together
  pDATA1 <- rbind(pDATA1, data.frame(i=i, Result=pLHS*10))
  # print i to keep track of progress
  # print(i)
  # remove pLHS object 
  rm(pLHS)
}

write.csv(pDATA1, file = "../Data/pDATA1.csv", row.names = FALSE)

# Now, repeat for the 2 parameters scaled 0-1

# allocate empty object to store parameter values
pDATA2 <- NULL

# use a loop to create 10k parameter values
for (i in seq(1, 100, 1)) {
  # create random latin hypercube
  pLHS <- randomLHS(100, 3)  
  # stack lhs results together
  pDATA2 <- rbind(pDATA2, data.frame(i=i, Result=pLHS))
  # print i to keep track of progress
  # print(i) 
  # remove pLHS object 
  rm(pLHS)
}

write.csv(pDATA2, file = "../Data/pDATA2.csv", row.names = FALSE)
```

Now, we draw values for parameters _α_ and _β_, the C:N parameters for plants and 
animals, respectively. After using the latin hypercube, we will transform its 
margins to re-scale the randomly-drawn values to be $\in [5, 150]$ for 
plants and $\in [3, 10]$ for herbivores [@Buchkowski2019]. The code to perform 
this rescaling comes from the [`lhs_basics` vignette](https://cran.r-project.org/web/packages/lhs/vignettes/lhs_basics.html) [@lhs2022].

<aside>
Note: this code chunk is disabled. To run it, change the value of `eval` to 
`TRUE` in the chunk 
</aside>
```{r cn-value-gen, eval=FALSE,echo=TRUE, tidy=TRUE}
# to produce random values for C:N ratio of plants and animals we use lhs again
# but after creating the lhs, we will transform its margins to constrain
# the distribution of values within the C:N ranges reported in the literature

# code taken from https://cran.r-project.org/web/packages/lhs/vignettes/lhs_basics.html

# allocate empty dataframe
cnDATA <- NULL

# create the lhs, only 2 bins because we only have 2 C:N parameters in the model
for (i in seq(1, 100, 1)) {
  # create the LHS containing random values for 2 C:N parameters
  cnLHSa <- randomLHS(100, 2)
  # not, create a matrix w/ same dimensions that will contain the rescaled values
  cnLHSb <- matrix(nrow = nrow(cnLHSa), ncol = ncol(cnLHSa))
  # rescale values for plants C:N, range 5-150
  cnLHSb[, 1] <- qunif(cnLHSa[, 1], min = 5, max = 150)
  # rescale values for animals C:N, range 3-10
  cnLHSb[, 2] <- qunif(cnLHSa[, 2], min = 3, max = 10)
  # rbind the matrix into a dataframe w/ 3 columns
  cnDATA <- rbind(cnDATA, data.frame(i = i, 
                                     Plants = cnLHSb[,1], 
                                     Animals = cnLHSb[,2]))
  # print i to keep track of progress
  # print(i)
}

write.csv(cnDATA, file = "../Data/cnDATA.csv", row.names = FALSE)
```

## Scenario (i): an ecosystem without animals

Here, we fit the set of random parameter values generated above to scenario (i), 
where the ecosystem only includes soil and plants (**Figure 1a** in the 
manuscript). As mentioned above, we work with the single feasible equilibrium of
produced by the model in this scenario (see manuscript for the full system of 
equations). The following set of equations describes this equilibrium:

<aside>
Here, because of the C:N ratio of plants,
$$
P^*_C = \alpha \cdot P^*_N
$$
and the model reduces to just three equations.
</aside>
$$
  S^*_{N} = \frac{I}{k}
$$
$$
  S^*_{C} = \frac{kr_{P}}{a_{P}I}
$$
$$
  P^*_{N} = \frac{q_{S}}{a_{P}\alpha (1 - \delta)}
$$

We store store results in an object labelled `naRESrandomI`, where `na` stands 
for _no animal_.

First, we allocate a new, empty dataframe to store the results from these new 
iterations of the model.

```{r scenario-1-random-I-setup, echo=TRUE, tidy=TRUE}
naRESrandomI <- NULL

naRESrandomI <- rbind(naRESrandomI, 
                   data.frame(TIME = seq(1, 100, 1), 
                              I = seq(1, 100, 1), 
                              k = seq(1, 100, 1), 
                              Soil_N = seq(1, 100, 1), 
                              Soil_C = seq(1, 100, 1), 
                              Plant_N = seq(1, 100, 1), 
                              α = seq(1, 100, 1), δ = seq(1, 100, 1), 
                              ap = seq(1, 100, 1), rp = seq(1, 100, 1), 
                              q = seq(1, 100, 1)))
```

In the following code chunks, we use a `for` loop with nested `if` statements
to run the model for 10000 times. Before fitting the model, we allocate an empty 
dataset to store the resulting stocks and parameters values and check that the 
parameter values satisfy the model's feasibility conditions. In the _no animal_ 
scenario, the model is feasible when $\alpha > 0$, $0 < \delta < 1$, $r_{P} > 0$,
$q_{S} > 0$, $k > 0$, $I > 0$, and $a_{P} > 0$.

```{r scenario-1-random-I-run, echo=TRUE, tidy=FALSE}
# we want to start the loop at 0, so we create a custom index object
i1 <- 0

# this loop fits the model using parameter values from the pDATA1, pDATA2 and cnDATA 
# objects created above
for (i in seq(0, 9999, 1)) {
  # take one step forward in time
  i1 <- i1 + 1
  
  # sample parameters from the data objects created above
  # N mineralization rate
  ap <- pDATA1[i1, 2]
  # N recycling rates
  rp <- pDATA1[i1, 4]
  # C loss rate from inorganic soil pool
  q <- pDATA1[i1, 6]
  # inorganic nutrient input to soil compartment
  I <- pDATA1[i1, 7]
  # proportion of plant C that is respired
  δ <- pDATA2[i1, 2]
  # C:N ratio of plants
  α <- cnDATA[i1, 2]
  
  # now, we use an if statement to check the feasibility condition of the 
  # equilibrium we are analyzing and then run the model
  if (α>0 & δ>0 & δ<1 & rp>0 & q>0 & k>0 & I>0 & ap>0) 
    { # if the feasibility conditions are satisfied, the i1-th row of nhRESmidI gets
      # the values of each parameter and the results from solving the equilibrium
      # equations for each state variable
    naRESrandomI[i1, ] <- c(i1, I, k, 
                         # soil N
                         (I/k), 
                         # soil C
                         (k*rp)/(ap*I),
                         # plant N
                         q/(ap*α-ap*α*δ),
                         α, δ, ap, rp, q)} 
  else  
    { # if the feasibility conditions are not satisfied, the i1-th of nhRESmidI gets
      # the values of each parameter and 0 for all state variables
      naRESrandomI[i1, ] <- c(i1, I, k, 0, 0, 0, α, δ, ap, rp, q)}
  
  # browser()  
}


naRESrandomI <- naRESrandomI %>% mutate(., biosense = ifelse(Soil_N > 0 &
                                                             Soil_C > 0 &
                                                             Plant_N > 0,
                                                           "yes",
                                                           "no"),
                                      .after = q) %>%
  mutate_at(vars(biosense), factor)
```

Finally, we calculate the value of plant C stocks at equilibrium and remove all 
sets of parameters yielding stock variable values _= 0_ at equilibrium. 

```{r scenario-1-random-I-add-state-var, echo=TRUE, tidy=TRUE}
naRESrandomI_pos <- naRESrandomI %>% 
  mutate(., Plant_C = α*Plant_N, .after = Plant_N) %>% 
  dplyr::filter(., Soil_N > 0 & 
           Soil_C > 0 & 
           Plant_N > 0 & 
           Plant_C > 0) %>% 
  # this mutate call standardizes each compartment's C or N content
  # to the total C or N content of the system
  mutate(., Total_Soil = (Soil_N + Soil_C),
         Total_Plant = (Plant_N + Plant_C),
         Total_N = (Soil_N + Plant_N), 
         Total_C = (Soil_C + Plant_C), 
         Soil_Nstd = Soil_N/Total_N, 
         Plant_Nstd = Plant_N/Total_N, 
         Soil_Cstd = Soil_C/Total_C, 
         Plant_Cstd = Plant_C/Total_C) 

paged_table(naRESrandomI_pos)
```

No parameter set produces an equilibrium where state variables are _= 0_ (n = 
**`r prettyNum(nrow(naRESrandomI_pos))`**). 

## Scenario (ii): an ecosystem with herbivores but no predators

Here, we fit the set of parameter values generated above to the second modeling 
scenario, where the ecosystem contains soil, plants, and herbivores but no 
predators (**Figure 1b** in the manuscript). Again, we use its only feasible 
equilibrium as reported in the manuscript's Appendices. This equilibrium is 
described by the following set of equations:

$$
  S^*_N = \frac{I}{k}
$$
$$
  S^*_C = \frac{kr_{H}r_{P}\left(\alpha (1 - \delta) + \left(\pi - 1\right)\beta\right)}{I(a_{H}q_{S}+a_{P}\left(\pi - 1\right)\beta r_{H})}
$$
$$
  P^*_N = \frac{r_H}{a_H}
$$
$$
  H^*_N = −\frac{r_P\left(a_{H}q_{S}+a_{P}r_{H}\alpha\left(\delta - 1\right)\right)}{a_{H}\left(a_{H}q_{S}+a_{P}\left(\pi - 1\right)\beta r_{H}\right)}
$$

<aside>
Note that, because of the C:N ratio of plants and herbivores, 
$$
P^*_C = \alpha \cdot P^*_N
$$
and
$$
H^*_C = \beta \cdot H^*_N
$$
And the model reduces to just four equations.
</aside>

First, let's allocate an empty dataframe `hRESrandomI`, where `h` stands for 
_herbivore_.

```{r scenario-2-random-I-setup, echo=TRUE, tidy=TRUE}
hRESrandomI <- NULL

hRESrandomI <- rbind(hRESrandomI, 
                   data.frame(TIME = seq(1, 100, 1), 
                              I = seq(1, 100, 1), 
                              k = seq(1, 100, 1), 
                              Soil_N = seq(1, 100, 1), 
                              Soil_C = seq(1, 100, 1), 
                              Plant_N = seq(1, 100, 1), 
                              Herbivore_N = seq(1, 100, 1),  
                              α = seq(1, 100, 1), β = seq(1, 100, 1), 
                              π = seq(1, 100, 1), δ = seq(1, 100, 1), 
                              ap = seq(1, 100, 1), ah = seq(1, 100, 1), 
                              rp = seq(1, 100, 1), rh = seq(1, 100, 1), 
                              q = seq(1, 100, 1)))
```

Below, we run the loop. Again, at each time step, an `if` statement checks the 
feasibility conditions and, if these are satisfied, calculates and store the 
state variables' values and the corresponding parameter set in the i-th row of 
`hRESrandomI`. Note that the conditions for the `if` statement are the 
feasibility conditions of the only feasible equilibrium found in Mathematica 
[@Mathematica2022]. When $\alpha > 0$, $\beta > 0$, $a_H > 0$, $a_P > 0$, 
$I > 0$, $k > 0$, $r_H > 0$, $r_P > 0$, then the equilibrium stated above is 
feasible when,

* $0 < \pi < 1$, and either 
    + $a_{H} (a_{H} q_{S} + a_{P} (\pi − 1)r_{H} \beta) < 0$ and either
        - $\delta \geq 1$, and $q_S > 0$ 
        - $\beta > \frac{\alpha(\delta − 1)}{(\pi − 1)}$, $a_{H} (a_{H} q_{S} + a_{P} r_{H} \alpha(\delta − 1)) > 0$, $0 < \delta < 1$, or when
    + $0 < \delta < 1$, $\beta < \frac{\alpha (\delta − 1)}{(\pi − 1)}$, $a_{H} (a_{H} q_{S} + a_{P} r_{H} \alpha(\delta − 1)) < 0$, and $a_{H} (a_{H} q_{S} + a_{P} (\pi − 1)r_{H} \beta) > 0$, or when
 * $\pi \geq 1$, $q_{S} > 0$, $0 < \delta < 1$, and $a_{H} (a_{H} q_{S} + a_{P} r_{H} \alpha(\delta − 1)) < 0$

```{r scenario-2-random-I-run, echo=TRUE, tidy=FALSE}
# we want to start the loop at 0, so we create a custom index object
i1 <- 0

# this loop fits the model using parameter values from the pDATA1, pDATA2 and 
# cnDATA objects created above
for (i in seq(0, 9999, 1)) {
  # take one step forward in time
  i1 <- i1 + 1
  
  # sample parameters from the data objects created above
  # N mineralization rate
  ap <- pDATA1[i1, 2]
  # Herbivore nutrition rate
  ah <- pDATA1[i1, 3]
  # N recycling rates
  rp <- pDATA1[i1, 4]
  rh <- pDATA1[i1, 5]
  # C loss rate from inorganic soil pool
  q <- pDATA1[i1, 6]
  # inorganic nutrient input to soil compartment
  I <- pDATA1[i1, 7]
  # proportion of plant C that is respired
  δ <- pDATA2[i1, 2]
  # proportion of herbivore C that is respired
  π <- pDATA2[i1, 3]
  # C:N ratio of plants
  α <- cnDATA[i1, 2]
  # C:N ratio of herbivores
  β <- cnDATA[i1, 3]
  
  # check the feasibility conditions 
  if (α>0 & ah>0 & ap>0 & I>0 & k>0 & rh>0 & rp>0 & 
      ((π>0 & π<1 & 
        ((ah*(ah*q+ap*(π-1)*rh*β)<0 & 
          ((β>0 & δ>=1 & q>0) | # δ>=1 cannot be! how to address this?
           (β>(α*(δ-1))/(π-1) & ah*(ah*q+ap*rh*α*(δ-1))>0 & δ>0 & δ<1))) | 
         (β>0 & δ>0 & β<(α*(δ-1))/(π-1) & 
          ah*(ah*q+ap*rh*α*(δ-1))<0 & δ<1 & 
          ah*(ah*q+ap*(π-1)*rh*β)>0))) | 
       (β>0 & π>=1& q>0 & δ>0 & ah*(ah*q+ap*rh*α*(δ-1))<0 & δ<1))) # π>=1 cannot be! how to address this? theoretically, this conditions should never realized as we set the value of π to be within [0, 1], so R should automatically discard it
    { # if the feasibility conditions are satisfied, the i1-th row of hRESmidI gets
      # the values of each parameter and the results from solving the equilibrium
      # equations for each state variable
      hRESrandomI[i1, ] <- c(i1, I, k, 
                            # soil N
                            (I/k), 
                            # soil C
                            (k*rh*rp*(α+(-1+π)*β-α*δ))/(ah*I*q+ap*I*(-1+π)*rh*β),
                            # plant N
                            (rh/ah),
                            # herbivore N
                            (-((rp*(ah*q+ap*rh*α*(-1+δ)))/(ah*(ah*q+ap*(-1+π)*rh*β)))),
                            α, β, π, δ, ap, ah, rp, rh, q)} 
  else  
    { # if the feasibility conditions are not satisfied, the i1-th of hRESrandomI gets
      # the values of each parameter and 0 for all state variables
      hRESrandomI[i1, ] <- c(i1, I, k, 0, 0, 0, 0, α, β, π, δ, ap, ah, rp, rh, q)}
  
  # browser()  
}

hRESrandomI <- hRESrandomI %>% mutate(., biosense = ifelse(Soil_N > 0 &
                                                             Soil_C > 0 &
                                                             Plant_N > 0 &
                                                             Herbivore_N > 0,
                                                           "yes",
                                                           "no"),
                                      .after = q) %>%
  mutate_at(vars(biosense), factor)
```

As noted above, the stocks of C in the plant and herbivore compartments at 
equilibrium are simply the result of multiplying the plant and herbivore stocks 
of N by _α_ and _β_, respectively. The following chunk of code does this 
and then uses function `filter` from package `dplyr` to remove model runs for 
which state variables stocks are _= 0_. We store the remaining parameter sets
in object `hRESrandomI_pos`, where `_pos` stands for _positive_, for later use.

```{r scenario-2-random-I-add-state-var, echo=TRUE, tidy=TRUE}
hRESrandomI_pos <- hRESrandomI %>% 
  mutate(., Plant_C = α*Plant_N, .after = Plant_N) %>% 
  mutate(., Herbivore_C = β*Herbivore_N, .after = Herbivore_N) %>% 
  dplyr::filter(., Soil_N > 0 & 
           Soil_C > 0 & 
           Plant_N > 0 & 
           Plant_C > 0 & 
           Herbivore_N > 0 & 
           Herbivore_C > 0) %>%
   # this mutate call standardizes each compartment's C or N content
   # to the total C or N content of the system
  mutate(., Total_Soil = (Soil_N + Soil_C),
         Total_Plant = (Plant_N + Plant_C),
         Total_Herbivore = (Herbivore_N + Herbivore_C),
         Total_N = (Soil_N + Plant_N + Herbivore_N), 
         Total_C = (Soil_C + Plant_C + Herbivore_C), 
         Soil_Nstd = Soil_N/Total_N, 
         Plant_Nstd = Plant_N/Total_N,
         Herbivore_Nstd = Herbivore_N/Total_N, 
         Soil_Cstd = Soil_C/Total_C, 
         Plant_Cstd = Plant_C/Total_C, 
         Herbivore_Cstd = Herbivore_C/Total_C) 

paged_table(hRESrandomI_pos)
```

After removing the parameter sets that produce state variables _= 0_, we am left 
with **`r prettyNum(nrow(hRESrandomI_pos))`** parameter sets that yield feasible 
and positive (_> 0_) stock values for all state variables in the model. 

## Scenario (iii): an ecosystem with herbivores and predators

Here, we fit the same set of parameter values to a model with both herbivores 
and predators. As for previous two modeling scenarios, the model has a single 
feasible equilibrium in this third scenario. This set of equations describes the
feasible equilibrium:

<aside>
Here, again,
$$
P^*_C = \alpha \cdot P^*_N\\
H^*_C = \beta \cdot H^*_N\\
R^*_C = \beta \cdot R^*_N
$$
and the model reduces to five equations.
</aside>
$$
  S^*_{N} = \frac{I}{k}
$$
$$
  S^*_{C} = \frac{k (a_{R} r_{P} + a_{H} r_{R})}{a_{P} a_{R} I}
$$
$$
  P^*_{N} = -\frac{a_{R} q r_{P} + a_{H} q r_{R} + a_{P} r_{H} r_{R} \beta (\pi - \tau)}{a_{P} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))}
$$
$$
  H^*_{N} = \frac{r_{R}}{a_{R}}
$$
$$
  R^*_{N} = -\frac{a_{H} a_{R} q r_{P} + a_{H}^2 q r_{R} + a_{H} a_{P} (-1 + \pi) r_{H} r_{R} \beta + 
 a_{P} a_{R} r_{H} r_{P} \alpha (-1 + \delta)}{a_{P} a_{R} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))}
$$

As for the other two scenarios,, we will store results in an object called 
`predRESrandomI`, where `pred` stands for _herbivore and predator_.

First, we allocate a new, empty dataframe to store the results from these new 
iterations of the model.

```{r scenario-3-random-I-setup, echo=TRUE, tidy=TRUE}
predRESrandomI <- NULL

predRESrandomI <- rbind(predRESrandomI, 
                   data.frame(TIME = seq(1, 100, 1), 
                              I = seq(1, 100, 1), 
                              k = seq(1, 100, 1), 
                              Soil_N = seq(1, 100, 1), 
                              Soil_C = seq(1, 100, 1), 
                              Plant_N = seq(1, 100, 1), 
                              Herbivore_N = seq(1, 100, 1),
                              Predator_N = seq(1, 100, 1),
                              α = seq(1, 100, 1), β = seq(1, 100, 1), 
                              π = seq(1, 100, 1), δ = seq(1, 100, 1), 
                              τ = seq(1, 100, 1), ap = seq(1, 100, 1), 
                              ah = seq(1, 100, 1), ar = seq(1, 100, 1),
                              rp = seq(1, 100, 1), rh = seq(1, 100, 1),
                              rr = seq(1, 100, 1), q = seq(1, 100, 1)))
```

In running the model, we will once again check that the parameter values satisfy 
the model's feasibility conditions. In this scenario, the model is feasible when 
$0 < \tau < 1$, $0 < \pi < 1$, $r_{R} > 0$, $r_{P} > 0$, $a_{R} > 0$, $a_{H} > 0$, 
$ 0 < \delta < 1$, $\beta > 0$, $\alpha > 0$, $r_{H} > 0$, $q_{S} > 0$, 
$0 < a_{P} < -\frac{a_{H} q_{S} (a_{R} r_{P} + a_{H} r_{R})}{r_{H} (a_{H} (-1 + \pi) r_{R} \beta + a_{R} r_{P} \alpha (-1 + \delta]))}$, $k > 0$, and $I > 0$.

```{r scenario-3-random-I-run, echo=TRUE, tidy=FALSE}
# we want to start the loop at 0, so we create a custom index object
i1 <- 0

# this loop fits the model using parameter values from the pDATA1, pDATA2 and cnDATA 
# objects created above
for (i in seq(0, 9999, 1)) {
  # take one step forward in time
  i1 <- i1 + 1
  
  # sample parameters from the data objects created above
  # N mineralization rate
  ap <- pDATA1[i1, 2]
  # Herbivore nutrition rate
  ah <- pDATA1[i1, 3]
  # Predator uptake rate
  ar <- pDATA1[i1, 8]
  # N recycling rates
  rp <- pDATA1[i1, 4]
  rh <- pDATA1[i1, 5]
  rr <- pDATA1[i1, 9]
  # C loss rate from inorganic soil pool
  q <- pDATA1[i1, 6]
  # inorganic nutrient input to soil compartment
  I <- pDATA1[i1, 7]
  # proportion of plant C that is respired
  δ <- pDATA2[i1, 2]
  # proportion of herbivore C that is respired
  π <- pDATA2[i1, 3]
  # proportion of herbivore C that is respired
  τ <- pDATA2[i1, 4]
  # C:N ratio of plants
  α <- cnDATA[i1, 2]
  # C:N ratio of animals (herbivores and predators)
  β <- cnDATA[i1, 3]
  
  # now, we use an if statement to check the feasibility condition of the 
  # equilibrium we are analyzing and then run the model
  if (τ>0 && τ<1 && π>0 && π<1 && rr>0 && rp>0 && ar>0 && ah>0 && δ>0 && δ<1 && β>0 && α>0 && rh>0 && q>0 && ap>0 && ap<(-((ah*q*(ar*rp+ah*rr))/(rh*(ah*(-1+π)*rr*β+ar*rp*α*(-1+δ))))) && k>0 && I>0) 
    { # if the feasibility conditions are satisfied, the i1-th row of nhRESmidI gets
      # the values of each parameter and the results from solving the equilibrium
      # equations for each state variable
      predRESrandomI[i1, ] <- c(i1, I, k, 
                         # soil N
                         (I/k), 
                         # soil C
                         (k*(ar*rp+ah*rr))/(ap*ar*I),
                         # plant N
                         -((ar*q*rp+ah*q*rr+ap*rh*rr*β*(π-τ))/(ap*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))),
                         # herbivore N
                         rr/ar,
                         # predator N
                         -((ah*ar*q*rp+(ah^2)*q*rr+ah*ap*(-1+π)*rh*rr*β+ap*ar*rh*rp*α*(-1+δ))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))),
                         α, β, π, δ, τ, ap, ah, ar, rp, rh, rr, q)} 
  else  
    { # if the feasibility conditions are not satisfied, the i1-th of nhRESmidI gets
      # the values of each parameter and 0 for all state variables
      predRESrandomI[i1, ] <- c(i1, I, k, 0, 0, 0, 0, 0, α, β, π, δ, τ, ap, ah, ar, rp, rh, rr, q)}
  
  # browser()  
}


predRESrandomI <- predRESrandomI %>% mutate(., biosense = ifelse(Soil_N > 0 &
                                                             Soil_C > 0 &
                                                             Plant_N > 0 &
                                                             Herbivore_N > 0 &
                                                             Predator_N > 0,
                                                           "yes",
                                                           "no"),
                                      .after = q) %>%
  mutate_at(vars(biosense), factor)
```

Finally, we calculate the value of plant C stocks at equilibrium and remove all 
sets of parameters yielding stock variable values _= 0_ at equilibrium. 

```{r scenario-3-random-I-add-state-var, echo=TRUE, tidy=TRUE}
predRESrandomI_pos <- predRESrandomI %>% 
  mutate(., Plant_C = α*Plant_N, .after = Plant_N) %>% 
  mutate(., Herbivore_C = β*Herbivore_N, .after = Herbivore_N) %>% 
  mutate(Predator_C = β*Predator_N, .after = Predator_N) %>% 
  mutate(., biosense = ifelse(Soil_N > 0 &
                                Soil_C > 0 &
                                Plant_N > 0 &
                                Herbivore_N > 0 &
                                Predator_N > 0,
                              "yes",
                              "no"),
         .after = q) %>%
  mutate_at(vars(biosense), factor) %>% 
  dplyr::filter(., Soil_N > 0 & 
                  Soil_C > 0 & 
                  Plant_N > 0 & 
                  Plant_C > 0 &
                  Herbivore_N > 0 &
                  Herbivore_C > 0 &
                  Predator_N > 0 &
                  Predator_C > 0) %>% 
  # this mutate call standardizes each compartment's C or N content
  # to the total C or N content of the system
  mutate(., Total_Soil = (Soil_N + Soil_C),
         Total_Plant = (Plant_N + Plant_C),
         Total_Herbivore = (Herbivore_N + Herbivore_C),
         Total_Predator = (Predator_N + Predator_C),
         Total_N = (Soil_N + Plant_N + Herbivore_N + Predator_N), 
         Total_C = (Soil_C + Plant_C + Herbivore_C + Predator_C), 
         Soil_Nstd = Soil_N/Total_N, 
         Plant_Nstd = Plant_N/Total_N,
         Herbivore_Nstd = Herbivore_N/Total_N,
         Predator_Nstd = Predator_N/Total_N,
         Soil_Cstd = Soil_C/Total_C, 
         Plant_Cstd = Plant_C/Total_C,
         Herbivore_Cstd = Herbivore_C/Total_C,
         Predator_Cstd = Predator_C/Total_C) 

paged_table(predRESrandomI_pos)
```

After removing the parameter sets that produce state variables _= 0_, we are left 
with **`r prettyNum(nrow(predRESrandomI_pos))`** parameter sets that yield feasible 
and _> 0_ stock values for all state variables in scenario (iii).

Before proceeding further, we will combine the three dataframes containing the 
results for each scenario into a single object, `randomI`. We will use this 
object to run a [Sensitivity Analyses] and to produce all 
[Visual deliverables] and [Publication figures] below.

We will also save `randomI` as a `.csv` file by the same name in the 
`../Results/` folder. 

```{r graph-setup, echo=TRUE, tidy=TRUE}
# combine hRESrandomI_pos, naRESrandomI_pos, and predRESrandomI_pos into a single dataframe, 
# identifying the rows from either original dataframe via the model version used,
# with animals ("herbivore"), without animals ("absent"), and with herbivores and predators ("predator")
randomI <- dplyr::bind_rows("absent" = naRESrandomI_pos, 
                            "herbivore" = hRESrandomI_pos,
                            "predator" = predRESrandomI_pos,
                            .id = "herbivore") %>%
  mutate(., herbivore = as_factor(herbivore))



# write the new dataframe into a .csv file to use in other notebooks
write.csv(randomI, file = "../Results/randomI.csv")

paged_table(randomI)
```

# Sensitivity Analyses

Here, we run a Global Sensitivity Analysis (GSA; @Harper2011) to investigate the
relative importance of each parameter in our model, estimated as the 
parameter-specific residual sum of squared errors as calculated using a Random 
Forest algorithm. While a local sensitivity analysis allows to vary a single 
parameter over a range of values while keeping all others constant, a GSA varies
all parameter at once [@Harper2011;@Bellmore2014]. In addition to remove the 
need to arbitrarily select a constant value at which to keep all parameters not 
being varied, a GSA also accounts for possible interactions among parameters 
that would otherwise be lost in a local sensitivity analysis. Because of these 
features, a GSA is particularly well-suited to investigate the mechanics of 
complex mathematical models that rely on multiple parameters and may comprise 
non-linear relationships among them [@Harper2011;@Bellmore2014].

## Scenario (i): an ecosystem without animals

The code chunk below uses function `randomForest()` from the package of the same
name to run the GSA [@randomForest]. We run one GSA for each state variable 
(i.e., trophic compartment) in the model, including only the parameters that 
appear in the equilibrium equation of the state variable in question. For each 
GSA, we first use function `filter()` from package `dlypr` [@dplyr] to limit our
analyses to the results from modeling scenario (i). We then use function 
`select()` from the same package to choose the relevant parameters, and the run 
the GSA. Using function `importance()` from package `randomForest`, 
we extract each parameter's residual sum of squared errors (SSE) value and store
it in a new dataframe object, `noherbSoilN_imp`. Using this dataframe, we calculate a 
Relative Importance Index for each parameter as the ratio of its own residual 
SSE to the sum total of residual SSE across all parameters in the model. Finally, 
we combine each state variable's GSA results in a single dataframe, `noherbGSA`.

```{r scenario-1-compartment-wise-gsa, echo=TRUE, tidy=TRUE}
# Soil N
noherbSoilNgsa <- filter(randomI, herbivore == "absent") %>%
    select(., Soil_N, I, k)

noherbSoilN_rf <- noherbSoilNgsa %>% randomForest(Soil_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

noherbSoilN_imp <- as_tibble(importance(noherbSoilN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_noherbSoilN <- tibble(noherbSoilN_imp[, 3]/sum(noherbSoilN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(noherbSoilN_imp$Parameter),
           SV = "Soil_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Soil C
noherbSoilCgsa <- filter(randomI, herbivore == "absent") %>%
    select(., Soil_C, I:k, rp, ap)

noherbSoilC_rf <- noherbSoilCgsa %>% randomForest(Soil_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

noherbSoilC_imp <- as_tibble(importance(noherbSoilC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_noherbSoilC <- tibble(noherbSoilC_imp[, 3]/sum(noherbSoilC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(noherbSoilC_imp$Parameter),
           SV = "Soil_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant N
noherbPlantNgsa <- filter(randomI, herbivore == "absent") %>%
    select(., Plant_N, q, ap, α, δ)

noherbPlantN_rf <- noherbPlantNgsa %>% randomForest(Plant_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

noherbPlantN_imp <- as_tibble(importance(noherbPlantN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_noherbPlantN <- tibble(noherbPlantN_imp[, 3]/sum(noherbPlantN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(noherbPlantN_imp$Parameter),
           SV = "Plant_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant C
noherbPlantCgsa <- filter(randomI, herbivore == "absent") %>%
    select(., Plant_C, q, ap, α, δ)

noherbPlantC_rf <- noherbPlantCgsa %>% randomForest(Plant_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

noherbPlantC_imp <- as_tibble(importance(noherbPlantC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_noherbPlantC <- tibble(noherbPlantC_imp[, 3]/sum(noherbPlantC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(noherbPlantC_imp$Parameter),
           SV = "Plant_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

noherbGSA <- bind_rows(ranked_imp_noherbSoilN, ranked_imp_noherbSoilC, ranked_imp_noherbPlantN, ranked_imp_noherbPlantC)
```

As a comparison, the code chunk below runs a GSA using all parameters for all 
equations in the model. The chunk first allocates an empty dataframe, `noherbGSAres`,
in which we will store the results of the GSA. It then creates a vector of the
names of the model's state variables, `stateV`. Using the `stateV` vector, we 
then run a `for` loop to iterate the GSA over all six state variables in the 
model. At each step in the loop, we `filter` the `randomI` dataframe to only use
the results from scenario (i). Then, we select the state variable
of interest and the parameters to investigate. After renaming the first column
of the resulting dataframe to something more neutral and easy to handle, we then 
`select` the columns to use in the GSA and use function `do` to run the 
`randomForest` algorithm and store its results in a new object, `Cnoherb`.
Using function `importance` from package `randomForest`, we extract each 
parameter's residual sum of squared errors (SSE) value and store it in object 
`Cnoherb_imp`. Using this dataframe, we calculate a Relative Importance Index for each 
parameter using the same formula described above. Finally, we store the Relative 
Importance Index values just computed into the `noherbGSAres` dataframe previously 
allocated, so the loop can move to the next step. 

<aside>
Note that this code chunk is not evaluated by default. To see results from 
this GSA, recompile this notebook after setting `eval=TRUE` in the 
chunk options below.
</aside>
```{r scenario-1-full-gsa, eval=FALSE,echo=TRUE, tidy=TRUE}
# allocate an empty df to store the GSA results
noherbGSAres <- NULL

# create a vector of the names of the state variables in the model
stateV <- c("Soil_N", "Soil_C", "Plant_N", "Plant_C")

# run the gsa
for (i in 1:length(stateV)) {
  
  # filter out the herbivore model data and select only relevant parameters and 
  # state variable
  gsa <- filter(randomI, herbivore == "absent") %>%
    select(., stateV[i], I:k, α:q)
  
  # rename first column to a gneral purpose name
  colnames(gsa)[1] <- "Stock"
  
  # run the gsa
  sA_temp <- gsa %>%
    select(., Stock:q) %>%
    do(Cnoherb = randomForest(Stock ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
  # extract the importance of each parameter
  Cnoherb_imp <- as_tibble(importance(sA_temp[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
  # calculate the relative importance of each parameter
  ranked_imp_Cnoherb <- tibble(Cnoherb_imp[, 3]/sum(Cnoherb_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(Cnoherb_imp$Parameter),
           SV = as_factor(stateV[i])) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
  
  # store results into previously-allocated empty df
  noherbGSAres <- bind_rows(noherbGSAres, ranked_imp_Cnoherb)
  
  # remove temporary dfs
  rm(list = c("gsa", "sA_temp"))
  
  # cleanup memory
  gc()
  
  # keep track of the loop
  # print(i)
}
```

## Scenario (ii): an ecosystem with herbivores but no predators

Having complete the GSA for scenario (i), the code chunk below repeats the 
compartment-wise GSA described above for scenario (i) above. Results are stored 
in an object named `herbGSA`.

```{r scenario-2-compartment-wise-gsa, echo=TRUE, tidy=TRUE}
# Soil N
SoilNgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Soil_N, I, k)

herbSoilN_rf <- SoilNgsa %>% randomForest(Soil_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbSoilN_imp <- as_tibble(importance(herbSoilN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbSoilN <- tibble(herbSoilN_imp[, 3]/sum(herbSoilN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbSoilN_imp$Parameter),
           SV = "Soil_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Soil C
SoilCgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Soil_C, I:k, α:q, β:rh)

herbSoilC_rf <- SoilCgsa %>% randomForest(Soil_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbSoilC_imp <- as_tibble(importance(herbSoilC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbSoilC <- tibble(herbSoilC_imp[, 3]/sum(herbSoilC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbSoilC_imp$Parameter),
           SV = "Soil_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant N
PlantNgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Plant_N, rh, ah)

herbPlantN_rf <- PlantNgsa %>% randomForest(Plant_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbPlantN_imp <- as_tibble(importance(herbPlantN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbPlantN <- tibble(herbPlantN_imp[, 3]/sum(herbPlantN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbPlantN_imp$Parameter),
           SV = "Plant_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant C
PlantCgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Plant_C, α, rh, ah)

herbPlantC_rf <- PlantCgsa %>% randomForest(Plant_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbPlantC_imp <- as_tibble(importance(herbPlantC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbPlantC <- tibble(herbPlantC_imp[, 3]/sum(herbPlantC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbPlantC_imp$Parameter),
           SV = "Plant_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Herbivore N
HerbNgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Herbivore_N, α:q, β:rh)

herbHerbN_rf <- HerbNgsa %>% randomForest(Herbivore_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbHerbN_imp <- as_tibble(importance(herbHerbN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbHerbN <- tibble(herbHerbN_imp[, 3]/sum(herbHerbN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbHerbN_imp$Parameter),
           SV = "Herbivore_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Herbivore C
HerbCgsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., Herbivore_C, α:q, β:rh)

herbHerbC_rf <- HerbCgsa %>% randomForest(Herbivore_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

herbHerbC_imp <- as_tibble(importance(herbHerbC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_herbHerbC <- tibble(herbHerbC_imp[, 3]/sum(herbHerbC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(herbHerbC_imp$Parameter),
           SV = "Herbivore_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

herbGSA <- bind_rows(ranked_imp_herbSoilN, ranked_imp_herbSoilC, ranked_imp_herbPlantN, ranked_imp_herbPlantC, ranked_imp_herbHerbN, ranked_imp_herbHerbC)
```

As before, the following code chunk runs a GSA using all parameters in the model
for all state variables' equilibrium equations, repeating all the steps 
described above for modeling scenario (ii). Results are stored in an object 
called `herbGSAres`. 

<aside>
As before, this code chunk is not evaluated by default. Recompile the notebook 
after setting `eval=TRUE` to see the results of this full-model GSA>
</aside>
```{r scenario-2-full-gsa, eval=FALSE,echo=TRUE, tidy=TRUE}
# allocate an empty df to store the GSA results
herbGSAres <- NULL

# create a vector of the names of the state variables in the model
stateV <- c("Soil_N", "Soil_C", "Plant_N", "Plant_C", "Herbivore_N", "Herbivore_C")

# run the gsa
for (i in 1:length(stateV)) {
  
  # filter out the herbivore model data and select only relevant parameters and 
  # state variable
  gsa <- filter(randomI, herbivore == "herbivore") %>%
    select(., stateV[i], I:k, α:q, β:rh)
  
  # rename first column to a gneral purpose name
  colnames(gsa)[1] <- "Stock"
  
  # run the gsa
  sA_temp <- gsa %>%
    select(., Stock:q) %>%
    do(Cherb = randomForest(Stock ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
  # extract the importance of each parameter
  Cherb_imp <- as_tibble(importance(sA_temp[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
  # calculate the relative importance of each parameter
  ranked_imp_Cherb <- tibble(Cherb_imp[, 3]/sum(Cherb_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(Cherb_imp$Parameter),
           SV = as_factor(stateV[i])) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
  
  # store results into previously-allocated empty df
  herbGSAres <- bind_rows(herbGSAres, ranked_imp_Cherb)
  
  # remove temporary dfs
  rm(list = c("gsa", "sA_temp"))
  
  # cleanup memory
  gc()
  
  # keep track of the loop
  # print(i)
  
  # browser()
}
```

## Scenario (iii): an ecosystem with herbivores and predators

Finally, here we repeat the compartment-wise GSA for modeling scenario (iii). The
code chunk below repeats the steps described above ([Scenario (i): an ecosystem without animals]).
Results are stored in an abject called `predGSA`.

```{r scenario-3-compartment-wise-gsa, echo=TRUE, tidy=TRUE}
# Soil N
predSoilNgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Soil_N, I, k)

predSoilN_rf <- predSoilNgsa %>% randomForest(Soil_N ~., 
                                          data = .,
                                          proximity = TRUE,
                                          importance = TRUE)

predSoilN_imp <- as_tibble(importance(predSoilN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predSoilN <- tibble(predSoilN_imp[, 3]/sum(predSoilN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predSoilN_imp$Parameter),
           SV = "Soil_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Soil C
predSoilCgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Soil_C, I, k, ap, ah, ar, rp, rr)

predSoilC_rf <- predSoilCgsa %>% randomForest(Soil_C ~., 
                                          data = .,
                                          proximity = TRUE,
                                          importance = TRUE)

predSoilC_imp <- as_tibble(importance(predSoilC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predSoilC <- tibble(predSoilC_imp[, 3]/sum(predSoilC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predSoilC_imp$Parameter),
           SV = "Soil_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant N
predPlantNgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Plant_N, ap, ah, ar, rp, rh, rr, α, β, δ, π, τ, q)

predPlantN_rf <- predPlantNgsa %>% randomForest(Plant_N ~., 
                                            data = .,
                                            proximity = TRUE,
                                            importance = TRUE)

predPlantN_imp <- as_tibble(importance(predPlantN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predPlantN <- tibble(predPlantN_imp[, 3]/sum(predPlantN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predPlantN_imp$Parameter),
           SV = "Plant_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Plant C
predPlantCgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Plant_C, ap, ah, ar, rp, rh, rr, α, β, δ, π, τ, q)

predPlantC_rf <- predPlantCgsa %>% randomForest(Plant_C ~., 
                                                data = .,
                                                proximity = TRUE,
                                                importance = TRUE)

predPlantC_imp <- as_tibble(importance(predPlantC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predPlantC <- tibble(predPlantC_imp[, 3]/sum(predPlantC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predPlantC_imp$Parameter),
           SV = "Plant_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Herbivore N
predHerbNgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Herbivore_N, rr, ar)

predHerbN_rf <- predHerbNgsa %>% randomForest(Herbivore_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

predHerbN_imp <- as_tibble(importance(predHerbN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predHerbN <- tibble(predHerbN_imp[, 3]/sum(predHerbN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predHerbN_imp$Parameter),
           SV = "Herbivore_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Herbivore C
predHerbCgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Herbivore_C, α, rr, ar)

predHerbC_rf <- predHerbCgsa %>% randomForest(Herbivore_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

predHerbC_imp <- as_tibble(importance(predHerbC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predHerbC <- tibble(predHerbC_imp[, 3]/sum(predHerbC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predHerbC_imp$Parameter),
           SV = "Herbivore_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Predator N
predPredNgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Predator_N, ap, ah, ar, rp, rh, rr, q, α, β, δ, π, τ)

predPredN_rf <- predPredNgsa %>% randomForest(Predator_N ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

predPredN_imp <- as_tibble(importance(predPredN_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predPredN <- tibble(predPredN_imp[, 3]/sum(predPredN_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predPredN_imp$Parameter),
           SV = "Predator_N") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# Predator C
predPredCgsa <- filter(randomI, herbivore == "predator") %>%
    select(., Predator_C, ap, ah, ar, rp, rh, rr, q, α, β, δ, π, τ)

predPredC_rf <- predPredCgsa %>% randomForest(Predator_C ~., 
                                data = .,
                                proximity = TRUE,
                                importance = TRUE)

predPredC_imp <- as_tibble(importance(predPredC_rf), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 

ranked_imp_predPredC <- tibble(predPredC_imp[, 3]/sum(predPredC_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(predPredC_imp$Parameter),
           SV = "Predator_C") %>%
    dplyr::rename(., RelImpI = IncNodePurity)

predGSA <- bind_rows(ranked_imp_predSoilN, ranked_imp_predSoilC, ranked_imp_predPlantN, ranked_imp_predPlantC, ranked_imp_predHerbN, ranked_imp_predHerbC, ranked_imp_predPredN, ranked_imp_predPredC)
```

As for the other two modeling scenarios above, the next code chunk runs a 
full-model GSA for scenario (iii). It uses all parameters in the model for all
state variable equations. 

<aside>
Again, this code chunk is not evaluated by default. Change option `eval` to 
`TRUE` before recompiling this notebook to see its results.
</aside>
```{r scenario-3-full-gsa, eval=FALSE,echo=TRUE, tidy=TRUE}
# allocate an empty df to store the GSA results
predGSAres <- NULL

# create a vector of the names of the state variables in the model
stateV <- c("Soil_N", "Soil_C", "Plant_N", "Plant_C", "Herbivore_N", "Herbivore_C", "Predator_N", "Predator_C")

# run the gsa
for (i in 1:length(stateV)) {
  
  # filter out the herbivore model data and select only relevant parameters and 
  # state variable
  gsa <- filter(randomI, herbivore == "predator") %>%
    select(., stateV[i], I:k, α:q, β:rh, τ:rr)
  
  # rename first column to a gneral purpose name
  colnames(gsa)[1] <- "Stock"
  
  # run the gsa
  sA_temp <- gsa %>%
    select(., Stock:q) %>%
    do(Cherb = randomForest(Stock ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
  # extract the importance of each parameter
  Cpred_imp <- as_tibble(importance(sA_temp[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
  # calculate the relative importance of each parameter
  ranked_imp_Cpred <- tibble(Cpred_imp[, 3]/sum(Cpred_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(Cpred_imp$Parameter),
           SV = as_factor(stateV[i])) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
  
  # store results into previously-allocated empty df
  predGSAres <- bind_rows(predGSAres, ranked_imp_Cpred)
  
  # remove temporary dfs
  rm(list = c("gsa", "sA_temp"))
  
  # cleanup memory
  gc()
  
  # keep track of the loop
  # print(i)
  
  # browser()
}
```

# Ecosystem function analyses

Here we explore how primary producers' biomass, primary productivity, and net 
ecosystem carbon balance change across the three modeling scenarios. Details on 
the derivation of the formulae for these ecosystem functions are available in 
the Mathematica notebook companion to this R notebook.

## Primary producer biomass accumulation

We are interested in how primary producers biomass changes when animals are 
present in the ecosystem---i.e., in scenarios (ii) and (iii). Below, we use 
partial derivatives with respect to uptake (_a~i~_) and recycling (_r~i~_) rates
of herbivores and predators to explore how this quantity varies in scenario (ii)
and (iii).

### Primary producer biomass change in scenario (ii)

At equilibrium, the primary producers (i.e., plants) biomass for N in this 
scenario is 

<aside>
Recall that  $P^*_C  = \alpha \cdot P^*_N$
</aside>

$$
P^*_N = \frac{r_H}{a_H}
$$

We are interested in how this quantity, and its counterpart for C, are 
influenced by the herbivores' uptake rate, _a~H~_. To investigate this, we can 
take the partial derivative of equilibrium Plant biomass with respect to the 
herbivores' uptake rate,

$$
  \frac{\partial P^*_N}{\partial a_H} = − \frac{r_H}{a^2_H}
$$

The code chunk below uses the parameter sets that produce feasible equilibria 
to calculate this quantity and thus simulate the influence of herbivory on plant
biomass accumulation. Note that, as we are working with modeling scenario (ii), 
the first step in the pipe uses function `filter()` to isolate the rows in 
dataframe `randomI` that correspond to that scenario.

```{r scenario-2-plant-biomass-part-deriv-ah, echo = TRUE, tidy = TRUE}
EcoFunctPD <- randomI %>%
  # filter to only include parameter set & results from the model _with_ herbivores
  filter(., herbivore == "herbivore") %>% 
  # calculate the partial derivative of equilibrium Plant N and C biomass w.r.t. ah and rh
  mutate(., Plant_N_ah = -(rh/ah^2),
         Plant_C_ah = α*-(rh/ah^2))
```

We are also interested in how plant biomass varies with herbivore recycling 
rate, _r~H~_. The partial derivative formula on the N-side of the model is,

$$
  \frac{\partial P^*_N}{\partial r_H} = \frac{1}{a_H}
$$

And we can derive the formula for the partial derivative on the C-side of the 
model by simply multiplying it by _α_. The code chunk below uses the 
`EcoFunctPD` dataframe create in the earlier code chunk to calculate partial 
derivative of _P^*^_ with respect to _r~H~_. 

```{r scenario-2-plant-biomass-part-deriv-rh, echo = TRUE, tidy = TRUE}
EcoFunctPD <- mutate(EcoFunctPD, 
                     Plant_N_rh = 1/ah,
                     Plant_C_rh = α*(1/ah))
```

The table below provides a few summary statistics for the partial derivatives of 
equilibrium plant biomass with respect to _a~H~_ and _r~H~_ on both the N and C 
sides of the model. Note that, in this table, we **do not** remove the top and 
bottom 5% of the results, as done elsewhere in this notebook.

```{r scenario-2-plant-biomass-part-deriv-summary, echo=TRUE, tidy=TRUE}
EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, Plant_N_ah:Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors, and change herbivore = "herbivore" to be capitalized
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Herbivore = "herbivore"),
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:Biomass) %>%
  # create a multi-level summary table using gt_summary::tbl_summary()
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           type = list(Biomass ~ 'continuous2'),
                           statistic = Biomass ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = Biomass,
                           digits = Biomass ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>H</sub></i>',
                 stat_2 = '<i>r<sub>H</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = Biomass ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**")
```

### Primary producer biomass change in scenario (iii)

For modeling scenario (iii), an ecosystem with herbivores and predators, the 
plant biomass at equilibrium is:

<aside>
Recall that  $P^*_C = \alpha \cdot P^*_N$
$H^*_C = \beta \cdot H^*_N$
$R^*_C = \beta \cdot R^*_N$
</aside>

$$
P^*_N = -\frac{((a_R q_S r_P + a_H q_S r_R + a_P r_H r_R \beta (\pi - \tau))}{(a_P (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))))}
$$

How does this quantity change with change in parameters _a~H~_ and _r~H~_? As 
before, we use the partial derivative of _P^*_ with respect to either herbivore 
parameter to answer this question. The partial derivative of _P^*_ with respect 
to _a~H~_ is

$$
\frac{\partial P^*_N}{\partial a_H} = \frac{r_R (a_R q_S r_P (\alpha - \alpha \delta + \beta (-1 + \tau)) + a_P r_H r_R \beta^2 (\pi - \tau) (-1 + \tau))}{a_P (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))^2}
$$

Following our earlier code (see above), the code chunk below uses the parameter 
sets that produce feasible equilibria to calculate this quantity and thus 
simulate the influence of herbivory on plant biomass accumulation. Note that, as
we are working with scenario (iii), the first step in the pipe uses `filter()` 
to isolate the rows in dataframe `randomI` that correspond to this scenario.

```{r scenario-3-plant-biomass-part-deriv-ah, echo = TRUE, tidy = TRUE}
EcoFunctPD_pred <- randomI %>%
  # filter to only include parameter set & results from the model _with_ herbivores
  filter(., herbivore == "predator") %>% 
  # calculate the partial derivative of equilibrium Plant N and C biomass w.r.t. ah and rh
  mutate(., Plant_N_ah = (rr*(ar*q*rp*(α-α*δ+β*(-1+τ))+ap*rh*rr*(β^2)*(π-τ)*(-1+τ)))/(ap*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
         Plant_C_ah = α*(rr*(ar*q*rp*(α-α*δ+β*(-1+τ))+ap*rh*rr*(β^2)*(π-τ)*(-1+τ)))/(ap*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)))
```

As for _r~H~_, the partial derivative of _P^*^~N~_ with respect to it is

$$
\frac{\partial P^*_N}{\partial r_H} = \frac{r_R \beta (-\pi + \tau)}{a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau)}
$$

We use this quantity to calculate how plant biomass changes with herbivore 
recycling rate in the next code chunk.

```{r scenario-3-plant-biomass-part-deriv-rh, echo = TRUE, tidy = TRUE}
EcoFunctPD_pred <- mutate(EcoFunctPD_pred, 
                     Plant_N_rh = (rr*β*(-π+τ))/(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)),
                     Plant_C_rh = α*((rr*β*(-π+τ))/(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))))
```

The table below provides a few summary statistics for the partial derivatives of 
equilibrium plant biomass with respect to _a~H~_ and _r~H~_ on both the N and C 
sides of the model with herbivores and predators. Note that, in this table, 
we **do not** remove the top and bottom 5% of the results, as done elsewhere in 
this notebook.

```{r scenario-3-plant-biomass-part-deriv-herb-params-summary, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, Plant_N_ah:Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors, and change herbivore = "predator" to be capitalized
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Predator = "predator"),
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:Biomass) %>%
  # create a multi-level summary table using gt_summary::tbl_summary()
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           type = list(Biomass ~ 'continuous2'),
                           statistic = Biomass ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = Biomass,
                           digits = Biomass ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>H</sub></i>',
                 stat_2 = '<i>r<sub>H</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = Biomass ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**")
```

We are also interested in how primary producers biomass varies with changes in
the predators' uptake (_a~R~_) and recycling (_r~R~_) rates. The partial 
derivative of primary producers biomass with respect to _a~R~_ is,

$$
\frac{\partial P^{*}_{N}}{\partial a_{R}} = (r_{P} r_{R} (a_{P} r_{H} \alpha \beta (-1 + \delta) (\pi - \tau) + a_{H} q_{S} (\beta + \alpha (-1 + \delta) - \beta \tau)))/(a_{P} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))^2)
$$

and with respect to _a~R~_,

$$
\frac{\partial P^{*}_{N}}{\partial r_{R}} = (a_{R} r_{P} (a_{H} q_{S} (\alpha - \alpha \delta + \beta (-1 + \tau)) - a_{P} r_{H} \alpha \beta (-1 + \delta) (\pi - \tau)))/(a_{P} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))^2)
$$

The following code chunk calculates the values of the partial derivative of 
primary producers biomass with respect to _a~R~_ and _r~R~_. 

```{r scenario-3-plant-biomass-part-deriv-ar-rr, echo = TRUE, tidy = TRUE}
EcoFunctPD_pred <- mutate(EcoFunctPD_pred, 
                     Plant_N_ar = (rp*rr*(ap*rh*α*β*(-1+δ)*(π-τ)+ah*q*(β+α*(-1+δ)-β*τ)))/(ap*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2),
                     Plant_C_ar = α*((rp*rr*(ap*rh*α*β*(-1+δ)*(π-τ)+ah*q*(β+α*(-1+δ)-β*τ)))/(ap*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
                     Plant_N_rr = (ar*rp*(ah*q*(α-α*δ+β*(-1+τ))-ap*rh*α*β*(-1+δ)*(π-τ)))/(ap*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2),
                     Plant_C_rr = α*(ar*rp*(ah*q*(α-α*δ+β*(-1+τ))-ap*rh*α*β*(-1+δ)*(π-τ)))/(ap*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2))
```

And the following code chunk produces a summary table from these partial derivatives.

```{r scenario-3-plant-biomass-part-deriv-pred-params-summary, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, Plant_N_ar:Plant_C_rr) %>%
  pivot_longer(., cols = c(Plant_N_ar:Plant_C_rr), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors, and change herbivore = "predator" to be capitalized
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Predator = "predator"),
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:Biomass) %>%
  # create a multi-level summary table using gt_summary::tbl_summary()
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           type = list(Biomass ~ 'continuous2'),
                           statistic = Biomass ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = Biomass,
                           digits = Biomass ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>R</sub></i>',
                 stat_2 = '<i>r<sub>R</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = Biomass ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**")
```


## Primary Productivity

We use the $\Phi_P$ term as a proxy for primary productivity in either modeling
scenario, _with_ or _without_ herbivores. Below, we calculate primary productivity
for both scenarios. Then investigate its partial derivative ($\partial$) with 
respect to parameters _a~H~_ and _r~H~_ for the model _with_ herbivores. Note 
that the formulae for $\partial PP$ vary based on whether we am calculating it 
on the C- or on the N-side of the model.

Substituting the equilibrium values of the state variables $S^*_i$, $P^*_i$, 
$H^*_i$, where $i \in [N, C]$, in the formula for $\Phi_P$ gives us the 
equilibrium value of primary productivity in modeling scenario (i), an ecosystem
without animals,

$$
  \Phi^*_P = \frac{q_{S} r_{P}}{a_{P} \alpha - a_{P} \alpha \delta}
$$

whereas, for scenario (ii), an ecosystem with only herbivores, the formula for 
primary productivity is

$$
\Phi^*_P = \frac{a_{P} r_{h}^{2} r_{P} (\alpha + (-1 + \pi) \beta - \alpha \delta)}{a_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)}
$$

And, finally, for modeling scenario (iii), an ecosystem with herbivores and 
predators, primary productivity at equilibrium is

$$
  \Phi^*_P = -\frac{(a_{R} r_{P} + a_{H} r_{R}) (a_{R} q_{S} r_{P} + a_{H} q_{S} r_{R} + a_{P} r_{H} r_{R} \beta (\pi - \tau))}{a_{P} a_{R} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))}
$$

We use these three formulae to calculate primary productivity at equilibrium (`PP`
in the code chunk) for all three modeling scenarios in the next code chunk using 
an `ifelse()` statement.

```{r intro-prim-prod-eq, echo=TRUE, tidy=TRUE}
PrimProd <- randomI %>% 
  mutate(.,
         PP = ifelse(herbivore == "absent",
                     (q*rp)/(ap*α-ap*α*δ),
                     ifelse(herbivore == "herbivore",
                            (ap*(rh^2)*rp*(α+(-1+π)*β-α*δ))/(ah*(ah*q+ap*(-1+π)*rh*δ)),
                            -(((ar*rp+ah*rr)*(ar*q*rp+ah*q*rr+ap*rh*rr*β*(π-τ)))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))))),
         PPc = ifelse(herbivore == "absent",
                      (q*rp)/(ap-ap*δ),
                      ifelse(herbivore == "herbivore",
                             (ap*rh^2*rp*α*(α+(-1+π)*β-α*δ))/(ah*(ah*q+ap*(-1+π)*rh*δ)),
                      -(((ar*rp+ah*rr)*α*(ar*q*rp+ah*q*rr+ap*rh*rr*β*(π-τ)))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))))),
         herbivore = as_factor(herbivore))

paged_table(PrimProd)
```

### Primary productivity change in scenario (ii)

Focusing now on modeling scenario (ii), we take the partial 
derivative ($\partial$) of $\Phi^*_P$ with respect to _a~H~_. For N we get,

$$
\frac{\partial\Phi^*_{P_N}}{\partial a_{H}} = \frac{a_{P} r_{H}^{2} r_{P} (2 a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta) (\beta - \pi \beta + \alpha (-1 + \delta))}{a_{H}^{2} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^{2}}
$$

Whereas for C, we get

$$
\frac{\partial\Phi^*_{P_C}}{\partial a_{H}} = \frac{a_{P} r_{H}^{2} r_{P} \alpha (2 a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta) (\beta - \pi \beta + \alpha (-1 + \delta))}{a_{H}^{2} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^{2}}
$$

Using these formulae, we can calculate the **change** in primary productivity at
equilibrium for both N and C (`PP_N_ah` and `PP_C_ah` in the 
code chunk) using the parameter sets that produced feasible equilibria.

```{r scenario-2-prim-prod-part-deriv-ah, echo=TRUE, tidy = TRUE}
EcoFunctPD <- mutate(EcoFunctPD,
                     PP = (ap*rh^2*rp*(α+(-1+π)*β-α*δ))/(ah*(ah*q+ap*(-1+π)*rh*δ)),
                     PPc = α*PP,
                     PP_N_ah = (ap*rh^2*rp*(2*ah*q+ap*(-1+π)*rh*β)*(β-π*β+α*(-1+δ)))/(ah^2*(ah*q+ap*(-1+π)*rh*β)^2),
                     PP_C_ah = (ap*rh^2*rp*α*(2*ah*q+ap*(-1+π)*rh*β)*(β-π*β+α*(-1+δ)))/(ah^2*(ah*q+ap*(-1+π)*rh*β)^2))
```

Similarly, we can derive the partial derivatives for $\Phi^*_P$ with respect to 
_r~H~_. For N, we have, 

$$
\frac{\partial \Phi^*_{P_N}}{\partial r_H} = \frac{a_{P} r_{H} r_{P} (2 a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta) (\alpha + (-1 + \pi) \beta - \alpha \delta)}{a_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^2}
$$

Whereas for C we have,

$$
\frac{\partial \Phi^*_{P_C}}{\partial r_H}  = \frac{a_{P} r_{H} r_{P} \alpha (2 a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta) (\alpha + (-1 + \pi) \beta - \alpha \delta)}{a_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^2}
$$

Plugging the values of the parameters in these equations, we can get a quantitative
estimate of the change in primary productivity as the values of _a~H~_ and 
_r~H~_ increase.

```{r scenario-2-prim-prod-part-deriv-rh, echo=TRUE, tidy=TRUE}
EcoFunctPD <- mutate(EcoFunctPD,
                     PP_N_rh = (ap*rh*rp*(2*ah*q+ap*(-1+π)*rh*β)*(α+(-1+π)*β- α*δ))/(ah*(ah*q+ap*(-1+π)*rh*β)^2),
                     PP_C_rh = (ap*rh*rp*α*(2*ah*q+ap*(-1+π)*rh*β)*(α+(-1+π)*β-α*δ))/(ah*(ah*q+ap*(-1+π)*rh*β)^2))
```

Below, we tabulate a few summary statistics for these partial derivatives. Again,
this table contains the **full range** of results.

```{r scenario-2-prim-prod-part-deriv-summary, echo=TRUE, tidy=FALSE}
EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, PP_N_ah:PP_C_rh) %>%
  pivot_longer(., cols = c(PP_N_ah:PP_C_rh), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Compartment" and "herbivore" are factors
  mutate(., 
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:dPP) %>%
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           label = list(dPP ~ "Primary Productivity"),
                           type = list(dPP ~ 'continuous2'),
                           statistic = dPP ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = dPP,
                           digits = dPP ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>H</sub></i>',
                 stat_2 = '<i>r<sub>H</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = dPP ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**"
    
  )
```

### Primary productivity change in scenario (iii)

Switching to scenario (iii), an ecosystem with herbivores and predators, we 
first check the influence of herbivores' uptake and recycling rates on primary 
productivity.

<aside>
Recall that  $P^*_C = \alpha \cdot P^*_N$
$H^*_C = \beta \cdot H^*_N$
$R^*_C = \beta \cdot R^*_N$
</aside>

The partial derivative of primary productivity with respect to the herbivore
uptake rate (_a~H~_) in this modeling scenario is,

$$
\frac{\partial \Phi^*_P}{\partial a_H} = \frac{r_{R} (a_{R} r_{P} r_{R} (-2 a_{H} q_{S} \alpha (-1 + \delta) + a_{P} r_{H} \beta (\alpha - \alpha \delta + \beta (-1 + \tau)) (\pi - \tau)) + (a_{R})^2 q_{S} (r_{P})^2 (-2 \alpha (-1 + \delta) + \beta (-1 + \tau)) - (a_{H})^2 q_{S} (r_{R})^2 \beta (-1 + \tau))}{a_{P} a_{R} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))^2}
$$

And the partial derivative with respect to the herbivore recycling rate (_r~H~_) is,

$$
\frac{\partial \Phi^*_P}{\partial r_{H}} = \frac{r_{R} (a_{R} r_{P} + a_{H} r_{R}) \beta (-\pi + \tau)}{a_{R} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))}
$$

With these formulae, we can assess the effects of herbivores' uptake and 
recycling rate on $\Phi^{*}_{P}$ for both N and C (`PP_N_ah` and `PP_C_ah` in the 
code chunk) using the parameter sets that produced feasible equilibria.

```{r scenario-3-prim-prod-part-deriv-ah-rh, echo=TRUE, tidy = TRUE}
EcoFunctPD_pred <- mutate(EcoFunctPD_pred,
                     PP = -(((ar*rp+ah*rr)*(ar*q*rp+ah*q*rr+ap*rh*rr*β*(π-τ)))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))),
                     PPc = -(((ar*rp+ah*rr)*α*(ar*q*rp+ah*q*rr+ap*rh*rr*β*(π-τ)))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ)))),
                     PP_N_ah = (rr*(ar*rp*rr*(-2*ah*q*α*(-1+δ)+ap*rh*β*(α-α*δ+β*(-1+τ))*(π-τ))+(ar^2)*q*(rp^2)*(-2*α*(-1+δ)+β*(-1+τ))-(ah^2)*q*(rr^2)*β*(-1+τ)))/(ap*ar*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
                     PP_C_ah = (rr*α*(ar*rp*rr*(-2*ah*q*α*(-1+δ)+ap*rh*β*(α-α*δ+β*(-1+τ))*(π-τ))+(ar^2)*q*(rp^2)*(-2*α*(-1+δ)+β*(-1+τ))-(ah^2)*q*(rr^2)*β*(-1+τ)))/(ap*ar*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
                     PP_N_rh = (rr*(ar*rp+ah*rr)*β*(-π+τ))/(ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))),
                     PP_C_rh = (rr*(ar*rp+ah*rr)*α*β*(-π+τ))/(ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))))
```

The table below provides summary statistics of these calculations.

```{r scenario-3-prim-prod-part-deriv-herb-params-summary, echo=TRUE, tidy=FALSE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, PP_N_ah:PP_C_rh) %>%
  pivot_longer(., cols = c(PP_N_ah:PP_C_rh), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Compartment" and "herbivore" are factors
  mutate(., 
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:dPP) %>%
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           label = list(dPP ~ "Primary Productivity"),
                           type = list(dPP ~ 'continuous2'),
                           statistic = dPP ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = dPP,
                           digits = dPP ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>H</sub></i>',
                 stat_2 = '<i>r<sub>H</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = dPP ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**"
    
  )
```

As we are also interested on the effect of the predator on primary productivity
in the ecosystem, here is the formula for the partial derivative of $\Phi^*_P$ 
with respect to _a~R~_, the uptake rate of the predator.

$$
\frac{\partial \Phi^*_{P}}{\partial a_{R}} = \frac{(r_{R} (a_{H}^2 r_{R} (2 a_r_{R} q_{S} r_{P} \alpha (-1 + \delta) + a_{P} r_{H} r_{R} \beta^2 (\pi - \tau) (-1 + \tau)) + a_{P} a_{R}^2 r_{H} r_{P}^2 \alpha \beta (-1 + \delta) (\pi - \tau) + a_{H}^3 q_{S} r_{R}^2 \beta (-1 + \tau) + a_{H} a_{R} r_{P} (2 a_{P} r_{H} r_{R} \alpha \beta (-1 + \delta) (\pi - \tau) + a_{R} q_{S} r_{P} (\beta + 2 \alpha (-1 + \delta) - \beta \tau))))}{(a_{P} a_{R}^2 (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))^2)}
$$

And the partial derivative of $\Phi^*_P$ with respect to _r~R~_, the predator's
recycling rate is,

$$
\frac{\partial \Phi^*_P}{\partial r_{R}} = \frac{(a_{H} a_{R} r_{P} (a_{R} q_{S} r_{P} (-2 \alpha (-1 + \delta) + \beta (-1 + \tau)) - 2 a_{P} r_{H} r_{R} \alpha \beta (-1 + \delta) (\pi - \tau)) - a_{P} a_{R}^2 r_{H} r_{P}^2 \alpha \beta (-1 + \delta) (\pi - \tau) - a_{H}^3 q_{S} r_{R}^2 \beta (-1 + \tau) + a_{H}^2 r_{R} (-2 a_{R} q_{S} r_{P} \alpha (-1 + \delta) + a_{P} r_{H} r_{R} \beta^2 (\pi - (1 + \pi) \tau + \tau^2)))}{(a_{P} a_{R} (a_{R} r_{P} \alpha (-1 + \delta) + a_{H} r_{R} \beta (-1 + \tau))^2)}
$$

The code chunk below uses these equations to calculate the value of $\Phi^*_P$ as
_a~R~_ and _r~R~_ change. Note that here, while we are using predators' 
parameters to calculate the partial derivative, we still use the relationship

$$
\Phi^*_{P_C} = \alpha \cdot \Phi^*_{P_N}
$$

as we are still working with **primary** productivity.

```{r scenario-3-prim-prod-part-deriv-ar-rr, echo=TRUE, tidy = TRUE}
EcoFunctPD_pred <- mutate(EcoFunctPD_pred,
                     PP_N_ar = rr*((ah^2)*rr*(2*ar*q*rp*α*(-1+δ)+ap*rh*rr*(β^2)*(π-τ)*(-1+τ))+ap*(ar^2)*rh*((rp^2)*α*β*(-1+δ)*(π-τ)+(ah^3)*q*(rr^2)*β*(-1+τ)+ah*ar*rp*(2*ap*rh*rr*α*β*(-1+δ)*(π-τ)+ar*q*rp*(β+2*α*(-1+δ)-β*τ))))/(ap*(ar^2)*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
                     PP_C_ar = (rr*α*((ah^2)*rr*(2*ar*q*rp*α*(-1+δ)+ap*rh*rr*(β^2)*(π-τ)*(-1+τ))+ap*(ar^2)*rh*(rp^2)*α*β*(-1+δ)*(π-τ)+(ah^3)*q*(rr^2)*β*(-1+τ)+ah*ar*rp*(2*ap*rh*rr*α*β*(-1+δ)*(π-τ)+ar*q*rp*(β+2*α*(-1+δ)-β*τ))))/(ap*(ar^2)*((ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
                     PP_N_rr = (ah*ar*rp*(ar*q*rp*(-2*α*(-1+δ)+β*(-1+τ))-2*ap*rh*rr*α*β*(-1+δ)*(π-τ))-ap*(ar^2)*rh*(rp^2)*α*β*(-1+δ)*(π-τ)-(ah^3)*q*(rr^2)*β*(-1+τ)+(ah^2)*rr*(-2*ar*q*rp*α*(-1+δ)+ap*rh*rr*(β^2)*(π-(1+π)*τ+(τ^2))))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2),
                     PP_C_rr = (α*(ah*ar*rp*(ar*q*rp*(-2*α*(-1+δ)+β*(-1+τ))-2*ap*rh*rr*α*β*(-1+δ)*(π-τ))-ap*(ar^2)*rh*(rp^2)*α*β*(-1+δ)*(π-τ)-(ah^3)*q*(rr^2)*β*(-1+τ)+(ah^2)*rr*(-2*ar*q*rp*α*(-1+δ)+ap*rh*rr*(β^2)*(π-(1+π)*τ+(τ^2)))))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2))
```

And the following chunk produces a table of summary statistics for these
partial derivatives related to the predators.

```{r scenario-3-prim-prod-part-deriv-pred-params-summary, echo=TRUE, tidy=FALSE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, PP_N_ar:PP_C_rr) %>%
  pivot_longer(., cols = c(PP_N_ar:PP_C_rr), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Compartment" and "herbivore" are factors
  mutate(., 
         Variable = as_factor(Variable),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::select(., Nutrient:dPP) %>%
  tbl_strata(.,
             strata = Nutrient,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Variable,
                           label = list(dPP ~ "Primary Productivity"),
                           type = list(dPP ~ 'continuous2'),
                           statistic = dPP ~ c("{N_obs}",
                                                    "{median}\n ({p25}, {p75})",
                                                    "{min}; {max}"),
                           include = dPP,
                           digits = dPP ~ 2) %>%
                modify_header(
                 label = '<b>Partial Derivative</b>',
                 stat_1 = '<i>a<sub>R</sub></i>',
                 stat_2 = '<i>r<sub>R</sub></i>',
                 text_interpret = "html"
                 ) %>%
               add_stat_label(label = dPP ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min; Max")) ,
             .header = "**{strata}**"
    
  )
```

### Sensitivity Analyses

Here we perform a global sensitivity analysis (GSA) to assess the relative 
importance of relevant parameters in the model in shaping the primary 
productivity results. As for the model's equilibria, we run a GSA for the 
primary productivity equations the three modeling scenarios and include only the
parameters that appear in each equation.

The next code chunk runs the GSA for scenario (i), an ecosystem without animals,
for both elements tracked by the model---i.e., Nitrogen and Carbon.

```{r scenario-1-gsa-prim-prod, echo=TRUE, tidy=TRUE}
# nitrogen
# as the EcoFunctPD dataframe does not include 
gsaPPnoherb <- PrimProd %>%
  filter(., herbivore == "absent") %>%
  select(., PP, α, δ, ap, rp, q)

# run the gsa
PPsA_noherb <- gsaPPnoherb %>%
    select(., PP:q) %>%
    do(PPgsa = randomForest(PP ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaNoHerb_imp <- as_tibble(importance(PPsA_noherb[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPnoherb <- tibble(PPgsaNoHerb_imp[, 3]/sum(PPgsaNoHerb_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaNoHerb_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# carbon
# as the EcoFunctPD dataframe does not include 
gsaPPnoherbc <- PrimProd %>%
  filter(., herbivore == "absent") %>%
  select(., PPc, δ, ap, rp, q)

# run the gsa
PPsA_noherbc <- gsaPPnoherbc %>%
    select(., PPc:q) %>%
    do(PPgsac = randomForest(PPc ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaNoHerb_impc <- as_tibble(importance(PPsA_noherbc[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPnoherbc <- tibble(PPgsaNoHerb_impc[, 3]/sum(PPgsaNoHerb_impc[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaNoHerb_impc$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

And this code chunk runs the GSA for modeling scenario (ii), an ecosystem with 
only herbivores.

```{r scenario-2-gsa-prim-prod, echo=TRUE, tidy=TRUE}
# nitrogen
# filter out the herbivore model data and select only relevant parameters and 
# state variable
gsaPPherb <- PrimProd %>%
  filter(., herbivore == "herbivore") %>%
  select(., PP, α:q, β:rh)

# run the gsa
PPsA_herb <- gsaPPherb %>%
    select(., PP:rh) %>%
    do(PPgsa = randomForest(PP ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaHerb_imp <- as_tibble(importance(PPsA_herb[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPherb <- tibble(PPgsaHerb_imp[, 3]/sum(PPgsaHerb_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaHerb_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# carbon
gsaPPherbc <- PrimProd %>%
  filter(., herbivore == "herbivore") %>%
  select(., PPc, α:q, β:rh)

# run the gsa
PPsA_herbc <- gsaPPherbc %>%
    select(., PPc:rh) %>%
    do(PPgsac = randomForest(PPc ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaHerb_impc <- as_tibble(importance(PPsA_herbc[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPherbc <- tibble(PPgsaHerb_impc[, 3]/sum(PPgsaHerb_impc[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaHerb_impc$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

And, finally, the next chunk runs the GSA for scenario (iii), an 
ecosystem with herbivores and predators.

```{r scenario-3-gsa-prim-prod, echo=TRUE, tidy=TRUE}
# nitrogen
# filter out the herbivore model data and select only relevant parameters and 
# state variable
gsaPPpred <- PrimProd %>%
  filter(., herbivore == "predator") %>%
  select(., PP, α:q, β:rh, τ:rr)

# run the gsa
PPsA_pred <- gsaPPpred %>%
    select(., PP:rr) %>%
    do(PPgsa = randomForest(PP ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaPred_imp <- as_tibble(importance(PPsA_pred[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPpred <- tibble(PPgsaPred_imp[, 3]/sum(PPgsaPred_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaPred_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)

# carbon
gsaPPpredc <- PrimProd %>%
  filter(., herbivore == "predator") %>%
  select(., PPc, α:q, β:rh, τ:rr)

# run the gsa
PPsA_predc <- gsaPPpredc %>%
    select(., PPc:rr) %>%
    do(PPgsac = randomForest(PPc ~.,
                            data = .,
                            proximity = TRUE,
                            importance = TRUE))
  
# extract the importance of each parameter
PPgsaPred_impc <- as_tibble(importance(PPsA_predc[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_PPpredc <- tibble(PPgsaPred_impc[, 3]/sum(PPgsaPred_impc[, 3])) %>% 
    mutate(., Parameter = as_factor(PPgsaPred_impc$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

## Net Ecosystem Carbon Balance

Here, we use the Net Ecosystem Carbon Balance (NECB) equations presented in 
the manuscript to investigate how the three modeling scenarios may differ in 
their estimates of this ecosystem function. We then use their partial derivatives 
at equilibrium to test for the influence of uptake (_a~i~_)
and recycling (_r~i~_) rates of herbivores and predators on NECB.

Note that, unlike the analyses we ran for [Primary Producers Biomass] and
[Primary Productivity], **here we focus exclusively on carbon**. The reason for 
this is that NECB is generally used as a way to assess the movement of C in the 
system and the system's exchanges of C with the atmosphere. 

### Comparing NECB between scenarios 

At equilibrium, NECB in modeling scenario (i) is,

$$
NECB^* = \frac{q_{S} r_{P}}{a_{P}}
$$

And in modeling scenario (ii),

$$
NECB^* = -\frac{r_{H} r_{P} (a_{P} r_{H} \alpha (\alpha + 2 \pi \beta) (-1 + \delta) + a_{H} q_{S} (\beta + \pi \beta + \alpha \delta))}{a_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)}
$$

Finally, for modeling scenario (iii), NECB is,

$$
NECB^* = \frac{a_R^2 q_S r_P^2 \alpha (-1 + \delta) + a_R r_P r_R (-a_P r_H \alpha \beta (-1 + \delta) + a_H q_S (\alpha (-2 + \delta) + \beta (-2 + \tau))) + a_H r_R^2 (a_P r_H \beta (\beta - \pi (\alpha + \beta) + \alpha \tau) - a_H q_S (\alpha + 2 \beta - \beta \tau))}{a_P a_R (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))}
$$

The code chunk below uses these formulae and dataframe `randomI` to calculate NECB 
for the three modeling scenarios, and then computes a few summary statistics. 

```{r intro-necb-eq, echo=TRUE, tidy=FALSE}
NECBres <- randomI %>%
  mutate(.,
         NECB = ifelse(herbivore == "herbivore",
                -((rh*rp*(ap*rh*(α^2)*(-1 + δ)+ah*q*(β-π*β+α*δ)))/(ah*(ah*q+ap*(-1+π)*rh*β))), 
                ifelse(herbivore == "predator", 
                       ((ar^2)*q*(rp^2)*α*(-1+δ)+ar*rp*rr*(-ap*rh*α*β*(-1+δ)+ah*q*(α*(-2+δ)+β*(-2+τ)))+ah*(rr^2)*(ap*rh*β*(β-π*(α+β)+α*τ)-ah*q*(α+2*β-β*τ)))/(ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))),
                (q*rp)/ap)), 
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Herbivore = "herbivore", Absent = "absent", "Predator" = "predator")) %>%
  dplyr::group_by(., herbivore) %>%
  dplyr::filter(., between(NECB,
                           quantile(NECB, 0.05, na.rm = T),
                           quantile(NECB, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup()

tbl_summary(NECBres, 
              by = herbivore, 
              label = list(NECB ~ "NECB"),
              type = list(NECB ~ 'continuous2'),
              statistic = NECB ~ c("{N_obs}",
                                  "{median}\n ({p25}, {p75})",
                                  "{mean} ({sd})",
                                  "{min}; {max}"),
              include = NECB,
              digits = NECB ~ 2) %>%
  modify_header(.,
                label = ' ',
                stat_1 = '**{level}**',
                stat_2 = '**{level}**',
                stat_3 = '**{level}**'
                ) %>%
  add_stat_label(.,
                 label = NECB ~ c("n",
                                  "Median (IQR)", 
                                  "Mean (SD)",
                                  "Min; Max"))
```

### Change in NECB with herbivory

Now, we are interested in assessing the influence of herbivory on NECB in 
modeling scenario (ii), when herbivores alone are present in the ecosystem, and 
in scenario (iii)---when the ecosystem contains both herbivores and predators. 
To do this, we use the partial derivative of equilibrium NECB with respect to the 
herbivores' uptake and recycling rates, as well as the predators' uptake and 
recycling rates.

#### NECB change in scenario (ii)

When taking the partial derivative of equilibrium NECB with respect to _a~H~_ 
in scenario (ii), we have,

$$
\frac{\partial NECB^*}{\partial a_{H}} = \frac{r_{P} r_{P} (2 a_{H} a_{{p}} q_{S} r_{H} \alpha^2 (-1 + \delta) + a^2_{P} (-1 + \pi) r^2_{H} \alpha^2 \beta (-1 + \delta) + a^2_{H} q^2_{S} (\beta - \pi \beta + \alpha \delta))}{a^2_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^2}
$$

Similarly, the equilibrium partial derivative of NECB with respect to _r~H~_ is,

$$
\frac{\partial NECB^*}{\partial r_{H}} = -\frac{r_{P} (2 a_{H} a_{P} q_{S} r_{H} \alpha^2 (-1 + \delta) + a^2_{P} (-1 + \pi) r^2_{H} \alpha^2 \beta (-1 + \delta) + a^2_{H} q^2_{S} (\beta - \pi \beta + \alpha \delta)}{a_{H} (a_{H} q_{S} + a_{P} (-1 + \pi) r_{H} \beta)^2}
$$

Now we can use these two expressions to calculate the equilibrium values for
NECB using the parameter sets that produce feasible equilibria.

```{r scenario-2-necb-partial-deriv, echo=TRUE, tidy=TRUE}
NECBPD <- EcoFunctPD %>% 
  mutate(.,
         NECB_ah = (rh*rp*(2*ah*ap*q*rh*(α^2)*(-1+δ)+(ap^2)*(-1+π)*(rh^2)*(α^2)*β*(-1+δ)+(ah^2)*(q^2)*(β-π*β+α*δ)))/((ah^2)*(ah*q+ap*(-1+π)*rh*β)^2),
         NECB_rh = -((rp*(2*ah*ap*q*rh*(α^2)*(-1+δ)+(ap^2)*(-1+π)*(rh^2)*(α^2)*β*(-1+β)+(ah^2)*(q^2)*(β-π*β+α*δ)))/(ah*(ah*q+ap*(-1+π)*rh*β)^2)))
```

Below, we compute a few summary statistics and table them for ease of reading. 

```{r scenario-2-herb-necb-partial-deriv-summary-table, echo=TRUE, tidy=TRUE}
NECBPD %>%
  dplyr::select(., herbivore, TIME, NECB_ah:NECB_rh) %>%
  pivot_longer(., cols = c(NECB_ah:NECB_rh), 
               names_to = "EcoFunct", 
               values_to = "NECB") %>%
  # separate the name of elements in "EcoFunct" in "EcoFunct" 
  # and "Variable"
  separate(., col = "EcoFunct", 
              into = c("EcoFunct", "Variable"), 
              sep = "_") %>%
  # make sure categorical variables are coded as factors
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Herbivore = "herbivore"),
         Variable = as_factor(Variable)) %>%
  # group by factor of interest
  dplyr::group_by(., Variable) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB,
                        quantile(NECB, 0.05, na.rm = T),
                        quantile(NECB, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  tbl_summary(by = Variable,
              type = list(NECB ~ 'continuous2'),
              statistic = NECB ~ c("{N_obs}",
                                  "{median}\n ({p25}, {p75})",
                                  "{min}--{max}"),
              include = NECB,
              digits = NECB ~ 2) %>%
  modify_header(.,
                label = '<b>Partial Derivative</b>',
                stat_1 = '<b>a<sub>H</sub></b>',
                stat_2 = '<b>r<sub>H</sub></b>',
                text_interpret = "html") %>%
  add_stat_label(.,
                 label = NECB ~ c("n",
                                 "Median\n (IQR)",
                                 "Min-Max"))
```

#### NECB change in scenario (iii)

In scenario (iii), the partial derivative of equilibrium NECB with respect to 
_a~H~_ is,

$$
\frac{\partial NECB^*}{\partial a_{H}} = \frac{r_R (a_R^2 q_S r_P^2 \alpha (-\beta + \alpha (-2 + \delta)) (-1 + \delta) + a_H^2 q_S r_R^2 \beta (-\alpha + \beta (-2 + \tau)) (-1 + \tau) - a_R r_P r_R \alpha (-1 + \delta) (a_P r_H \beta (\alpha + \beta) (\pi - \tau) + 2 a_H q_S (\alpha + 2 \beta - \beta \tau)))}{a_P a_R (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))^2}
$$

And with respect to _r~H~_ is,

$$
\frac{\partial NECB^*}{\partial r_{H}} = \frac{r_R \beta (-a_R r_P \alpha (-1 + \delta) + a_H r_R (\beta - \pi (\alpha + \beta) + \alpha \tau))}{a_R (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))}
$$

As for the predators' parameters, the partial derivative of NECB
with respect to the predators' uptake rate (_a~R~_) is,

$$
\frac{\partial NECB^*}{\partial a_{R}} = \frac{r_R (-a_H^3 q_S r_R^2 \beta (-\alpha + \beta (-2 + \tau)) (-1 + \tau) + a_P a_R^2 r_H r_P \alpha^2 \beta (-1 + \delta) (\pi (r_H - r_P) - r_H \tau + r_P (-1 + \delta + \tau)) + a_H^2 r_R (a_P r_H r_R \beta^2 (-1 + \tau) (-\beta + \pi (\alpha + \beta) - \alpha \tau) + 2 a_R q_S r_P \alpha (-1 + \delta) (\alpha + 2 \beta - \beta \tau)) + a_H a_R r_P \alpha (2 a_P r_H r_R \beta (-1 + \delta) (-\beta + \po (\alpha + \beta) - \alpha \tau) + a_R q_S (r_H (\beta + \alpha (-1 + \delta) - \beta \tau) + r_P (-\alpha (-1 + \delta)^2 + \beta (-2 + \delta + \tau)))))}{a_P a_R^2 (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))^2}
$$

And, with respect to the predators' recycling rate (_r~R~_),

$$
\frac{\partial NECB^*}{\partial r_{R}} = \frac{-a_P a_R^2 r_H r_P^2 \alpha^2 \beta (-1 + \delta)^2 + a_H^3 q_S r_R^2 \beta (-\alpha + \beta (-2 + \tau)) (-1 + \tau) + a_H a_R r_P \alpha (-1 + \delta) (a_R q_S r_P (-\beta + \alpha (-2 + \delta)) + 2 a_P r_H r_R \beta (\beta - \pi (\alpha + \beta) + \alpha \tau)) + a_H^2 r_R (a_P r_H r_R \beta^2 (-1 + \tau) (\beta - \pi (\alpha + \beta) + \alpha \tau) - 2 a_R q_S r_P \alpha (-1 + \delta) (\alpha + 2 \beta - \beta \tau))}{a_P a_R (a_R r_P \alpha (-1 + \delta) + a_H r_R \beta (-1 + \tau))^2}
$$

Now we can use these four expressions to calculate the equilibrium values for
NECB using the parameter sets that produce feasible equilibria.

```{r scenario-3-necb-partial-deriv, echo=TRUE, tidy=TRUE}
NECBPD_pred <- EcoFunctPD_pred %>% 
  mutate(.,
         NECB_ah = (rr*((ar^2)*q*(rp^2)*α*(-β+α*(-2+δ))*(-1+δ)+(ah^2)*q*(rr^2)*β*(-α+β*(-2+τ))*(-1+τ)-ar*rp*rr*α*(-1+δ)*(ap*rh*β*(α+β)*(π-τ)+2*ah*q*(α+2*β-β*τ))))/((ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
         NECB_rh = (rr*β*(-ar*rp*α*(-1+δ)+ah*rr*(β-π*(α+β)+α*τ)))/(ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))),
         NECB_ar = (rr*(-(ah^3)*q*(rr^2)*β*(-α+β*(-2+τ))*(-1+τ)+ap*(ar^2)*rh*rp*(α^2)*β*(-1+δ)*(π*(rh-rp)-rh*τ+rp*(-1+δ+τ))+(ah^2)*rr*(ap*rh*rr*(β^2)*(-1+τ)*(-β+π*(α+β)-α*τ)+2*ar*q*rp*α*(-1+δ)*(α+2*β-β*τ))+ah*ar*rp*α*(2*ap*rh*rr*β*(-1+δ)*(-β+π*(α+β)-α*τ)+ar*q*(rh*(β+α*(-1+δ)-β*τ)+rp*(-α*((-1+δ)^2)+β*(-2+δ+τ))))))/((ap*(ar^2)*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)),
         NECB_rr = (-ap*(ar^2)*rh*(rp^2)*(α^2)*β*((-1+δ)^2)+(ah^3)*q*(rr^2)*β*(-α+β*(-2+τ))*(-1+τ)+ah*ar*rp*α*(-1+δ)*(ar*q*rp*(-β+α*(-2+δ))+2*ap*rh*rr*β*(β-π*(α+β)+α*τ))+(ah^2)*rr*(ap*rh*rr*(β^2)*(-1+τ)*(β-π*(α+β)+α*τ)-2*ar*q*rp*α*(-1+δ)*(α+2*β-β*τ)))/((ap*ar*(ar*rp*α*(-1+δ)+ah*rr*β*(-1+τ))^2)))
```

And, again, the table below shows a few summary statistics. 

```{r scenario-3-necb-partial-deriv-summary-table, echo=TRUE, tidy=TRUE}
NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, NECB_ah:NECB_rr) %>%
  pivot_longer(., cols = c(NECB_ah:NECB_rr), 
               names_to = "EcoFunct", 
               values_to = "NECB") %>%
  # separate the name of elements in "EcoFunct" in "EcoFunct" 
  # and "Variable"
  separate(., col = "EcoFunct", 
              into = c("EcoFunct", "Variable"), 
              sep = "_") %>%
  # make sure categorical variables are coded as factors
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, Predator = "predator"),
         Variable = as_factor(Variable)) %>%
  tbl_summary(by = Variable,
              type = list(NECB ~ 'continuous2'),
              statistic = NECB ~ c("{N_obs}",
                                  "{median}\n ({p25}, {p75})",
                                  "{min}--{max}"),
              include = NECB,
              digits = NECB ~ 2) %>%
  modify_header(.,
                label = '<b>Partial Derivative</b>',
                stat_1 = '<b>a<sub>H</sub></b>',
                stat_2 = '<b>r<sub>H</sub></b>',
                stat_3 = '<b>a<sub>R</sub></b>',
                stat_4 = '<b>r<sub>R</sub></b>',
                text_interpret = "html") %>%
  add_stat_label(.,
                 label = NECB ~ c("n",
                                 "Median\n (IQR)",
                                 "Min-Max"))
```

### Sensitivity Analyses

Here we perform a GSA to assess the relative importance of each parameter in 
driving the NECB estimates for all modeling scenarios. As with other 
GSAs in this notebook, we focus only on the parameters that appear in the NECB 
equations presented above. 

First, we run the GSA for modeling scenario (i), an ecosystem without animals.

```{r scenario-1-gsa-necb, echo=TRUE, tidy=TRUE}
# filter out the model data and select only relevant parameters and 
# state variable
gsaNECB_noherb <- filter(NECBres, herbivore == "Absent") %>%
    select(., NECB, ap, rp, q)

# run the gsa
NECBsA_noherb <- gsaNECB_noherb %>%
    select(., NECB:q) %>%
    do(NECBgsa = randomForest(NECB ~.,
                              data = .,
                              proximity = TRUE,
                              importance = TRUE))
  
# extract the importance of each parameter
NECBgsa_noherb_imp <- as_tibble(importance(NECBsA_noherb[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_NECB_noherb <- tibble(NECBgsa_noherb_imp[, 3]/sum(NECBgsa_noherb_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(NECBgsa_noherb_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

The next code chunk does so for modeling scenario (ii), an ecosystem with only 
herbivores.

```{r scenario-2-gsa-necb, echo=TRUE, tidy=TRUE}
# filter out the model data and select only relevant parameters and 
# state variable
gsaNECB <- filter(NECBres, herbivore == "Herbivore") %>%
    select(., NECB, α:q, β:rh)

# run the gsa
NECBsA <- gsaNECB %>%
    select(., NECB:rh) %>%
    do(NECBgsa = randomForest(NECB ~., 
                              data = .,
                              proximity = TRUE,
                              importance = TRUE))
  
# extract the importance of each parameter
NECBgsa_imp <- as_tibble(importance(NECBsA[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_NECB_herb <- tibble(NECBgsa_imp[, 3]/sum(NECBgsa_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(NECBgsa_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

Finally, this next code chunk run the GSA for modeling scenario (iii), an 
ecosystem with herbivores and predators.

```{r scenario-3-gsa-necb, echo=TRUE, tidy=TRUE}
# filter out the model data and select only relevant parameters and 
# state variable
gsaNECBpred <- filter(NECBres, herbivore == "Predator") %>%
    select(., NECB, α:q, β:rh, τ:rr)

# run the gsa
NECBsA <- gsaNECBpred %>%
    select(., NECB:rr) %>%
    do(NECBgsa = randomForest(NECB ~., 
                              data = .,
                              proximity = TRUE,
                              importance = TRUE))
  
# extract the importance of each parameter
NECBgsaPred_imp <- as_tibble(importance(NECBsA[[1]][[1]]), rownames = NA) %>% 
      rownames_to_column(., var = "Parameter") 
  
# calculate the relative importance of each parameter
ranked_imp_NECBpred <- tibble(NECBgsaPred_imp[, 3]/sum(NECBgsaPred_imp[, 3])) %>% 
    mutate(., Parameter = as_factor(NECBgsaPred_imp$Parameter)) %>%
    dplyr::rename(., RelImpI = IncNodePurity)
```

# Visual deliverables

Here, we build graphs to explore the results of modeling work described above.
<aside>
All graph-generating code chunks below include a commented-out `ggsave()` function call. Uncomment it to save the graph produced into folder `../Results/`.
</aside>

## Animal influences on ecosystem C and N content

Animal _presence_ or _absence_ may influence the total amount of
C and N present in the system, as adding an additional trophic 
level requires higher productivity required to support it [@Oksanen1981]. 
Summing the C and N content across trophic compartment provides initial insights
on whether the presence of animals sparks quantitative changes in the amounts
of these two nutrients circling in the ecosystem (sensu @Rastetter1997). Notice 
that here, as below, we exclude the top and bottom 5% data points from the graph
to avoid visual artifacts due to outliers.
 
```{r vd-total-stock-contrast, echo=TRUE, tidy=TRUE, dpi=120, fig.retina=3, layout="l-body-outset", fig.cap="Contrast of total ecosystem stocks of C and N in the three modeling scenarios. In scenario (ii), the ecosystem contains a much larger quantity of both nutrients, C and N, compared to the other two scenarios. In particular, in scenario (ii) the ecosystem's total content of C is two orders of magnitude more than in scenario (i) and one order of magnitude higher than in scenario (iii). Similarly, scenario (ii) shows higher ecosyste content of N compared to either other two scenarios. Indeed, theoretical and empirical evidence suggest that larger amount of nutrients and energy are required to sustain longer, more complex trophic chains [@Oksanen1981]. These results not only confirm these earlier evidence and expectations but also point to the presence of animal consumers substantially affecting the biochemical balance of the ecosystem---further supporting the theoretical predictions of zoogeochemistry [@Schmitz2014;@Schmitz2018;Schmitz2023]. Labels over the clound of points report the median content of the relevant nutrient for each modeling scenario. Note the different scales on the y-axis and that the top and bottom 5% were removed to avoid visual artefacts due to outliers."}
# pivot the dataframe
randomI %>% 
    pivot_longer(., cols = c(Total_N, Total_C), 
                 names_to = "Compartment", 
                 values_to = "Stock") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
    separate(., col = "Compartment", 
             into = c("Compartment", "Nutrient"), 
             sep = "_") %>%
  # make sure "Compartment" and "herbivore" are factors
    mutate(., Compartment = as_factor(Compartment),
           herbivore = as_factor(herbivore),
           herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nNo animals" = "absent", 
                                "Scenario (ii)\nHerbivore" = "herbivore", 
                                "Scenario (iii)\nHerbivore & Predator" = "predator"),
           Nutrient = as_factor(Nutrient),
           Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
           Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  # group by the three factors of interest
    dplyr::group_by(., herbivore, 
                    Compartment, 
                    Nutrient) %>% 
  # filter the top and bottom 5% of data points to remove outliers
    dplyr::filter(., between(Stock, 
                          quantile(Stock, 0.05, na.rm = T), 
                          quantile(Stock, 0.95, na.rm = T)),
                  .preserve = TRUE) %>% 
  # plot the results
    ggplot(., aes(x = herbivore, y = Stock, col = herbivore)) + 
    gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05) +
    gghalves::geom_half_point(shape = 21, alpha = 0.1, stroke = 2) +
    stat_summary(geom = "label", fun = quantile,
                 fun.args = list(probs = 0.5),
                 aes(label = round(after_stat(y), 2)),
                 position = position_nudge(x = 0.19),
                 show.legend = F, size = 2.5,
                 label.padding = unit(0.15, "lines"),
                 label.size = 0.15,
                 fontface = "bold",
                 color = "black") +
    xlab(" ") +
    scale_color_met_d("Egypt", direction = 1) +
    guides(color = guide_legend(title = "Modeling scenario", override.aes = list(alpha = 1, stroke = 1))) +
    facet_wrap(.~Nutrient,
               scales = "free") +
    theme_classic() +
    theme(legend.position = "bottom",
          text = element_text(size = 14),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

# save the graph
# ggsave(filename = "../Results/HerbivoreContrast_randomI_TotalStocks.svg", 
#        dpi = 300, path = "../Results/", device = "svg", height = 5, width = 8)
```

The graph below shows a summary of the differences in the C and N content in 
Soil and Plants when animals are _absent_ (scenario (i)) vs. when 
they are _present_ (scenarios (ii) and (iii)) from the system. Note that to 
prevent graphical artefacts we exclude the top and bottom 5% of stock 
values from the graph.  

```{r vd-herbivore-contrast, echo=TRUE, tidy=TRUE, dpi=120, fig.retina=3, layout="l-body-outset", fig.cap="Contrast of how animal _presence_ and _absence_ influences the content of C and N in the soil and plant compartments. Modeling scenarios differ in the amount of C (top row) stored in plant and herbivore biomass, higher plant C content in scenarios (ii) [blue] and (iii) [green]. As shown in **Figure 1**, when animals are present a much larger amount of C is captured in the system than when they are absent. Here, we show that a sizeable portion of this larger quantity of captured C is locked in plant biomass, while the remaining one is split unevenly between the remaining trophic compartments. As well, note that the amount of C store in soil stocks is one order of magnitude larger when animals are _present_ (blue and green) than when they are _absent_ (red). Labels over the clound of points report the median content of the relevant nutrient for each trophic compartment. Note that, to avoid graphical artefacts due to the presence of extreme values in the dataset, we removed the top and bottom 5% of stock values of both C and N in both soil and plant compartments. See **Table 1** below for the values of the summary statistics shown here."}
# build the graph
stockContrast <- randomI %>% 
  pivot_longer(., cols = c(Soil_N:Plant_C, Herbivore_N:Herbivore_C, Predator_N:Predator_C), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nNo animals" = "absent", 
                                "Scenario (ii)\nHerbivore" = "herbivore", 
                                "Scenario (iii)\nHerbivore & Predator" = "predator"),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, sort)) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  ggplot(., aes(x = herbivore, y = Stock, col = herbivore)) + 
  gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05, fatten = 4) +
  gghalves::geom_half_point(shape = 21, alpha = 0.1, stroke = 1) +
  stat_summary(geom = "label", fun = quantile,
               fun.args = list(probs = 0.5),
               aes(label = round(after_stat(y), 2)),
               position = position_nudge(x = 0.19),
               show.legend = F, size = 2.5,
               label.padding = unit(0.15, "lines"),
               label.size = 0.15,
               fontface = "bold",
               color = "black") +
  scale_color_met_d("Egypt", direction = 1) + 
  guides(color = guide_legend(title = "Modeling scenario", override.aes = list(alpha = 1, stroke = 1))) +
  xlab(" ") +
  facet_grid2(Nutrient~Compartment,
             scales = "free_y",
             independent = "y") +
  theme_classic() +
  theme(legend.position = "top",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

stockContrast
```

The summary table below lists the values of the summary statistics shown in 
Figure \@ref(fig:vd-herbivore-contrast). The table is organized by modeling scenario, 
with each column capturing summary statistics by nutrient (N or C), and by 
trophic compartment (soil, plants, herbivores, predators).

```{r vd-summary-tab, echo=TRUE, tidy=TRUE}
soil_tab <- randomI %>%  
  pivot_longer(., cols = c(Soil_N:Plant_C, Herbivore_N, Herbivore_C, Predator_N, Predator_C), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_relevel(.f = herbivore,
                                 "predator",
                                 "herbivore",
                                 "absent"),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)<br> No animals" = "absent", 
                                "Scenario (ii)<br> Herbivore" = "herbivore", 
                                "Scenario (iii)<br> Herbivore & Predator" = "predator")) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., Compartment == "Soil", 
                between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  dplyr::ungroup() %>%
  dplyr::group_by(., herbivore) %>%
  tbl_strata(.,
             strata = herbivore,
             .tbl_fun =
               ~.x %>%
               tbl_summary(by = Nutrient,
                           type = list(Stock ~ 'continuous2'),
                           statistic = Stock ~ c("{N_obs}",
                                                 "{median}\n ({p25}, {p75})",
                                                 "{min}-{max}"),
                           include = Stock,
                           digits = Stock ~ 2) %>%
               modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
               add_stat_label(label = Stock ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min-Max")) %>%
               modify_caption("Summary statistics for equilibrium stock values of C and N when animals are _present_ and _absent_ from the ecosystem, as shown in Figure 1."),
             .header = "**{strata}**"
             )

plant_tab <- randomI %>%  
    pivot_longer(., cols = c(Soil_N:Plant_C, Herbivore_N, Herbivore_C, Predator_N, Predator_C), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
    separate(., col = "Compartment", 
             into = c("Compartment", "Nutrient"), 
             sep = "_") %>%
    mutate(., Compartment = as_factor(Compartment),
           herbivore = as_factor(herbivore),
           herbivore = fct_relevel(.f = herbivore,
                                   "predator",
                                   "herbivore",
                                   "absent"),
           herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)<br> No animals" = "absent", 
                                "Scenario (ii)<br> Herbivore" = "herbivore", 
                                "Scenario (iii)<br> Herbivore & Predator" = "predator")) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., Compartment == "Plant", 
                between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  dplyr::ungroup() %>%
  dplyr::group_by(., herbivore) %>%
  tbl_strata(.,
             strata = herbivore,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Nutrient,
                           type = list(Stock ~ 'continuous2'),
                           statistic = Stock ~ c("{N_obs}",
                                                 "{median}\n ({p25}, {p75})",
                                                 "{min}-{max}"),
                           include = Stock,
                           digits = Stock ~ 2) %>% 
               modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
               add_stat_label(label = Stock ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min-Max")),
             .header = "**{strata}**"
             )

herb_tab <- randomI %>% 
  pivot_longer(., cols = c(Soil_N:Plant_C, Herbivore_N, Herbivore_C, Predator_N, Predator_C), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_relevel(.f = herbivore,
                                 "predator",
                                 "herbivore",
                                 "absent"),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)<br> No animals" = "absent", 
                                "Scenario (ii)<br> Herbivore" = "herbivore", 
                                "Scenario (iii)<br> Herbivore & Predator" = "predator")) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., Compartment == "Herbivore", 
                between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  dplyr::ungroup() %>%
  dplyr::group_by(., herbivore) %>%
  tbl_strata(.,
             strata = herbivore,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Nutrient,
                           type = list(Stock ~ 'continuous2'),
                           statistic = Stock ~ c("{N_obs}",
                                                 "{median}\n ({p25}, {p75})",
                                                 "{min}-{max}"),
                           include = Stock,
                           digits = Stock ~ 2) %>% 
               modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
               add_stat_label(label = Stock ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min-Max")),
             .header = "**{strata}**"
             )

pred_tab <- randomI %>% 
  pivot_longer(., cols = c(Soil_N:Plant_C, Herbivore_N, Herbivore_C, Predator_N, Predator_C), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_relevel(.f = herbivore,
                                 "predator",
                                 "herbivore",
                                 "absent"),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)<br> No animals" = "absent", 
                                "Scenario (ii)<br> Herbivore" = "herbivore", 
                                "Scenario (iii)<br> Herbivore & Predator" = "predator")) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., Compartment == "Predator", 
                between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  dplyr::ungroup() %>%
  dplyr::group_by(., herbivore) %>%
  tbl_strata(.,
             strata = herbivore,
             .tbl_fun = 
               ~.x %>% 
               tbl_summary(by = Nutrient,
                           type = list(Stock ~ 'continuous2'),
                           statistic = Stock ~ c("{N_obs}",
                                                 "{median}\n ({p25}, {p75})",
                                                 "{min}-{max}"),
                           include = Stock,
                           digits = Stock ~ 2) %>% 
               modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
               add_stat_label(label = Stock ~ c("n", 
                                                "Median\n (IQR)", 
                                                "Min-Max")),
             .header = "**{strata}**"
             )

tbl_stack(list(soil_tab, plant_tab, herb_tab, pred_tab), 
          group_header = c("Soil", "Plants", "Herbivores", "Predators"))
```

The next graph combines Figures \@ref(fig:vd-total-stock-contrast) and 
\@ref(fig:vd-herbivore-contrast) to show standardized stock values for each 
compartment. That is, for each iteration of the model, we divide the equilibrium
C or N content of each trophic compartment by the total amount of C or N in the 
ecosystem. This allows us to see how each compartment compares with all others 
in terms of C or N content in relative terms across the three modeling scenarios. 
Note that, unlike Figure \@ref(fig:vd-herbivore-contrast), in this graph we show 
the animal data to confirm that the sum total of C and N in the system adds 
up to 1. The seemingly missing 0.05 is due to our exclusion of the top 
and bottom 5% of the data to avoid visual artifacts due to outliers.

```{r vd-standard-herbivore-contrast, echo=TRUE, tidy=TRUE, dpi=120, fig.retina=3, layout="l-body-outset", fig.cap="Comparison of the standardized nutrient content of each trophic compartment in the ecosystem, across the three modeling scenarios. A larger share of C appears locked in plants in scenario (i), where animals are absent from the ecosystem. However, as shown in **Figure 1**, the overall quantity of C in contained by the ecosystem in this scenario (i) is small compared to scenarios (ii) and (iii). Conversely, while relatively less C is locked in plant vs herbivore biomass in scenario (ii) and (iii), this is a much larger quantity in absolute terms. Similar considerations can be made for the N content of trophic compartments when animals are present: while the relative content appears smaller inscenarios (ii) and (iii), the absolute value is actually much larger due to the higher total ecosystem N (**Figure 1**). Labels over the clound of points report the median content of the relevant nutrient for each trophic compartment. Note that, while this graph may make it look like herbivores and predators have a C:N of almost 1:1, this is an artifact of the standardization and does not reflect reality---as shown in **Figure 2**."}
# build the graph
stdBP <- randomI %>% 
  pivot_longer(., cols = c(Soil_Nstd:Plant_Cstd, Herbivore_Nstd, Herbivore_Cstd, Predator_Nstd, Predator_Cstd), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nSoil-Plants control" = "absent", 
                                "Scenario (ii)\nHerbivores" = "herbivore", 
                                "Scenario (iii)\nHerbivores & Predators" = "predator"),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Carbon = "Cstd", Nitrogen = "Nstd"),
         Nutrient = fct_relevel(.f = Nutrient, sort)) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  ggplot(., aes(x = Compartment, y = Stock, col = Compartment)) + 
  gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.025) +
  gghalves::geom_half_point(shape = 21, alpha = 0.05, stroke = 1) +
   stat_summary(geom = "label", fun = quantile, 
               fun.args = list(probs = 0.5), 
               aes(label = round(after_stat(y), 2)), 
               position = position_nudge(x = 0.19), 
               show.legend = F, size = 2.5,
               label.padding = unit(0.15, "lines"), 
               label.size = 0.15,
               fontface = "bold",
               color = "black") + 
  ylab("Standardised nutrient content") + 
  xlab(" ") +
  scale_color_met_d("Isfahan2", direction = 1) + 
  guides(color = guide_legend(title = "Compartment", override.aes = list(alpha = 1, stroke = 1))) +
  facet_grid(Nutrient~herbivore) +
  theme_classic() +
  theme(legend.position = "top",
        text = element_text(size = 14),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# ggsave(filename = "../Results/HerbivoreContrast_randomI_standardized.svg",
#        dpi = 300, path = "../Results/", device = "svg", width = width, height = height)

stdBP
```

Next, we calculate the biomass ratios for both C and N for all pairings of
trophic compartments across the three modeling sceanrios. The box-and-whiskers 
plots below shows the values of these ratios, and how they compare between 
elements and across modeling scenarios.

```{r vd-biomass-ratios-boxplots, echo=TRUE, tidy=TRUE, dpi=120, fig.retina=3, layout="l-body-outset", fig.cap="Comparison of biomass ratios among the three modeling scenarios. Biomass ratios computed include Predator:Herbivore, Predator:Plant, Predator:Soil, Herbivore:Plant, Herbivore:Soil, and Soil:Plant, for both C and N. Note that the scale of the y-axis is cutoff at a value of y = 150 to show the full extent of a majority of the boxplots, as otherwise it would be hidden by the _tail_ of outlying points stretch upwards."}
# first, calculate the ratios when animals are absent
absentRatios <- randomI %>% 
  dplyr::filter(., herbivore == "absent") %>%
  dplyr::filter(., 
                between(Soil_C, 
                        quantile(Soil_C, 0.05, na.rm = T), 
                        quantile(Soil_C, 0.95, na.rm = T)), 
                between(Soil_N, 
                        quantile(Soil_N, 0.05, na.rm = T), 
                        quantile(Soil_N, 0.95, na.rm = T)), 
                between(Plant_C, 
                        quantile(Plant_C, 0.05, na.rm = T), 
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N, 
                        quantile(Plant_N, 0.05, na.rm = T), 
                        quantile(Plant_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                PS_C = Plant_C/Soil_C) %>%
  dplyr::select(., herbivore:I, PS_N:PS_C) %>%
  pivot_longer(., PS_N:PS_C, names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  dplyr::group_by(., CompartmentPair, Nutrient) 

# then, calculate the ratios when only the herbivores are present
herbRatios <- randomI %>% 
  dplyr::filter(., herbivore == "herbivore") %>%
  dplyr::filter(.,
                between(Soil_C,
                        quantile(Soil_C, 0.05, na.rm = T),
                        quantile(Soil_C, 0.95, na.rm = T)),
                between(Soil_N,
                        quantile(Soil_N, 0.05, na.rm = T),
                        quantile(Soil_N, 0.95, na.rm = T)),
                between(Plant_C,
                        quantile(Plant_C, 0.05, na.rm = T),
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N,
                        quantile(Plant_N, 0.05, na.rm = T),
                        quantile(Plant_N, 0.95, na.rm = T)),
                between(Herbivore_C,
                        quantile(Herbivore_C, 0.05, na.rm = T),
                        quantile(Herbivore_C, 0.95, na.rm = T)),
                between(Herbivore_N,
                        quantile(Herbivore_N, 0.05, na.rm = T),
                        quantile(Herbivore_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                HP_N = Herbivore_N/Plant_N,
                HS_N = Herbivore_N/Soil_N,
                PS_C = Plant_C/Soil_C,
                HP_C = Herbivore_C/Plant_C,
                HS_C = Herbivore_C/Soil_C,) %>%
  dplyr::select(., herbivore:I, PS_N:HS_C) %>%
  pivot_longer(., PS_N:HS_C, names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  dplyr::group_by(., CompartmentPair, Nutrient)

# and then calculate them for the model with predators
predRatios <- randomI %>% 
  dplyr::filter(., herbivore == "predator") %>%
  dplyr::filter(.,
                between(Soil_C,
                        quantile(Soil_C, 0.05, na.rm = T),
                        quantile(Soil_C, 0.95, na.rm = T)),
                between(Soil_N,
                        quantile(Soil_N, 0.05, na.rm = T),
                        quantile(Soil_N, 0.95, na.rm = T)),
                between(Plant_C,
                        quantile(Plant_C, 0.05, na.rm = T),
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N,
                        quantile(Plant_N, 0.05, na.rm = T),
                        quantile(Plant_N, 0.95, na.rm = T)),
                between(Herbivore_C,
                        quantile(Herbivore_C, 0.05, na.rm = T),
                        quantile(Herbivore_C, 0.95, na.rm = T)),
                between(Herbivore_N,
                        quantile(Herbivore_N, 0.05, na.rm = T),
                        quantile(Herbivore_N, 0.95, na.rm = T)),
                between(Predator_C,
                        quantile(Predator_C, 0.05, na.rm = T),
                        quantile(Predator_C, 0.95, na.rm = T)),
                between(Predator_N,
                        quantile(Predator_N, 0.05, na.rm = T),
                        quantile(Predator_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                HP_N = Herbivore_N/Plant_N,
                HS_N = Herbivore_N/Soil_N,
                PH_N = Predator_N/Herbivore_N,
                PP_N = Predator_N/Plant_N,
                PS_C = Plant_C/Soil_C,
                HP_C = Herbivore_C/Plant_C,
                HS_C = Herbivore_C/Soil_C,
                PH_C = Predator_C/Herbivore_C,
                PP_C = Predator_C/Plant_C) %>%
  dplyr::select(., herbivore:I, PS_N:PP_C) %>%
  pivot_longer(., PS_N:PP_C, names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  dplyr::group_by(., CompartmentPair, Nutrient)

# now bind the two dataframes together and plot the results
bind_rows(absentRatios, herbRatios, predRatios) %>%
  mutate(., herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nSoil-Plants control" = "absent", 
                                "Scenario (ii)\nHerbivores" = "herbivore", 
                                "Scenario (iii)\nHerbivores & Predators" = "predator"),
         CompartmentPair = as_factor(CompartmentPair),
         CompartmentPair = fct_relevel(.f = CompartmentPair, "PS", "HS", "HP", "PH", "PP"),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C")) %>%
  ggplot(., aes(x = CompartmentPair, y = Ratio, col = CompartmentPair)) + 
  gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.02) +
  gghalves::geom_half_point(shape = 21, alpha = 0.1) +
  scale_color_moma_d("VanGogh", direction = 1) +
  xlab("Biomass ratio") +
  ylab(" ") +
  facet_grid2(Nutrient~herbivore, scales = "free", drop = F, independent = "y") + 
  theme(legend.position = "none")

# ggsave(filename = "../Results/BiomassRatios.svg", 
#        device = "svg", dpi = 300, width = 8, height = 4)
```

The table below, shows the mean values of each biomass ratio shown in 
panel (a) of Figure \@ref(fig:vd-biomass-ratios-boxplots).

```{r vd-biomass-ratios-mean-table-present, echo=TRUE, tidy=TRUE}

absentRatiosTab <- randomI %>% 
  dplyr::filter(., herbivore == "absent") %>%
  dplyr::filter(.,
                between(Soil_C,
                        quantile(Soil_C, 0.05, na.rm = T),
                        quantile(Soil_C, 0.95, na.rm = T)),
                between(Soil_N,
                        quantile(Soil_N, 0.05, na.rm = T),
                        quantile(Soil_N, 0.95, na.rm = T)),
                between(Plant_C,
                        quantile(Plant_C, 0.05, na.rm = T),
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N,
                        quantile(Plant_N, 0.05, na.rm = T),
                        quantile(Plant_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                PS_C = Plant_C/Soil_C) %>%
  dplyr::select(., herbivore:I, PS_N:PS_C) %>%
  pivot_longer(., PS_N:PS_C, 
               names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", 
           into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  mutate(., CompartmentPair = as_factor(CompartmentPair),
         CompartmentPair = fct_recode(.f = CompartmentPair, 
                                      "Plant:Soil" = "PS")) %>%
  tbl_strata(
    strata = CompartmentPair,
    .tbl_fun = 
      ~.x %>%
      tbl_summary(by = Nutrient,
              type = Ratio ~ "continuous",
              statistic = Ratio ~ c("{mean}
                                    ({sd})"),
              digits = Ratio ~ 2,
              include = Ratio) %>%
      modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
      add_stat_label(label = Ratio ~ c("Mean\n (SD)")),
    .header = "**{strata}**"
  ) 

herbRatiosTab <- randomI %>% 
  dplyr::filter(., herbivore == "herbivore") %>%
  dplyr::filter(.,
                between(Soil_C,
                        quantile(Soil_C, 0.05, na.rm = T),
                        quantile(Soil_C, 0.95, na.rm = T)),
                between(Soil_N,
                        quantile(Soil_N, 0.05, na.rm = T),
                        quantile(Soil_N, 0.95, na.rm = T)),
                between(Plant_C,
                        quantile(Plant_C, 0.05, na.rm = T),
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N,
                        quantile(Plant_N, 0.05, na.rm = T),
                        quantile(Plant_N, 0.95, na.rm = T)),
                between(Herbivore_C,
                        quantile(Herbivore_C, 0.05, na.rm = T),
                        quantile(Herbivore_C, 0.95, na.rm = T)),
                between(Herbivore_N,
                        quantile(Herbivore_N, 0.05, na.rm = T),
                        quantile(Herbivore_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                HP_N = Herbivore_N/Plant_N,
                HS_N = Herbivore_N/Soil_N,
                PS_C = Plant_C/Soil_C,
                HP_C = Herbivore_C/Plant_C,
                HS_C = Herbivore_C/Soil_C) %>%
  dplyr::select(., herbivore:I, PS_N:HS_C) %>%
  pivot_longer(., PS_N:HS_C, 
               names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", 
           into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  mutate(., CompartmentPair = as_factor(CompartmentPair),
         CompartmentPair = fct_recode(.f = CompartmentPair, 
                                      "Herbivore:Plant" = "HP", 
                                      "Herbivore:Soil" = "HS", 
                                      "Plant:Soil" = "PS")) %>%
  tbl_strata(
    strata = CompartmentPair,
    .tbl_fun = 
      ~.x %>%
      tbl_summary(by = Nutrient,
              type = Ratio ~ "continuous",
              statistic = Ratio ~ c("{mean}
                                    ({sd})"),
              digits = Ratio ~ 2,
              include = Ratio) %>%
      modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
      add_stat_label(label = Ratio ~ c("Mean\n (SD)")),
    .header = "**{strata}**"
  ) 

predRatiosTab <- randomI %>% 
  dplyr::filter(., herbivore == "predator") %>%
  dplyr::filter(.,
                between(Soil_C,
                        quantile(Soil_C, 0.05, na.rm = T),
                        quantile(Soil_C, 0.95, na.rm = T)),
                between(Soil_N,
                        quantile(Soil_N, 0.05, na.rm = T),
                        quantile(Soil_N, 0.95, na.rm = T)),
                between(Plant_C,
                        quantile(Plant_C, 0.05, na.rm = T),
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N,
                        quantile(Plant_N, 0.05, na.rm = T),
                        quantile(Plant_N, 0.95, na.rm = T)),
                between(Herbivore_C,
                        quantile(Herbivore_C, 0.05, na.rm = T),
                        quantile(Herbivore_C, 0.95, na.rm = T)),
                between(Herbivore_N,
                        quantile(Herbivore_N, 0.05, na.rm = T),
                        quantile(Herbivore_N, 0.95, na.rm = T)),
                between(Predator_C,
                        quantile(Predator_C, 0.05, na.rm = T),
                        quantile(Predator_C, 0.95, na.rm = T)),
                between(Predator_N,
                        quantile(Predator_N, 0.05, na.rm = T),
                        quantile(Predator_N, 0.95, na.rm = T))) %>%
  dplyr::mutate(., .after = q, 
                PS_N = Plant_N/Soil_N,
                HP_N = Herbivore_N/Plant_N,
                HS_N = Herbivore_N/Soil_N,
                PH_N = Predator_N/Herbivore_N,
                PP_N = Predator_N/Plant_N,
                PS_C = Plant_C/Soil_C,
                HP_C = Herbivore_C/Plant_C,
                HS_C = Herbivore_C/Soil_C,
                PH_C = Predator_C/Herbivore_C,
                PP_C = Predator_C/Plant_C) %>%
  dplyr::select(., herbivore:I, PS_N:PP_C) %>%
  pivot_longer(., PS_N:PP_C, 
               names_to = "RatioPair", values_to = "Ratio") %>%
  separate(., "RatioPair", 
           into = c("CompartmentPair", "Nutrient"), sep = "_") %>%
  mutate(., CompartmentPair = as_factor(CompartmentPair),
         CompartmentPair = fct_recode(.f = CompartmentPair, 
                                      "Herbivore:Plant" = "HP", 
                                      "Herbivore:Soil" = "HS", 
                                      "Plant:Soil" = "PS", 
                                      "Predator:Herbivore" = "PH", 
                                      "Predator:Plant" = "PP")) %>%
  tbl_strata(
    strata = CompartmentPair,
    .tbl_fun = 
      ~.x %>%
      tbl_summary(by = Nutrient,
              type = Ratio ~ "continuous",
              statistic = Ratio ~ c("{mean}
                                    ({sd})"),
              digits = Ratio ~ 2,
              include = Ratio) %>%
      modify_header(
                 label = '**Nutrient**',
                 stat_1 = '**{level}**',
                 stat_2 = '**{level}**'
                 ) %>%
      add_stat_label(label = Ratio ~ c("Mean\n (SD)")),
    .header = "**{strata}**"
  ) 

tbl_stack(list(absentRatiosTab, herbRatiosTab, predRatiosTab), 
          group_header = c("Scenario (i) Soil-Plants control", "Scenario (ii) Herbivores", "Scenario (iii) Herbivores & Predators"))
```

The figure below shows the median and distribution of values of all parameters 
in the model, across the three modeling scenarios. 

```{r vd-params-plots, echo=TRUE, tidy=TRUE, layout="l-body-outset", dpi=120, fig.retina=3, layout="l-body-outset", fig.cap="Parameter values across the model's equations, for all three modeling scenarios. The first two rows contain parameters shared across modeling scenarios. Plant-related parameters are shown on the second row, herbivore-related ones on the third row, and predator-related ones on the bottom row. Labels floating above the clound of points report the median value of each parameter in each modeling scenario. Note (i) the different y-axis scales, (ii) that we removed the top and bottom 5% of the stock values for soil C, N, and plant C, N, before plotting to avoid graphic artefacts, and (iii) that we do not show the inorganic nutrient leaching rate as its value is fixed to _k = 0.5_."}

randomIparams <- randomI %>% 
  dplyr::filter(., 
                between(Soil_C, 
                        quantile(Soil_C, 0.05, na.rm = T), 
                        quantile(Soil_C, 0.95, na.rm = T)), 
                between(Soil_N, 
                        quantile(Soil_N, 0.05, na.rm = T), 
                        quantile(Soil_N, 0.95, na.rm = T)), 
                between(Plant_C, 
                        quantile(Plant_C, 0.05, na.rm = T), 
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N, 
                        quantile(Plant_N, 0.05, na.rm = T), 
                        quantile(Plant_N, 0.95, na.rm = T))) %>%
  dplyr::select(., c(TIME, herbivore, I, q, ap, rp, α, δ, ah, rh, β, π, ar, rr, τ))

design <- "
    AB## 
    CDEF
    GHIJ
    KLMN
"

randomIparams %>%
  pivot_longer(., cols = !c(herbivore, TIME), 
               names_to = "Parameter", 
               values_to = "Value") %>% 
  mutate(., 
         herbivore = as_factor(herbivore),
         Parameter = as_factor(Parameter),
         PrmEqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh",
                                                        "Herbivore",
                                                        "Predator"))),
         PrmEqn = as_factor(PrmEqn),
         PrmEqn = fct_relevel(.f = PrmEqn, "Soil", "Plant", "Herbivore", "Predator"),
         Parameter = case_when(Parameter %in% "ah" ~ "a[H]",
                               Parameter %in% "rh" ~ "r[H]",
                               Parameter %in% "ap" ~ "a[P]",
                               Parameter %in% "rp" ~ "r[P]",
                               Parameter %in% "ar" ~ "a[R]",
                               Parameter %in% "rr" ~ "r[R]",
                               Parameter %in% "q" ~ "q[S]",
                               Parameter %in% "α" ~ "\u03B1",
                               Parameter %in% "β" ~ "\u03B2",
                               Parameter %in% "δ" ~ "\u03B4",
                               Parameter %in% "π" ~ "\u03C0",
                               Parameter %in% "τ" ~ "\u03C4",
                               TRUE ~ as.character(Parameter)),
         Parameter = as_factor(Parameter)) %>%
  dplyr::group_by(., herbivore, PrmEqn, Parameter) %>% 
  ggplot(., aes(x = herbivore, y = Value, col = herbivore)) + 
  gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05) +
  gghalves::geom_half_point(shape = 21, alpha = 0.05) +
  ylab("Parameter values") +
  stat_summary(geom = "label",
               fun = quantile,
               fun.args = list(probs = 0.5),
               aes(label = round(after_stat(y), 2)),
               size = 2.5, orientation = "x",
               label.padding = unit(0.15, "lines"),
               position = position_nudge(x = 0.19),
               label.size = 0.15,
               fontface = "bold",
               color = "black") +
  scale_color_met_d("Egypt", direction = 1) +
  guides(color = guide_legend(title = "Modeling scenario", 
                              override.aes = list(alpha = 1, stroke = 1))) +
  xlab(" ") +
  facet_manual(Parameter~.,
             scales = "free",
             design = design,
             labeller = label_parsed, 
             axes = "y") +
  theme(legend.position = "top",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# ggsave(filename = "../Results/ParameterValues_randomI.svg", 
#        device = "svg", dpi = 300, height = 7, width = 6)
```

It would appear that the two parameters _a~p~_ and _q~S~_ act in somewhat opposite 
ways in the two versions of the model, with median _q~S~_ being progressively 
higher when animals are present in the model while _a~p~_ decreases as the 
length of the food web increases.

<aside>
Note that we assume herbivores and predators (when present) to have equal C:N. 
For a rationale, see the **manuscript**.
</aside>

The table below report the mean and standard deviation of all parameters in the
model, across the three modeling scenarios, and it meant as a companion for the
figure above. 

```{r vd-params-tab, echo=TRUE,tidy=TRUE}
randomI %>% 
  dplyr::filter(., 
                between(Soil_C, 
                        quantile(Soil_C, 0.05, na.rm = T), 
                        quantile(Soil_C, 0.95, na.rm = T)), 
                between(Soil_N, 
                        quantile(Soil_N, 0.05, na.rm = T), 
                        quantile(Soil_N, 0.95, na.rm = T)), 
                between(Plant_C, 
                        quantile(Plant_C, 0.05, na.rm = T), 
                        quantile(Plant_C, 0.95, na.rm = T)),
                between(Plant_N, 
                        quantile(Plant_N, 0.05, na.rm = T), 
                        quantile(Plant_N, 0.95, na.rm = T))) %>%
  dplyr::group_by(., herbivore) %>%
  dplyr::summarise(., 
                   dplyr::across(.cols = c(I:k, α:q, β:rh, τ:rr), 
                                 list(Mean = mean, 
                                      SD = sd))) %>%
  pivot_longer(., 
               cols = c(I_Mean:rr_SD), 
               names_to = "parameter", 
               values_to = "value") %>%
  separate(., 
           parameter, 
           into = c("Parameter", 
                    "Metric"), 
           sep = "_") %>% 
  mutate(., herbivore = as_factor(herbivore),
         Parameter = case_when(Parameter %in% "ah" ~ "a@H~",
                               Parameter %in% "rh" ~ "r@H~",
                               Parameter %in% "ap" ~ "a@P~",
                               Parameter %in% "rp" ~ "r@P~",
                               Parameter %in% "α" ~ "\u03B1",
                               Parameter %in% "β" ~ "\u03B2",
                               Parameter %in% "δ" ~ "\u03B4",
                               Parameter %in% "π" ~ "\u03C0",
                               Parameter %in% "τ" ~ "\u03C4",
                               Parameter %in% "ar" ~ "a@R~",
                               Parameter %in% "rr" ~ "r@R~",
                               TRUE ~ as.character(Parameter)),
         Parameter = as_factor(Parameter),
         PrmEqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "\u03B1" |
                                        Parameter == "\u03B4" |
                                        Parameter == "a@P~" |
                                        Parameter == "r@P~",
                                        "Plant", ifelse(herbivore == "herbivore" &
                                                        Parameter == "\u03B2" |
                                                        Parameter == "\u03C0" | 
                                                        Parameter == "a@H~" |
                                                        Parameter == "r@H~" ,
                                                        "Herbivore", "Predator"))),
         PrmEqn = as_factor(PrmEqn),
         PrmEqn = fct_relevel(.f = PrmEqn, "Soil", "Plant", "Herbivore", "Predator")) %>%
  pivot_wider(., 
              id_cols = c(PrmEqn, Parameter), 
              names_from = c(Metric, herbivore),
              values_from = value) %>%
  arrange(., PrmEqn, Parameter, .by_group = T) %>%
  ungroup() %>%
  gt(groupname_col = "PrmEqn", row_group_as_column = T) %>% 
  row_group_order(groups = c("Soil", "Plant", "Herbivore", "Predator")) %>%
  tab_spanner(label = md("**Scenario (i)<br>No animals**"), 
              columns = c("Mean_absent", "SD_absent")) %>%
  tab_spanner(label = md("**Scenario (ii)<br>Herbivores**"), 
              columns = c("Mean_herbivore", "SD_herbivore")) %>%
  tab_spanner(label = md("**Scenario (iii)<br>Herbivores & Predators**"), 
              columns = c("Mean_predator", "SD_predator")) %>%
  cols_label(PrmEqn = "Compartment",
             Parameter = "Parameter", 
             "Mean_absent" = "Mean", 
             "SD_absent" = "SD", 
             "Mean_herbivore" = "Mean", 
             "SD_herbivore" = "SD",
             "Mean_predator" = "Mean", 
             "SD_predator" = "SD") %>%
  fmt_number(columns = c(3:8), decimals = 2) %>%
  cols_align_decimal() %>%
  sub_missing() %>%
  text_transform(
    locations = cells_body(),
    fn = function(x) {
      str_replace_all(x,
                      pattern = "@",
                      replacement = "<sub>") %>% 
        str_replace_all("~",
                        "</sub>") }
  ) %>%
  tab_caption(caption = md("Mean and standard deviation (SD) for all parameters in the two versions of the model."))
```

Next, we will produce graphs to explore animal influence on the three ecosystem
function of interest listed above: primary producers biomass accumulation, 
primary productivity, and Net Ecosystem Carbon Balance [@Chapin2006].

## Animals influence on ecosystem functions 

Here we analyse graphically the effects of animals on three ecosystem 
functions; namely, [Primary producers biomass accumulation], 
[Primary Productivity], and [Net Ecosystem Carbon Balance].

### Primary producers biomass accumulation

Here, we investigate how the uptake ( _a~H~_, _a~R~_) and recycling ( _r~H~_, 
_r~R~_) rates of animals---when present---influence how much plant biomass is 
present in the ecosystem and how this quantity changes over time. We use the 
equilibrium value of plant stock ($P^*_i$) as our estimate of plant biomass and 
its partial derivatives with respect to uptake and recycling rates of herbivores
and predators, respectively. 
<aside>
Note that below we do not consider scenario (i), where no animals are present in
the ecosystem
</aside>

#### Scenario (ii), herbivores-only

The graph below shows the results for the change in plant biomass as a function 
of _a~H~_, the herbivore's uptake rate, as evaluated using the partial derivative,

$$
  \frac{\partial P^*_i}{\partial a_H}
$$

where $i \in [C, N]$.

```{r vd-scenario-2-plant-biomass-pd-ah-sp, echo=TRUE, tidy=TRUE}
plantBpdah <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N_ah,Plant_C_ah) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_ah), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black", se = T) +
  ylab(expression(paste(partialdiff,P[i]^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Change in Plant C and N content with herbivore uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_ah.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdah
```

The data in \@ref(fig:vd-plant-biomass-pd-ah-sp) are quite spread out, so the next graph
zooms in on the region around the `y = 0` line. Note that we removed the trend
line in this next figure because using function `coord_cartesian()` simply zooms
the plot but does not change the data underlying it, which causes some graphical
artefacts in the trend line.

```{r vd-scenario-2-plant-biomass-pd-ah-zoom, echo=TRUE,tidy=TRUE}
PlantCPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N_ah,Plant_C_ah) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_ah), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P[C]^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-50, 50)) 

# PlantCPDzoom

PlantNPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N_ah,Plant_C_ah) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_ah), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P[N]^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(-.5, .5)) 

# PlantNPDzoom

PlantCPDzoom + PlantNPDzoom + plot_annotation(title = "Change in plant C and N content with herbivore uptake rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/BiomassPD_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Next, we are plotting the value of plant biomass at equilibrium ($P^*_i$, where 
$i \in [C, N]$ ) against the values of parameter _a~H~_.

```{r vd-scenario-2-plant-biomass-eq-ah, echo=TRUE, tidy=TRUE}
EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Plant C and N content at equilibrium against herbivore uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

And, again, a zoomed-in version to get a better idea of what is going on around 
the `y = 0` line.

```{r vd-scenario-2-plant-biomass-eq-ah-zoom, echo=TRUE, tidy=TRUE}
PlantCzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(0, 500)) 

# PlantCzoom

PlantNzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[N]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNzoom

PlantCzoom + PlantNzoom + plot_annotation(title = "Plant C and N content at equilibrium against herbivore uptake rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Now, we move on to the results of the plant biomass partial derivative with 
respect to _r~H~_, the herbivores' recycling rate,

$$
  \frac{\partial P^*_i}{\partial r_H}
$$

where $i \in [C, N]$.

```{r vd-scenario-2-plant-biomass-pd-rh, echo=TRUE, tidy=TRUE}
plantBpdrh <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh, Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black") +
  ylab(expression(paste(partialdiff,P[i]^{"*"},"/",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in plant C and N content with herbivore recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_rh.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdrh
```

As before, let us zoom in the region of the graph around the `y = 0` line.

```{r vd-scenario-2-plant-biomass-pd-rh-zoom, echo=TRUE,tidy=TRUE}
PlantCPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh,Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P[C]^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-1, 50)) 

# PlantCPDzoom

PlantNPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh,Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(-0.05, 0.5)) 

# PlantNPDzoom

PlantCPDzoom + PlantNPDzoom + plot_annotation(title = "Change in plant C and N content with herbivore recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/BiomassPD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Next, we show the equilibrium values of plant biomass against _r~H~_.

```{r vd-scenario-2-plant-biomass-eq-rh, echo=TRUE, tidy=TRUE}
EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Plant C and N content at equilibrium against herbivore recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

As before, the data are very much squashed against the x-axis, so we will zoom
in once again to better visualize the `y = 0` region.

```{r vd-scenario-2-plant-biomass-eq-rh-zoom, echo=TRUE,tidy=TRUE}
PlantCPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-1, 500)) 

# PlantCPDzoom

PlantNPDzoom <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNPDzoom

PlantCPDzoom + PlantNPDzoom + plot_annotation(title = "Change in plant C and N content with herbivore recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

The following graph shows a heatmap of the plant C and N content plotted on a 
surface defined by the herbivore's uptake and recycling rates.

```{r vd-scenario-2-plant-biomass-eq-heatmap, echo=TRUE, tidy=TRUE, layout="l-body-outset"}
plantHeat <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, rh, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
plantHM <- plantHeat %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(Biomass) %>% 
  group_by(Nutrient, bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(Biomass),
            .groups = "keep")

meanCarbonPBhm <- filter(plantHM, Nutrient == "Carbon") %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  labs(fill = "Avg. C content") +
  theme(legend.position = "bottom")

meanNitrogenPBhm <- filter(plantHM, Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  labs(fill = "Avg. N content") +
  theme(legend.position = "bottom")

plantPdheat <- meanCarbonPBhm + meanNitrogenPBhm + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")", title = "Heatmap of average plant C and N equilibrium content", subtitle = "Top and bottom 5% data points was removed to avoid graphical artefacts") & coord_equal() & theme(legend.position = "bottom")

plantPdheat

# ggsave(filename = "../Results/BiomassHeatmap_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

#### Scenario (iii), herbivores and predators

The graph below uses the partial derivative,

$$
  \frac{\partial P^*_i}{\partial a_H}
$$

where $i \in [C, N]$, to evaluate the change in plant biomass with herbivore 
uptake rate in an ecosystem that contains both herbivores and predators.

```{r vd-scenario-3-plant-biomass-pd-ah-sp, echo=TRUE, tidy=TRUE}
plantBpdah_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N_ah,Plant_C_ah) %>%
  pivot_longer(., cols = c(Plant_N_ah:Plant_C_ah), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black", se = T) +
  ylab(expression(paste(partialdiff,P[i]^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Change in plant C and N content with herbivore uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_ah.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdah_pred
```

Next, we are plotting the value of plant biomass at equilibrium ($P^*_i$, where 
$i \in [C, N]$ ) against the values of parameter _a~H~_.

```{r vd-scenario-3-plant-biomass-eq-ah, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Plant C and N content at equilibrium against herbivore uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

Zooming into the area around `y = 0` shows strong evidence of decreasing plant 
biomass as value of herbivore uptake increase, even when predators are present 
in the system.

```{r vd-scenario-3-plant-biomass-eq-ah-zoom, echo=TRUE, tidy=TRUE}
PlantCzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(0, 500)) 

# PlantCzoom

PlantNzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ah, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[N]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNzoom

PlantCzoom_pred + PlantNzoom_pred + plot_annotation(title = "Plant C and N content at equilibrium against herbivore uptake rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Now, we move on to change in plant biomass with respect to _r~H~_, the 
herbivores' recycling rate, using the formulas:

$$
  \frac{\partial P^*_i}{\partial r_H}
$$

where $i \in [C, N]$.

```{r vd-scenario-3-plant-biomass-pd-rh, echo=TRUE, tidy=TRUE}
plantBpdrh_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh, Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black") +
  ylab(expression(paste(partialdiff,P[i]^{"*"},"/",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in Plant C and N content with herbivore recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_rh.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdrh_pred
```

As before, let us zoom in the region of the graph around the `y = 0` line.

```{r vd-scenario-3-plant-biomass-pd-rh-zoom, echo=TRUE,tidy=TRUE}
PlantCPDzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh,Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P[C]^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-50, 50)) 

# PlantCPDzoom

PlantNPDzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N_rh,Plant_C_rh) %>%
  pivot_longer(., cols = c(Plant_N_rh:Plant_C_rh), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(-0.5, 0.5)) 

# PlantNPDzoom

PlantCPDzoom_pred + PlantNPDzoom_pred + plot_annotation(title = "Change in plant C and N content with herbivore recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/BiomassPD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Next, we show the equilibrium values of plant biomass against _r~H~_.

```{r vd-scenario-3-plant-biomass-eq-rh, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Plant C and N content at equilibrium against herbivore recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

As before, the data are very much squashed against the x-axis, so we will zoom
in once again to better visualize the `y = 0` region.

```{r vd-scenario-3-plant-biomass-eq-rh-zoom, echo=TRUE,tidy=TRUE}
PlantCPDzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-1, 500)) 

# PlantCPDzoom

PlantNPDzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P^{"*"}))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNPDzoom

PlantCPDzoom_pred + PlantNPDzoom_pred + plot_annotation(title = "Change in plant C and N content with herbivore recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

The following graph shows a heatmap of the plant C and N content plotted on a 
surface defined by the herbivore's uptake and recycling rates.

```{r vd-scenario-3-plant-biomass-eq-heatmap, echo=TRUE, tidy=TRUE, layout="l-body-outset"}
plantHeat_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, rh, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
plantHM_pred <- plantHeat_pred %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(Biomass) %>% 
  group_by(Nutrient, bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(Biomass),
            .groups = "keep")

meanCarbonPBhm_pred <- filter(plantHM_pred, Nutrient == "Carbon") %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  labs(fill = "Avg. C content") +
  theme(legend.position = "bottom")

meanNitrogenPBhm_pred <- filter(plantHM_pred, Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  labs(fill = "Avg. N content") +
  theme(legend.position = "bottom")

plantPdheat_pred <- meanCarbonPBhm_pred + meanNitrogenPBhm_pred + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")", title = "Heatmap of average plant C and N equilibrium content", subtitle = "Top and bottom 5% data points was removed to avoid graphical artefacts") & coord_equal() & theme(legend.position = "bottom")

plantPdheat_pred

# ggsave(filename = "../Results/BiomassHeatmap_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

Moving on to the predator's uptake and recycling rates, we use the partial 
derivatives,

$$
  \frac{\partial P^*_i}{\partial a_R}
$$

$$
  \frac{\partial P^*_i}{\partial r_R}
$$

where $i \in [C, N]$, to evaluate the change in plant biomass with predator
uptake and recycling rates in scenario (iii).

```{r vd-scenario-3-plant-biomass-pd-ar-sp, echo=TRUE, tidy=TRUE}
plantBpdar_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, Plant_N_ar,Plant_C_ar) %>%
  pivot_longer(., cols = c(Plant_N_ar:Plant_C_ar), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = ar, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black", se = T) +
  ylab(expression(paste(partialdiff,P[i]^{"*"}," / ",partialdiff,a[R]))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  ggtitle("Change in plant C and N content with predator uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_ah.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdar_pred
```

Next, we are plotting the value of plant biomass at equilibrium ($P^*_i$, where 
$i \in [C, N]$ ) against the values of parameter _a~R~_.

```{r vd-scenario-3-plant-biomass-eq-ar, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = ar, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  ggtitle("Plant C and N content at equilibrium against predator uptake rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

Zooming into the area around `y = 0` shows strong evidence of decreasing plant 
biomass as value of herbivore uptake increase, even when predators are present 
in the system.

```{r vd-scenario-3-plant-biomass-eq-ar-zoom, echo=TRUE, tidy=TRUE}
PlantCarzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ar, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(0, 500)) 

# PlantCzoom

PlantNarzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ar, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[N]^{"*"}))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNzoom

PlantCarzoom_pred + PlantNarzoom_pred + plot_annotation(title = "Plant C and N content at equilibrium against predator uptake rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Now, we move on to change in plant biomass with respect to _r~R~_, the 
predators' recycling rate, using the formula mentioned above.

```{r vd-scenario-3-plant-biomass-pd-rr, echo=TRUE, tidy=TRUE}
plantBpdrr_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N_rr, Plant_C_rr) %>%
  pivot_longer(., cols = c(Plant_N_rr:Plant_C_rr), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black") +
  ylab(expression(paste(partialdiff,P[i]^{"*"},"/",partialdiff,r[R]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in plant C and N content with predator recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/BiomassPD_rh.svg", device = "svg", dpi = 300, width = width, height = height)

plantBpdrr_pred
```

As before, let us zoom in the region of the graph around the `y = 0` line.

```{r vd-scenario-3-plant-biomass-pd-rr-zoom, echo=TRUE,tidy=TRUE}
PlantCPDrrzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N_rr,Plant_C_rr) %>%
  pivot_longer(., cols = c(Plant_N_rr:Plant_C_rr), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P[C]^{"*"}," / ",partialdiff,r[R]))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-50, 50)) 

# PlantCPDzoom

PlantNPDrrzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N_rr,Plant_C_rr) %>%
  pivot_longer(., cols = c(Plant_N_rr:Plant_C_rr), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,P^{"*"}," / ",partialdiff,r[R]))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(-0.5, 0.5)) 

# PlantNPDzoom

PlantCPDrrzoom_pred + PlantNPDrrzoom_pred + plot_annotation(title = "Change in plant C and N content with predator recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/BiomassPD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Next, we show the equilibrium values of plant biomass against _r~R~_.

```{r vd-scenario-3-plant-biomass-eq-rr, echo=TRUE, tidy=TRUE}
EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  group_by(., Nutrient) %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.1, color = "#00BFC4") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[i]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Plant C and N content at equilibrium against predator recycling rate") +
  facet_wrap(.~Nutrient, scales = "free")

# ggsave(filename = "../Results/Biomass_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

As the data are very much squashed against the x-axis, we zoom in around 
the `y = 0` region.

```{r vd-scenario-3-plant-biomass-eq-rr-zoom, echo=TRUE,tidy=TRUE}
PlantCPDrrzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P[C]^{"*"}))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Carbon") +
  coord_cartesian(ylim = c(-1, 500)) 

# PlantCPDzoom

PlantNPDrrzoom_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, Plant_N, Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rr, y = Biomass)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "#00BFC4") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(P^{"*"}))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Nitrogen") +
  coord_cartesian(ylim = c(0, 10)) 

# PlantNPDzoom

PlantCPDrrzoom_pred + PlantNPDrrzoom_pred + plot_annotation(title = "Change in plant C and N content with predator recycling rate", tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Biomass_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

The following graph shows a heatmap of the plant C and N content plotted on a 
surface defined by the predator's uptake and recycling rates.

```{r vd-scenario-3-plant-biomass-eq-pred-heatmap, echo=TRUE, tidy=TRUE, layout="l-body-outset"}
plantHeat_aRrR_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, rr, Plant_N,Plant_C) %>%
  pivot_longer(., cols = c(Plant_N:Plant_C), 
               names_to = "EcoFunct", 
               values_to = "Biomass") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  dplyr::group_by(., Nutrient) %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(Biomass,
                        quantile(Biomass, 0.05, na.rm = T),
                        quantile(Biomass, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  mutate(., 
         bin_ar = cut_width(ar, width = 0.5, boundary = 0),
         bin_rr = cut_width(rr, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
plantHM_aRrR_pred <- plantHeat_aRrR_pred %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(Biomass) %>% 
  group_by(Nutrient, bin_ar, bin_rr) %>% 
  summarise(count = n(), 
            mean = mean(Biomass),
            .groups = "keep")

meanCarbonPBhm_aRrR_pred <- filter(plantHM_aRrR_pred, Nutrient == "Carbon") %>%
  ggplot(., aes(x = bin_ar, y = bin_rr)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[R]))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  labs(fill = "Avg. C content") +
  theme(legend.position = "bottom")

meanNitrogenPBhm_aRrR_pred <- filter(plantHM_aRrR_pred, Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = bin_ar, y = bin_rr)) +
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[R]))) +
  xlab(expression(Uptake~rate~(a[R]))) +
  labs(fill = "Avg. N content") +
  theme(legend.position = "bottom")

plantPdheat_aRrR_pred <- meanCarbonPBhm_aRrR_pred + meanNitrogenPBhm_aRrR_pred + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")", title = "Heatmap of average plant C and N equilibrium content", subtitle = "Top and bottom 5% data points was removed to avoid graphical artefacts") & coord_equal() & theme(legend.position = "bottom")

plantPdheat_aRrR_pred

# ggsave(filename = "../Results/BiomassHeatmap_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

### Primary productivity

#### Comparison across model scenarios

Moving on to Primary Productivity, first we create a graph analogous to
Figure \@ref(fig:vd-total-stock-contrast) showing the difference in primary 
productivity across the three modeling scenarios. Note that we use the C results
to estimate primary productivity.

```{r vd-pp-carbon-bp, echo=TRUE, tidy=TRUE}  
PPbp <- PrimProd %>%
  # make sure "Compartment" and "herbivore" are factors
    mutate(., 
           herbivore = as_factor(herbivore),
           herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nNo animals" = "absent", 
                                "Scenario (ii)\nHerbivore" = "herbivore", 
                                "Scenario (iii)\nHerbivore & Predator" = "predator"),) %>%
  # group by the three factors of interest
    dplyr::group_by(., herbivore) %>% 
  # filter the top and bottom 5% of data points to remove outliers
    dplyr::filter(., between(PPc, 
                          quantile(PPc, 0.05, na.rm = T), 
                          quantile(PPc, 0.95, na.rm = T)),
                  .preserve = TRUE) %>% 
  ggplot(., aes(x = herbivore, y = PPc, col = herbivore)) + 
  geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F) +
  geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
  stat_summary(geom = "label", 
               fun = quantile,
               fun.args = list(probs = 0.5),
               aes(label = round(after_stat(y), 2)),
               position = position_nudge(x = 0.19),
               show.legend = F, size = 2.5,
               label.padding = unit(0.15, "lines"),
               label.size = 0.15,
               fontface = "bold",
               color = "black") +
  ylab(expression(Primary~Productivity~(Phi[P[C]]^{"*"}))) +
  xlab(" ") +
  scale_color_met_d("Egypt", direction = 1) +
  theme(legend.position = "none") 

# ggsave(PPbp, filename = "../Results/PrimProd_bp.svg", device = "svg", dpi = 300)

PPbp
```

Below, we explore these results further by focusing on scenarios (ii) and (iii) 
one at the time.

#### Scenario (ii), herbivores-only

Here, we plot the value of Primary Productivity at equilibrium 
($\Phi^*_P$) against the values of parameters _a~H~_ and _r~H~_.

```{r vd-scenario-2-prim-prod-herb-eq, echo=TRUE, tidy=TRUE}
PPeqplot <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, rh, PPc) %>%
  pivot_longer(., cols = c(ah:rh),
               names_to = "HParameter",
               values_to = "Value") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         HParameter = as_factor(HParameter),
         HParameter = fct_recode(.f = HParameter, "a[H]" = "ah", "r[H]" = "rh"),
         PPsign = ifelse(PPc >= 0, "pos", "neg"),
         PPsign = as_factor(PPsign),
         PPsign = fct_relevel(.f = PPsign, "pos", "neg")) %>%
  group_by(., HParameter) 

PPeqplot %>%
  ggplot(., aes(x = Value, y = PPc)) +
  geom_point(aes(color = PPsign, alpha = PPsign), shape = 21, stroke = 1.5) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_manual(values = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black", lwd = 0.5) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(" ") +
  ggtitle("Primary productivity at equilibrium against herbivore uptake and recycling rate") +
  facet_wrap(.~HParameter, scales = "free", labeller = label_parsed) +
  guides(alpha = FALSE, color = FALSE)

# ggsave(filename = "../Results/PP_eq.svg", device = "svg", dpi = 300, width = width, height = height)
```

And a zoomed-in version, to better see those < 0 points. Note that here we remove
the trend lines as the constraints on the y-xis would cause them to produce 
graphical artefacts. 

```{r vd-scenario-2-prim-prod-eq-zoom, echo=TRUE, tidy=TRUE}
PPeqplot %>%
  ggplot(., aes(x = Value, y = PPc)) +
  geom_smooth(data = subset(PPeqplot, PPc < 0 & PPc > -800), color = "#944641") +
  geom_smooth(data = subset(PPeqplot, PPc >= 0 & PPc < 800), color = "black") +
  geom_point(aes(color = PPsign, 
                 alpha = PPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_manual(values = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(" ") +
  coord_cartesian(ylim = c(-750, 750)) +
  ggtitle("Primary productivity at equilibrium against herbivore uptake and recycling rate") +
  facet_wrap(.~HParameter, scales = "free", labeller = label_parsed) +
  guides(alpha = FALSE, color = FALSE)

# ggsave(filename = "../Results/PP_eq.svg", device = "svg", dpi = 300, width = width, height = height)
```

The heatmap below shows the distribution of average Primary Productivity values 
with the herbivores' uptake and recycling rates, for scenario (ii). Note that we
removed the top and bottom 5% of average primary productivity values to avoid 
graphical artefacts.

```{r vd-scenario-2-prim-prod-herb-hm, echo=TRUE, tidy=TRUE}
# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
PPheat <- dplyr::select(EcoFunctPD, herbivore, TIME, ah, rh, PPc) %>%
  filter(., herbivore == "herbivore",
         between(PPc,
                 quantile(PPc, 0.05, na.rm = T),
                 quantile(PPc, 0.95, na.rm = T))) %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0)) %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  group_by(bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(PPc),
            .groups = "keep") 

PPheatmap <- PPheat %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Recycling~rate~(r[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  labs(fill = "Primary Productivity") +
  ggtitle("Heatmap of average Primary Productivity at equilibrium", subtitle = "Herbivore present. Top and bottom 5% values removed.") +
  coord_equal()

PPheatmap
```

The next figure shows the change in Primary Production as a 
function of _a~H~_, for both C and N, as calculated using partial derivatives.

```{r vd-scenario-2-prim-prod-pd-ah, echo=TRUE, tidy=TRUE}
dPPah <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, ah, PP_N_ah, PP_C_ah) %>%
  pivot_longer(., cols = c(PP_N_ah, PP_C_ah), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP >= 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "neg", "pos"))

dPPah %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  scale_alpha_discrete(range = c(0.75, 1)) +
  geom_point(data = subset(dPPah, dPPsign == "pos"), color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~herbivore~uptake~rate~(a[H]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

The data are hugging the top of the graph quite tight, so we will zoom in again 
to better see the region around the `y = 0` line.

```{r vd-scenario-2-prim-prod-pd-ah-zoom, echo=TRUE,tidy=TRUE}
dPPahCzoom <- dPPah %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_smooth(data = subset(dPPah, dPP <= 0 & dPP > -1000), color = "black") +
  geom_smooth(data = subset(dPPah, dPP > 0 & dPP < 1000), color = "#007275") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPPahNzoom <- dPPah %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_smooth(data = subset(dPPah, dPP <= 0 & dPP > -1000), color = "black") +
  geom_smooth(data = subset(dPPah, dPP > 0 & dPP < 1000), color = "#007275") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPPahCzoom + dPPahNzoom + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Likewise, the graph below shows the results for the change in Primary Production
with _r~H~_.

```{r vd-scenario-2-prim-prod-pd-rh, echo=TRUE, tidy=TRUE}
dPPrh <- EcoFunctPD %>%
  dplyr::select(., herbivore, TIME, rh, PP_N_rh,PP_C_rh) %>%
  pivot_longer(., cols = c(PP_N_rh:PP_C_rh), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP > 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "pos", "neg"))

dPPrh %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.75, 1)) +
  geom_point(data = subset(dPPrh, dPPsign == "neg"), color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~herbivore~recycling~rate~(r[H]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

And, as before, we will now zoom into the area of the graph around the `y = 0` 
line. 

```{r vd-scenario-2-prim-prod-pd-rh-zoom, echo=TRUE,tidy=TRUE, message=FALSE}
dPPrhCzoom <- dPPrh %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_smooth(data = subset(dPPrh, dPP <= 0 & dPP > -1000), color = "#944641") +
  geom_smooth(data = subset(dPPrh, dPP > 0 & dPP < 1000), color = "black") +
  geom_point(aes(color = dPPsign, alpha = dPPsign),
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  coord_cartesian(ylim = c(-1500, 1500)) +
  guides(alpha = FALSE, color = FALSE)

dPPrhNzoom <- dPPrh %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_smooth(data = subset(dPPrh, dPP <= 0 & dPP > -1000), color = "#944641") +
  geom_smooth(data = subset(dPPrh, dPP > 0 & dPP < 1000), color = "black") +
  geom_point(aes(color = dPPsign, alpha = dPPsign),
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  coord_cartesian(ylim = c(-1500, 1500)) +
  guides(alpha = FALSE, color = FALSE)

dPPrhCzoom + dPPrhNzoom + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

#### Scenario (iii), herbivores and predators

Here, we investigate the change in $\Phi^*_P$ under the influence of parameters 
_a~H~_, _a~R~_, _r~R~_, and _r~R~_---that is, the uptake (_a~i~_) and recycling 
(_r~i~_) rates of the animals in this scenario.

```{r vd-scenario-3-prim-prod-pred-eq, echo=TRUE, tidy=TRUE}
PPpredeqplot <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, ah, rr, rh, PPc) %>%
  pivot_longer(., cols = c(ar:rh),
               names_to = "PredParameter",
               values_to = "Value") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         PredParameter = as_factor(PredParameter),
         PredParameter = fct_recode(.f = PredParameter, 
                                    "a[R]" = "ar",
                                    "a[H]" = "ah",
                                    "r[R]" = "rr",
                                    "r[H]" = "rh")) %>%
  group_by(., PredParameter) 

PPpredeqplot %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(.,
                PredParameter == "a[R]" |
                PredParameter == "r[R]") %>%
  ggplot(., aes(x = Value, y = PPc)) +
  geom_point(color = "grey", alpha = 0.5, shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black") +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(" ") +
  ggtitle("Primary productivity at equilibrium against predator uptake and recycling rate") +
  facet_wrap(.~PredParameter, scales = "free", labeller = label_parsed) +
  guides(alpha = FALSE, color = FALSE)

# ggsave(filename = "../Results/PP_eq.svg", device = "svg", dpi = 300, width = width, height = height)
```

And here, for comparison, is the change in primary productivity with _a~H~_ and 
_r~H~_ in the model with herbivores and predators.

```{r vd-scenario-3-prim-prod-pred-eq-zoom, echo=TRUE, tidy=TRUE}
PPpredeqplot %>%
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(.,
                PredParameter == "a[H]" |
                PredParameter == "r[H]") %>%
  ggplot(., aes(x = Value, y = PPc)) +
  geom_point(color = "grey", alpha = 0.5, shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  geom_smooth(color = "black") +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(" ") +
  ggtitle("Primary productivity at equilibrium against herbivore uptake and recycling rate") +
  facet_wrap(.~PredParameter, scales = "free", labeller = label_parsed) +
  guides(alpha = FALSE, color = FALSE)

# ggsave(filename = "../Results/PP_eq.svg", device = "svg", dpi = 300, width = width, height = height)
```

The heatmap below shows the distribution of average Primary Productivity values 
with the predators' uptake and recycling rates, for scenario (ii). Note that 
we removed the top and bottom 5% of average Primary Productivity values to avoid
graphical artefacts.

```{r vd-scenario-3-prim-prod-pred-hm, echo=TRUE, tidy=TRUE}
# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
predPPheat <- dplyr::select(EcoFunctPD_pred, herbivore, TIME, ar, rr, PPc) %>%
  filter(., herbivore == "predator",
         between(PPc,
                 quantile(PPc, 0.05, na.rm = T),
                 quantile(PPc, 0.95, na.rm = T))) %>%
  mutate(., 
         bin_ar = cut_width(ar, width = 0.5, boundary = 0),
         bin_rr = cut_width(rr, width = 0.5, boundary = 0)) %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  group_by(bin_ar, bin_rr) %>% 
  summarise(count = n(), 
            mean = mean(PPc),
            .groups = "keep") 

predPPheatmap <- predPPheat %>%
  ggplot(., aes(x = bin_ar, y = bin_rr)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Predator~recycling~rate~(r[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  labs(fill = "Primary Productivity") +
  ggtitle("Heatmap of average Primary Productivity at equilibrium", subtitle = "Herbivores and predators present. Top and bottom 5% values removed.") +
  coord_equal()

predPPheatmap
```

And, for comparison, the heatmap below shows the change in average primary 
productivity with increasing values of herbivore uptake and recycling rates.

```{r vd-scenario-3-prim-prod-herb-hm, echo=TRUE, tidy=TRUE}
# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
herbPPheat <- dplyr::select(EcoFunctPD_pred, herbivore, TIME, ah, rh, PPc) %>%
  filter(., herbivore == "predator",
         between(PPc,
                 quantile(PPc, 0.05, na.rm = T),
                 quantile(PPc, 0.95, na.rm = T))) %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0)) %>% 
  # dropping NAs in the value of DeltaNEP allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  group_by(bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(PPc),
            .groups = "keep") 

herbPPheatmap <- herbPPheat %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Herbivore~recycling~rate~(r[H]))) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  labs(fill = "Primary Productivity") +
  ggtitle("Heatmap of average Primary Productivity at equilibrium", subtitle = "Herbivores and predators present. Top and bottom 5% values removed.") +
  coord_equal()

herbPPheatmap
```

The next figure shows the results for the change in Primary Production as a 
function of _a~R~_, for both C and N.

```{r vd-scenario-3-prim-prod-pd-ar, echo=TRUE, tidy=TRUE}
dPPar <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, PP_N_ar, PP_C_ar) %>%
  pivot_longer(., cols = c(PP_N_ar, PP_C_ar), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP > 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "neg", "pos"))

dPPar %>%
  ggplot(., aes(x = ar, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = desc(dPPsign)), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_point(data = subset(dPPar, dPPsign == "pos"), color = "#00BFC4", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,a[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  scale_alpha_continuous(range = c(0.5,0.25)) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~predator~uptake~rate~(a[R]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

The data are hugging the top of the graph quite tight, so we will zoom in again 
to better see the region around the `y = 0` line.

```{r vd-scenario-3-prim-prod-pd-ar-zoom, echo=TRUE,tidy=TRUE}
dPParCzoom <- dPPar %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ar, y = dPP)) +
  geom_smooth(data = subset(dPPar, dPP <= 0 & dPP > -1000), color = "black") +
  geom_smooth(data = subset(dPPar, dPP > 0 & dPP <= 1000), color = "#007275") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_point(data = subset(dPPar, dPPsign == "pos"), 
             color = "#00BFC4", shape = 21, stroke = 1) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPParNzoom <- dPPar %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ar, y = dPP)) +
  geom_smooth(data = subset(dPPar, dPP <= 0 & dPP > -1000), color = "black") +
  geom_smooth(data = subset(dPPar, dPP > 0 & dPP <= 1000), color = "#007275") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_point(data = subset(dPPar, dPPsign == "pos"), 
             color = "#00BFC4", shape = 21, stroke = 1) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPParCzoom + dPParNzoom + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Likewise, the graph below shows the results for the change in Primary Production
with _r~R~_.

```{r vd-scenario-3-prim-prod-pd-rr, echo=TRUE, tidy=TRUE}
dPPrr <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, PP_N_rr,PP_C_rr) %>%
  pivot_longer(., cols = c(PP_N_rr:PP_C_rr), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP > 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "pos", "neg"))

dPPrr %>%
  ggplot(., aes(x = rr, y = dPP)) +
  geom_point(aes(color = dPPsign, 
                 alpha = desc(dPPsign)), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_point(data = subset(dPPrr, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,r[R]))) +
  xlab(expression(Predator~recycling~rate~(r[R]))) +
  scale_alpha_continuous(range = c(0.5,0.25)) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~predator~recycling~rate~(r[R]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

And, as before, we will now zoom into the area of the graph around the `y = 0` 
line. 

```{r vd-scenario-3-prim-prod-pd-rr-zoom, echo=TRUE,tidy=TRUE, message=FALSE}
dPPrrCzoom <- dPPrr %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rr, y = dPP)) +
  geom_smooth(data = subset(dPPrr, dPP >= 0 & dPP < 1000), color = "black") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_smooth(data = subset(dPPrr, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_point(data = subset(dPPrr, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[R]))) +
  xlab(expression(Predator~recycling~rate~(r[R]))) +
  coord_cartesian(ylim = c(-1000, 1000)) +
  guides(alpha = FALSE, color = FALSE)

dPPrrNzoom <- dPPrr %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rr, y = dPP)) +
  geom_smooth(data = subset(dPPrr, dPP >= 0 & dPP < 1000), color = "black") +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_smooth(data = subset(dPPrr, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_point(data = subset(dPPrr, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[R]))) +
  xlab(expression(Predator~recycling~rate~(r[R]))) +
  coord_cartesian(ylim = c(-1000, 1000)) +
  guides(alpha = FALSE, color = FALSE)

dPPrrCzoom + dPPrrNzoom + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

For comparison, below we show the results of partial derivatives for primary 
productivity w.r.t. _a~H~_ and _r~R~_ for the scenario with herbivores and predators.

```{r vd-scenario-3-pred-prim-prod-pd-ah, echo=TRUE, tidy=TRUE}
dPPah_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, PP_N_ah, PP_C_ah) %>%
  pivot_longer(., cols = c(PP_N_ah, PP_C_ah), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP > 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "pos", "neg"))

dPPah_pred %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 1) +
  geom_point(data = subset(dPPah_pred, dPPsign == "neg"), color = "#F8766D", shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,a[H]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~herbivore~uptake~rate~(a[H]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_ah.svg", device = "svg", dpi = 300, width = width, height = height)
```

The data are hugging the top of the graph quite tight, so we will zoom in again 
to better see the region around the `y = 0` line.

```{r vd-scenario-3-pred-prim-prod-pd-ah-zoom, echo=TRUE,tidy=TRUE}
dPPahCzoom_pred <- dPPah_pred %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPah_pred, dPP > 0 & dPP <= 1000), color = "black") +
  geom_point(data = subset(dPPah_pred, dPPsign == "neg"), color = "#F8766D", shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPah_pred, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_line(aes(y = 0), lty = 2) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPPahNzoom_pred <- dPPah_pred %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPah_pred, dPP > 0 & dPP <= 1000), color = "black") +
  geom_point(data = subset(dPPah_pred, dPPsign == "neg"), color = "#F8766D", shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPah_pred, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_line(aes(y = 0), lty = 2) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,a[H]))) +
  xlab(expression(Herbivore~uptake~rate~(a[R]))) +
  coord_cartesian(ylim = c(-1000, 1000), expand = F) +
  guides(alpha = FALSE, color = FALSE)

dPPahCzoom_pred + dPPahNzoom_pred + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_ah_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

Likewise, the graph below shows the results for the change in Primary Production
with _r~H~_.

```{r vd-scenario-3-pred-prim-prod-pd-rh, echo=TRUE, tidy=TRUE}
dPPrh_pred <- EcoFunctPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, PP_N_rh, PP_C_rh) %>%
  pivot_longer(., cols = c(PP_N_rh:PP_C_rh), 
               names_to = "EcoFunct", 
               values_to = "dPP") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
  separate_wider_delim(., cols = "EcoFunct", 
                       names = c("EcoFunct", "Nutrient", "Variable"), 
                       delim = "_") %>%
  # make sure "Nutrient" and "Variable" are factors
  mutate(.,
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen"),
         dPPsign = ifelse(dPP >= 0, "pos", "neg"),
         dPPsign = as_factor(dPPsign),
         dPPsign = fct_relevel(.f = dPPsign, "pos", "neg"))

dPPrh_pred %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, 
                 alpha = dPPsign), 
             shape = 21, stroke = 1) +
  geom_point(data = subset(dPPrh_pred, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,Phi[P]^{"*"},"/",partialdiff,r[H]))) +
  xlab(expression(Herbivore~recycling~rate~(r[H]))) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.5,1)) +
  ggtitle(expression(Change~"in"~Primary~Productivity~with~herbivore~recycling~rate~(r[H]))) +
  facet_wrap(.~Nutrient, scales = "free") +
  guides(color = "none", alpha = "none")

# ggsave(filename = "../Results/PP_PD_rh.svg", device = "svg", dpi = 300, width = width, height = height)
```

And, as before, we will now zoom into the area of the graph around the `y = 0` 
line. 

```{r vd-scenario-3-pred-prim-prod-pd-rh-zoom, echo=TRUE,tidy=TRUE, message=FALSE}
dPPrhCzoom_pred <- dPPrh_pred %>% 
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPrh_pred, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_smooth(data = subset(dPPrh_pred, dPP >= 0 & dPP < 1000), color = "black") +
  scale_alpha_discrete(range = c(0.5,1)) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Herbivores~recycling~rate~(r[H]))) +
  coord_cartesian(ylim = c(-1000, 1000)) +
  guides(alpha = FALSE, color = FALSE)

dPPrhNzoom_pred <- dPPrh_pred %>% 
  filter(., Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), 
             shape = 21, stroke = 1) +
  geom_smooth(data = subset(dPPrh_pred, dPP < 0 & dPP > -1000), color = "#944641") +
  geom_smooth(data = subset(dPPrh_pred, dPP >= 0 & dPP < 1000), color = "black") +
  scale_alpha_discrete(range = c(0.5,1)) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,PP^{"*"}," / ",partialdiff,r[H]))) +
  xlab(expression(Herbivore~recycling~rate~(r[H]))) +
  coord_cartesian(ylim = c(-1000, 500)) +
  guides(alpha = FALSE, color = FALSE)

dPPrhCzoom_pred + dPPrhNzoom_pred + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PP_PD_rh_zoom.svg", device = "svg", dpi = 300, width = width, height = height)
```

### Net Ecosystem Carbon Balance

Below we investigate graphically the NECB results. The NECB equation we used is

$$
  NECB = Net~Primary~Production + Net~Heterotrophic~Production
$$

#### Comparison across model scenarios

We start by taking a look at the values of NECB at equilibrium across the three
modeling scenarios. The figure below shows the same summary statistics shown in 
the table above.

```{r vd-necb-eq-bp, echo=TRUE, tidy=TRUE, fig.cap="Difference in Net Ecosystem Carbon Balance at equilibrium across the the three modeling scenarios: (i) no animals in the ecosystem, (ii) only herbivores in the ecosystem, (iii) herbivores and predators in the ecosystem."}  
NECBbp <- NECBres %>% 
  mutate(.,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (ii)\nHerbivore" = "Herbivore", 
                                "Scenario (i)\nSoil-Plants" = "Absent", 
                                "Scenario (iii)\nHerbivores & Predator" = "Predator")) %>%
  ggplot(., aes(x = herbivore, y = NECB, col = herbivore)) + 
  geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, fatten = 4, nudge = 0.05) +
  geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
  ylab("NECB") +
  xlab(" ") +
  scale_color_met_d("Egypt", direction = 1) +
  theme(legend.position = "none") 

# ggsave(NECBbp, filename = "../Results/NECBboxplot.svg", device = "svg", dpi = 300)

NECBbp
```

The graph below shows the same NECB values, standardized to the total C biomass
in the system.

```{r vd-necb-eq-bp-std, echo=TRUE, tidy=TRUE, fig.cap="Equilibrium NECB standardized against total C content of ecosystems, across modeling scenarios."}
NECBres %>%
  mutate(., 
         NECB_std = NECB/Total_C,
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (ii)\nHerbivore" = "Herbivore", 
                                "Scenario (i)\nSoil-Plants" = "Absent", 
                                "Scenario (iii)\nPredator" = "Predator")) %>%
  ggplot(., aes(x = herbivore, y = NECB_std, col = herbivore)) + 
  geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05, fatten = 4) +
  geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
  ylab("NECB standardized by Total C") +
  xlab(" ") +
  guides(color = guide_legend(title = "Modeling scenario")) +
  scale_color_met_d("Egypt", direction = 1) +
  theme(legend.position = "none",
        text = element_text(size = 14)) 

# ggsave(filename = "../Results/NECB_STD.svg", device = "svg", dpi = 300)
```

The next two graphs focus on scenario (ii), to investigate how NECB
varies with the herbivores' uptake and recycling rates. The first one is a 
boxplot that shows the values of NECB when herbivores are present in the system, 
binned by the values of parameters _a~H~_ and _r~H~_. 

```{r vd-necb-eq-bp-herb-paired, echo=TRUE, tidy=TRUE}  
NECBres %>%
  filter(., herbivore == "Herbivore") %>%
  select(., herbivore, TIME, ah, rh, NECB) %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 2, boundary = 0),
         bin_rh = cut_width(rh, width = 2, boundary = 0)) %>%
  pivot_longer(., cols = c(bin_ah, bin_rh), names_to = "BinName", values_to = "BinVal") %>% 
  mutate(., BinName = as_factor(BinName)) %>%
  ggplot(., aes(x = BinVal, y = NECB, col = BinName)) + 
  geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05) +
  geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
  ylab("NECB") +
  xlab(" ") +
  scale_color_met_d("Egypt", direction = 1) +
  labs(colour = "Parameter") +
  theme(legend.position = "top",
        text = element_text(size = 20)) 

# ggsave(filename = "../Results/NECBjitter.svg", device = "svg", dpi = 300)
```

Next, is a heatmap showing the change in NECB with increasing values of herbivore
uptake ( _a~H~_ ) and recycling rate ( _r~H~_ ). Note that NECB values are 
binned by _a~H~_ and _r~H~_ value so that the hue of each bin corresponds to the 
**average** NECB value for that bin.

```{r vd-necb-eq-herb-heatmap, echo=TRUE, tidy=TRUE, fig.cap = "Heatmap of the average value of NECB as herbivores' uptake (a~H~) and recycling rate (r~H~) increase. NECB was calculated as the algebraic sum of Net Primary Productivity and Net Heterotrophic Productivity, and the top and bottom 5% values were removed prior to plotting to avoid graphical artefacts. Axes labels show the lower value of each bin."}
avgNECBherb <- NECBres %>%
  filter(., herbivore == "Herbivore",
         between(NECB,
                 quantile(NECB, 0.05, na.rm = T),
                 quantile(NECB, 0.95, na.rm = T)),
         .preserve = TRUE
         ) %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
herbNECBheatmap <- avgNECBherb %>% 
  # dropping NAs in the value of DeltaNECB allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(NECB) %>% 
  group_by(bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(NECB),
            .groups = "keep")


herbNECBhm <- herbNECBheatmap %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Herbivore~recycling~rate~(r[H]))) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  labs(fill = "Avg.\nNECB") +
  coord_equal() 

# ggsave("../Results/NECBheath.svg", device = "svg", dpi = 300)

herbNECBhm
```

Similarly, the next two graphs focus on scenario (iii), to show how NECB varies 
with the predators' uptake (_a~R~_) and recycling (_r~R~_) rates. As before, the
following boxplot shows changes in NECB by increasing _a~R~_ amd _r~R~_ value 
(binned).

```{r vd-necb-eq-bp-pred-paired, echo=TRUE, tidy=TRUE}  
NECBres %>%
  filter(., herbivore == "Predator") %>%
  select(., herbivore, TIME, ar, rr, NECB) %>%
  mutate(., 
         bin_ar = cut_width(ar, width = 2, boundary = 0),
         bin_rr = cut_width(rr, width = 2, boundary = 0)) %>%
  pivot_longer(., cols = c(bin_ar, bin_rr), names_to = "BinName", values_to = "BinVal") %>% 
  mutate(., BinName = as_factor(BinName)) %>%
  ggplot(., aes(x = BinVal, y = NECB, col = BinName)) + 
  geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05) +
  geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
  ylab("NECB") +
  xlab(" ") +
  scale_color_met_d("Egypt", direction = 1) +
  labs(colour = "Parameter") +
  theme(legend.position = "top",
        text = element_text(size = 20)) 

# ggsave(filename = "../Results/NECBjitter.svg", device = "svg", dpi = 300)
```

The heatmap below shows the change in NECB with increasing values of _a~R~_ and
_r~R~_. Note that, as before, NECB values are binned by _a~R~_ and _r~R~_ value 
so that the hue of each bin corresponds to the **average** NECB value for that bin.

```{r vd-necb-eq-pred-heatmap-ar-rr, echo=TRUE, tidy=TRUE, fig.cap = "Heatmap of the average value of NECB as predators' uptake (a~R~) and recycling rate (r~R~) increase. NECB was calculated as the algebraic sum of Net Primary Productivity and Net Heterotrophic Productivity, and the top and bottom 5% values were removed prior to plotting to avoid graphical artefacts. Axes labels show the lower value of each bin."}
avgNECBpred <- NECBres %>%
  filter(., herbivore == "Predator",
         between(NECB,
                 quantile(NECB, 0.05, na.rm = T),
                 quantile(NECB, 0.95, na.rm = T)),
         .preserve = TRUE
         ) %>%
  mutate(., 
         bin_ar = cut_width(ar, width = 0.5, boundary = 0),
         bin_rr = cut_width(rr, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
predNECBheatmap <- avgNECBpred %>% 
  # dropping NAs in the value of DeltaNECB allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(NECB) %>% 
  group_by(bin_ar, bin_rr) %>% 
  summarise(count = n(), 
            mean = mean(NECB),
            .groups = "keep")

predNECBhm <- predNECBheatmap %>%
  ggplot(., aes(x = bin_ar, y = bin_rr)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c(option = "magma") +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Predator~recycling~rate~(r[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  labs(fill = "Avg.\nNECB") +
  coord_equal() 

# ggsave("../Results/NECBheath.svg", device = "svg", dpi = 300)

predNECBhm
```

For comparison, the heatmap below shows average NECB for binned values of 
herbivores' uptake and recycling rates.

```{r vd-necb-eq-pred-heatmap-ah-rh, echo=TRUE, tidy=TRUE, fig.cap = "Heatmap of the average value of NECB as herbivores' uptake (a~H~) and recycling rate (r~H~) increase. NECB was calculated as the algebraic sum of Net Primary Productivity and Net Heterotrophic Productivity, and the top and bottom 5% values were removed prior to plotting to avoid graphical artefacts. Axes labels show the lower value of each bin."}
avgNECBpred_herb <- NECBres %>%
  filter(., herbivore == "Predator",
         between(NECB,
                 quantile(NECB, 0.05, na.rm = T),
                 quantile(NECB, 0.95, na.rm = T)),
         .preserve = TRUE
         ) %>%
  mutate(., 
         bin_ah = cut_width(ah, width = 0.5, boundary = 0),
         bin_rh = cut_width(rh, width = 0.5, boundary = 0))

# create a dataframe of the number of observations into each bin, will use it to label each tile in heatmap
predNECBheatmap_herb <- avgNECBpred_herb %>% 
  # dropping NAs in the value of DeltaNECB allows for the heatmap to correctly show tiles for bins that would otherwise be classified as NA
  drop_na(NECB) %>% 
  group_by(bin_ah, bin_rh) %>% 
  summarise(count = n(), 
            mean = mean(NECB),
            .groups = "keep")

predNECBhm_herb <- predNECBheatmap_herb %>%
  ggplot(., aes(x = bin_ah, y = bin_rh)) + 
  geom_tile(aes(fill = mean)) +
  scale_fill_viridis_c() +
  scale_y_discrete(labels = seq(0,10,0.5)) +
  scale_x_discrete(labels = seq(0,10,0.5)) +
  ylab(expression(Herbivore~recycling~rate~(r[H]))) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  labs(fill = "Avg.\nNECB") +
  coord_equal() 

# ggsave("../Results/NECBheath.svg", device = "svg", dpi = 300)

predNECBhm_herb
```

#### Scenario (ii)---change in NECB with herbivory

Moving on to the results of the partial derivatives for NECB, the next graph 
shows the results for the change in NECB as a function of _a~H~_.

```{r vd-scenario-2-necb-pd-ah, echo=TRUE, tidy=TRUE}
dNECBah <- NECBPD %>%
  dplyr::select(., herbivore, TIME, ah, NECB_ah) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_ah,
                        quantile(NECB_ah, 0.05, na.rm = T),
                        quantile(NECB_ah, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = ah, y = NECB_ah)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Change in NECB with herbivore uptake rate")

# ggsave(filename = "../Results/NECB_ah.svg", device = "svg", dpi = 300)

dNECBah
```

And a zoomed-in version.

```{r vd-scenario-2-necb-pd-ah-zoom, echo=TRUE, tidy=TRUE}
NECBPD %>%
  dplyr::select(., herbivore, TIME, ah, NECB_ah) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_ah,
                        quantile(NECB_ah, 0.05, na.rm = T),
                        quantile(NECB_ah, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = ah, y = NECB_ah)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Change in NECB with herbivore uptake rate") +
  coord_cartesian(ylim=c(-500,500))

# ggsave(filename = "../Results/NECB_ah_zoom.svg", device = "svg", dpi = 300)
```

Likewise, the graph below shows the results for the change in NECB with _r~H~_.

```{r vd-scenario-2-necb-pd-rh, echo=TRUE, tidy=TRUE}
dNECBrh <- NECBPD %>%
  dplyr::select(., herbivore, TIME, rh, NECB_rh) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rh,
                        quantile(NECB_rh, 0.05, na.rm = T),
                        quantile(NECB_rh, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rh, y = NECB_rh)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") + 
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in NECB with herbivore recycling rate")

# ggsave(filename = "../Results/NECB_rh.svg", device = "svg", dpi = 300)

dNECBrh
```

And a zoomed-in version for this one too.

```{r vd-scenario-2-necb-new-pd-rh-zoom, echo=TRUE, tidy=TRUE}
NECBPD %>%
  dplyr::select(., herbivore, TIME, rh, NECB_rh) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rh,
                        quantile(NECB_rh, 0.05, na.rm = T),
                        quantile(NECB_rh, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rh, y = NECB_rh)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in NECB with herbivore recycling rate") +
  coord_cartesian(ylim=c(-100,1000))

# ggsave(filename = "../Results/NECB_rh_zoom.svg", device = "svg", dpi = 300)
```

#### Scenario (iii)---change in NECB with herbivory and predation

Moving on to the results of scenario (iii), the next figure shows the change in 
NECB as a function of _a~R~_.

```{r vd-scenario-3-necb-pd-ar, echo=TRUE, tidy=TRUE}
dNECBar <- NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, NECB_ar) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_ar,
                        quantile(NECB_ar, 0.05, na.rm = T),
                        quantile(NECB_ar, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = ar, y = NECB_ar)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,a[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  ggtitle("Change in NECB with predator uptake rate")

# ggsave(filename = "../Results/NECB_ar.svg", device = "svg", dpi = 300)

dNECBar
```

And a zoomed-in version.

```{r vd-scenario-3-necb-pd-ar-zoom, echo=TRUE, tidy=TRUE}
NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, ar, NECB_ar) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_ar,
                        quantile(NECB_ar, 0.05, na.rm = T),
                        quantile(NECB_ar, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = ar, y = NECB_ar)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,a[R]))) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  ggtitle("Change in NECB with predator uptake rate") +
  coord_cartesian(ylim=c(-500,500))

# ggsave(filename = "../Results/NECB_ah_zoom.svg", device = "svg", dpi = 300)
```

Likewise, the graph below shows the results for the change in NECB with _r~R~_.

```{r vd-scenario-3-necb-pd-rr, echo=TRUE, tidy=TRUE}
dNECBrr <- NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, NECB_rr) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rr,
                        quantile(NECB_rr, 0.05, na.rm = T),
                        quantile(NECB_rr, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rr, y = NECB_rr)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") + 
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[R]))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Change in NECB with predator recycling rate")

# ggsave(filename = "../Results/NECB_rr.svg", device = "svg", dpi = 300)

dNECBrr
```

And a zoomed-in version for this one too.

```{r vd-scenario-3-necb-new-pd-rr-zoom, echo=TRUE, tidy=TRUE}
NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, rr, NECB_rr) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rr,
                        quantile(NECB_rr, 0.05, na.rm = T),
                        quantile(NECB_rr, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rr, y = NECB_rr)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[R]))) +
  xlab(expression(Recycling~rate~(r[R]))) +
  ggtitle("Change in NECB with predator recycling rate") +
  coord_cartesian(ylim=c(-100,1000))

# ggsave(filename = "../Results/NECB_rh_zoom.svg", device = "svg", dpi = 300)
```

For comparison, the graphs below shows NECB change with _a~H~_ in scenario (iii).

```{r vd-scenario-3-necb-pd-ah, echo=TRUE, tidy=TRUE}
NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, ah, NECB_ah) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_ah,
                        quantile(NECB_ah, 0.05, na.rm = T),
                        quantile(NECB_ah, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = ah, y = NECB_ah)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,a[H]))) +
  xlab(expression(Uptake~rate~(a[H]))) +
  ggtitle("Change in NECB with herbivore uptake rate")

# ggsave(filename = "../Results/NECB_ah.svg", device = "svg", dpi = 300)
```

Likewise, compare the graph below showing the change in NECB with _r~H~_ with 
the one above showing change with _r~R~_.

```{r vd-scenario-3-necb-pd-rh, echo=TRUE, tidy=TRUE}
NECBPD_pred %>%
  dplyr::select(., herbivore, TIME, rh, NECB_rh) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rh,
                        quantile(NECB_rh, 0.05, na.rm = T),
                        quantile(NECB_rh, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rh, y = NECB_rh)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_smooth(color = "black") + 
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in NECB with herbivore recycling rate")

# ggsave(filename = "../Results/NECB_rh.svg", device = "svg", dpi = 300)
```

And a zoomed-in version for this one too.

```{r vd-scenario-3-necb-new-pd-rh-zoom, echo=TRUE, tidy=TRUE}
NECBPD %>%
  dplyr::select(., herbivore, TIME, rh, NECB_rh) %>% 
  # filter the top and bottom 5% of data points to remove outliers
  dplyr::filter(., 
                between(NECB_rh,
                        quantile(NECB_rh, 0.05, na.rm = T),
                        quantile(NECB_rh, 0.95, na.rm = T)),
                .preserve = TRUE) %>%
  ungroup() %>%
  ggplot(., aes(x = rh, y = NECB_rh)) +
  geom_point(shape = 21, stroke = 1, alpha = 0.25, color = "grey") +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(paste(partialdiff,"NECB"," / ",partialdiff,r[H]))) +
  xlab(expression(Recycling~rate~(r[H]))) +
  ggtitle("Change in NECB with herbivore recycling rate") +
  coord_cartesian(ylim=c(-100,1000))

# ggsave(filename = "../Results/NECB_rh_zoom.svg", device = "svg", dpi = 300)
```

Next, we will produce graphs to investigate [Relative Parameter Importance] for 
each parameter in the model in determining the results of the model simulations.
These graphs will use the results from the [Sensitivity analyses] 
performed above, converted into a relative measure of each parameter importance
in the model to the sum total of the importance of all parameters 
(sensu @Harper2011;@Bellmore2014). 

## Relative Parameter Importance

Here, we produce graphs to show the results from our [Sensitivity analyses] run 
on the equilibrium stock values of the three modeling scenarios. First, we 
create a dataframe object containing the relative importance results for each 
parameter for each scenario. We use the results obtained from our "by-compartment"
GSA, rather than those from our "whole-model" GSA (see above for details).

```{r vd-rii-setup, echo=TRUE, tidy=TRUE}
pairedRI <- bind_rows(noherbGSA, herbGSA, predGSA, .id = "Scenario") %>%
  # pivot to wider format, so we get NAs where scenarios are missing parameter values (because the parameters do not feature in the scenario's equilibria)
  pivot_wider(., names_from = "Scenario", values_from = "RelImpI") %>% 
  # rename the scenarios using clearer names
  rename(.,  "sl_plnt" = "1", "sl_plnt_hbvr" = "2", "sl_plnt_hbvr_prdt" = "3") %>%
  # separate column SV (State Variable) into its components, i.e., Compartment and Nutrient
  separate(., col = SV, into = c("Compartment", "Nutrient"), sep = "_") %>% 
  # modify the structure of the dataframe to have Compartment and Nutrient as factors, and change levels of Nutrient to full element names
  mutate(.,
         Compartment = as_factor(Compartment),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>% 
  # now pivot to longer format for plotting with ggplot2
  pivot_longer(., cols = sl_plnt:sl_plnt_hbvr_prdt, 
               names_to = "Scenario", 
               values_to = "RelImpI") %>% 
  # modify the structure to have a Scenario column for each modeling scenario, and an Eqn column that identifies which equation the parameters originate from, which will be used to group them along the y-axis then reorder column Parameter along the values of Relative Importance by Eqn group
  mutate(., 
         Scenario = as_factor(Scenario),
         Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Scenario == "sl_plnt_hbvr" &
                                                        Parameter == "β" |
                                                        Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh" ,
                                          "Herbivore", "Predator"))),
         Eqn = as_factor(Eqn),
         Eqn = fct_relevel(.f = Eqn, "Soil", "Plant", "Herbivore", "Predator"),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn, .na_rm = F),
         Scenario = fct_recode(.f = Scenario, 
                                "Scenario (i)\nNo animals" = "sl_plnt", 
                                "Scenario (ii)\nHerbivore" = "sl_plnt_hbvr", 
                                "Scenario (iii)\nHerbivore & Predator" = "sl_plnt_hbvr_prdt"),
         Scenario = fct_relevel(.f = Scenario, 
                                 "Scenario (i)\nNo animals", 
                                 "Scenario (ii)\nHerbivore", 
                                 "Scenario (iii)\nHerbivore & Predator"),) %>%
  group_by(., Scenario, Nutrient, Compartment)
```

### Carbon and Nitrogen content of trophic compartments

The graphs below (Figures \@ref(fig:vd-gsa-no-herbivore-model-plot),  
\@ref(fig:vd-gsa-herbivore-model-plot), and \@ref(fig:vd-gsa-predator-model-plot)) 
show the relative importance of each parameter across the three modeling scenarios. 

```{r vd-gsa-no-herbivore-model-plot, echo=TRUE, tidy=TRUE, fig.height=6, fig.width=6, fig.cap="Relative importance of parameters for each trophic compartment's equilibrium content of N and C in scenario (i), an ecosystem without animals. Parameters on the y-axis are grouped and coloured based on the trophic compartment they refer to."}
Isfahan2_2cols <- met.brewer("Isfahan2", 4)[-c(3,4)]

# plotting pipe
noherbGSAplot <- noherbGSA %>% 
  # separate column SV (State Variable) into its components, i.e., Compartment and Nutrient
  separate(., col = SV, into = c("Compartment", "Nutrient"), sep = "_") %>% 
  # create a new column, Eqn, to track which equation the parameters originate from, 
  # which will be used to group them along the y-axis 
  # then, make sure columns Compartment, Nutrient, and Eqn are factors
  # finally, reorder column Parameter so along the values of Relative 
  # Importance and grouped by Eqn
  mutate(., Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", "Plant"),
         Compartment = as_factor(Compartment),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Eqn = as_factor(Eqn),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn)) %>% 
  # now, lets build the plot
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), linewidth = 1, alpha = 0.25) +
  scale_fill_manual(values = Isfahan2_2cols) +
  scale_color_manual(values = Isfahan2_2cols) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_grid2(Nutrient~Compartment) +
  theme_classic() +
  theme(legend.position = "top",
        legend.title = element_blank(),
        text = element_text(size = 14),
        panel.spacing = unit(0.75, "lines"))

# modify the y axis to show the proper subscripts
noherbGSAplot2 <- noherbGSAplot + 
  coord_flip(xlim = c(0, 1), expand = T)

# ggsave(plot = noherbGSAplot2, 
#        filename = "../Results/noHerbivoreGSA_Results.svg",
#        device = "svg", dpi = 300)

noherbGSAplot2
```

```{r vd-gsa-herbivore-model-plot, echo=TRUE, tidy=TRUE, fig.height=6, fig.width=8, fig.cap="Relative importance of parameters for each trophic compartment's equilibrium content of N and C in scenario (ii), an ecosystem with only herbivores. Parameters on the y-axis are grouped based on the trophic compartment they are related to (e.g., r~P~, a~P~, δ, and α all refer to the plant trophic compartment). Notice how, for C dynamics, we see evidence of indirect effects of the herbivores on soil C stocks, as shown by parameters a~H~, r~H~, and π---the herbivores' uptake, recycling, and respiration rates, respectively---surpassing the relative importance of the corresponding plant parameters (i.e., a~P~, r~P~, and δ)."}
Isfahan2_3cols <- met.brewer("Isfahan2", 4)[-c(4)]

# plotting pipe
herbGSAplot <- herbGSA %>% 
  # separate column SV (State Variable) into its components, i.e., Compartment and Nutrient
  separate(., col = SV, into = c("Compartment", "Nutrient"), sep = "_") %>% 
  # create a new column, Eqn, to track which equation the parameters 
  # originate from, which will be used to group them along the y-axis 
  # then, make sure columns Compartment, Nutrient, and Eqn are factors
  # finally, reorder column Parameter so along the values of Relative Importance 
  # and grouped by Eqn
  mutate(., Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", "Herbivore")),
         Compartment = as_factor(Compartment),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Eqn = as_factor(Eqn),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn)) %>% 
  # now, lets build the plot
  group_by(., Nutrient, Compartment) %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), linewidth = 1, alpha = 0.25) +
  scale_fill_manual(values = Isfahan2_3cols) +
  scale_color_manual(values = Isfahan2_3cols) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_grid2(Nutrient~Compartment) +
  theme_classic() +
  theme(legend.position = "top",
        legend.title = element_blank(),
        text = element_text(size = 14),
        panel.spacing = unit(0.75, "lines"))

# modify the y axis to show the proper subscripts
herbGSAplot2 <- herbGSAplot + 
  coord_flip(xlim = c(0, 1), expand = T) 

# ggsave(plot = herbGSAplot2, 
#        filename = "../Results/HerbivoreGSA_Results.svg", 
#        device = "svg", dpi = 300, width = 10, height = 6)

herbGSAplot2
```

```{r vd-gsa-predator-model-plot, echo=TRUE, tidy=TRUE, fig.height=6, fig.width=8, fig.cap="Relative importance of parameters for each trophic compartment's equilibrium content of N and C in scenario (iii), an ecosystem with herbivores and predators. The trophic cascade established by the predators' presence is clearly visible, with herbivore-related parameter not having the same weight on plant dynamics as in the figure above. Consequently, soil C stocks appear influence by plant- and predator-related parameters for the most part. "}
# plotting pipe
predGSAplot <- predGSA %>% 
  # separate column SV (State Variable) into its components, i.e., Compartment and Nutrient
  separate(., col = SV, into = c("Compartment", "Nutrient"), sep = "_") %>% 
  # create a new column, Eqn, to track which equation the parameters 
  # originate from, which will be used to group them along the y-axis 
  # then, make sure columns Compartment, Nutrient, and Eqn are factors
  # finally, reorder column Parameter so along the values of Relative Importance 
  # and grouped by Eqn
  mutate(., Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Compartment == "Herbivore" &
                                                        Parameter == "β" |
                                                        Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh" ,
                                          "Herbivore", "Predator"))),
         Compartment = as_factor(Compartment),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
         Eqn = as_factor(Eqn),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn)) %>% 
  # now, lets build the plot
  group_by(., Nutrient, Compartment) %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), linewidth = 1, alpha = 0.25) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_grid2(Nutrient~Compartment) +
  theme_classic() +
  theme(legend.position = "top",
        legend.title = element_blank(),
        text = element_text(size = 14),
        panel.spacing = unit(0.75, "lines"))

# modify the y axis to show the proper subscripts
predGSAplot2 <- predGSAplot + 
  coord_flip(xlim = c(0, 1), expand = T)

# ggsave(plot = herbGSAplot2, 
#        filename = "../Results/HerbivoreGSA_Results.svg", 
#        device = "svg", dpi = 300, width = 10, height = 6)

predGSAplot2
```

### Primary productivity

Similarly, Figure \@ref(fig:vd-gsa-prim-prod-plot) below shows how, for each 
scenario, the model's parameters shape estimates of primary productivity for 
Nitrogen and Carbon, respectively.

```{r vd-gsa-prim-prod-plot, echo=TRUE, tidy=TRUE, fig.height=6, fig.width=8, fig.cap="Comparing the Relative Importance of each parameter in the formulae used to calculate primary productivity, across modeling scenarios, for Nitrogen (panel (a)) and Carbon (panel (b))."}

# nitrogen
PPGSAres_N <- bind_rows(ranked_imp_PPnoherb, ranked_imp_PPherb, ranked_imp_PPpred, .id = "Scenario") %>%
  # pivot to wider format, so we get NAs where scenarios are missing parameter values (because the parameters do not feature in the scenario's equilibria)
  pivot_wider(., names_from = "Scenario", values_from = "RelImpI") %>% 
  # rename the scenarios using clearer names
  rename(.,  "sl_plnt" = "1", "sl_plnt_hbvr" = "2", "sl_plnt_hbvr_prdt" = "3") %>% 
  # now pivot to longer format for plotting with ggplot2
  pivot_longer(., cols = sl_plnt:sl_plnt_hbvr_prdt, 
               names_to = "Scenario", 
               values_to = "RelImpI") %>% 
  # modify the structure to have a Scenario column for each modeling scenario, and an Eqn column that identifies which equation the parameters originate from, which will be used to group them along the y-axis then reorder column Parameter along the values of Relative Importance by Eqn group
  mutate(., 
         Scenario = as_factor(Scenario),
         Scenario = fct_relevel(.f = Scenario, 
                                 "sl_plnt", 
                                 "sl_plnt_hbvr", 
                                 "sl_plnt_hbvr_prdt"),
         Scenario = fct_recode(.f = Scenario, 
                               "Scenario (i)\nNo animals" = "sl_plnt",
                               "Scenario (ii)\nHerbivores" = "sl_plnt_hbvr",
                               "Scenario (iii)\nHerbivores & Predators" = "sl_plnt_hbvr_prdt"),
         Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Scenario == "S-Pl.-H" &
                                                        Parameter == "β" |
                                                        Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh" ,
                                          "Herbivore", "Predator"))),
         Eqn = as_factor(Eqn),
         Eqn = fct_relevel(.f = Eqn, "Soil", "Plant", "Herbivore", "Predator"),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn, .na_rm = F, .desc = FALSE)) 

# plotting pipe
PPGSAplot_N <- PPGSAres_N %>%
  replace_na(., 
             list(Parameter = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  # now, lets build the plot
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, color = Eqn, group = Scenario, alpha = Scenario),
           position = position_dodge2(preserve = "single")) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Modeling\nscenario") +
  theme(legend.position = "right") 

# modify the y axis to show the proper subscripts
PPGSAplot_N2 <- PPGSAplot_N + 
  coord_flip(xlim = c(0,1), expand = T) +
  theme(panel.grid.major.y = element_line(linetype = 2),
        legend.justification = 'left', 
        legend.position = 'right', 
        legend.box = 'vertical', 
        legend.box.just = 'left')

# ggsave(plot = PPGSAplot_N2,
#        filename = "../Results/NitrogenPrimaryProductivity_RI.svg",
#        device = "svg", dpi = 300)

# PPGSAplot_N2

# carbon
PPGSAres_C <- bind_rows(ranked_imp_PPnoherbc, ranked_imp_PPherbc, ranked_imp_PPpredc, .id = "Scenario") %>%
  # pivot to wider format, so we get NAs where scenarios are missing parameter values (because the parameters do not feature in the scenario's equilibria)
  pivot_wider(., names_from = "Scenario", values_from = "RelImpI") %>% 
  # rename the scenarios using clearer names
  rename(.,  "sl_plnt" = "1", "sl_plnt_hbvr" = "2", "sl_plnt_hbvr_prdt" = "3") %>% 
  # now pivot to longer format for plotting with ggplot2
  pivot_longer(., cols = sl_plnt:sl_plnt_hbvr_prdt, 
               names_to = "Scenario", 
               values_to = "RelImpI") %>% 
  # modify the structure to have a Scenario column for each modeling scenario, and an Eqn column that identifies which equation the parameters originate from, which will be used to group them along the y-axis then reorder column Parameter along the values of Relative Importance by Eqn group
  mutate(., 
         Scenario = as_factor(Scenario),
         Scenario = fct_relevel(.f = Scenario, 
                                 "sl_plnt", 
                                 "sl_plnt_hbvr", 
                                 "sl_plnt_hbvr_prdt"),
         Scenario = fct_recode(.f = Scenario, 
                               "Scenario (i)\nNo animals" = "sl_plnt",
                               "Scenario (ii)\nHerbivores" = "sl_plnt_hbvr",
                               "Scenario (iii)\nHerbivores & Predators" = "sl_plnt_hbvr_prdt"),
         Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Scenario == "S-Pl.-H" &
                                                        Parameter == "β" |
                                                        Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh" ,
                                          "Herbivore", "Predator"))),
         Eqn = as_factor(Eqn),
         Eqn = fct_relevel(.f = Eqn, "Soil", "Plant", "Herbivore", "Predator"),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn, .na_rm = F, .desc = FALSE)) 

# plotting pipe
PPGSAplot_C <- PPGSAres_C %>%
  replace_na(., 
             list(Parameter = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>% 
  mutate(., RelImpI_svg = RelImpI + 0.000000001) %>%
  # filter(., Scenario == "S-Pl.-H") %>%
  # now, lets build the plot
  # group_by(., herbivore) %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, color = Eqn, group = Scenario, alpha = Scenario),
           position = position_dodge2(preserve = "single")) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab(" ") + 
  ylab(" ") +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Modeling\nscenario") +
  theme(legend.position = "right")

# modify the y axis to show the proper subscripts
PPGSAplot_C2 <- PPGSAplot_C + 
  coord_flip(xlim = c(0,1), expand = T) +
  theme(panel.grid.major.y = element_line(linetype = 2),
        legend.justification = 'left', 
        legend.position = 'right', 
        legend.box = 'vertical', 
        legend.box.just = 'left') 

# ggsave(plot = PPGSAplot_C2,
#        filename = "../Results/CarbonPrimaryProductivity_RI.svg",
#        device = "svg", dpi = 300)

PPGSAplot_N2 + PPGSAplot_C2 + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") 

# ggsave(filename = "../Results/PP_NandC_RI.svg", device = "svg", dpi = 300, width = 1.25*width, height = height)
```

### Net Ecosystem Carbon Balance

```{r vd-necb-rei-barplot, echo=TRUE, tidy=TRUE, warning=FALSE, fig.cap="Relative parameter importance for equilibrium NECB, when herbivores are absent (light bars) and present (solid bars), as determined by a global sensitivity analysis with NECB value as response variable."}
NECBgsa_res <- bind_rows(ranked_imp_NECB_noherb, ranked_imp_NECB_herb, ranked_imp_NECBpred, .id = "Scenario") %>%
  # pivot to wider format, so we get NAs where scenarios are missing parameter values (because the parameters do not feature in the scenario's equilibria)
  pivot_wider(., names_from = "Scenario", values_from = "RelImpI") %>% 
  # rename the scenarios using clearer names
  rename(.,  "sl_plnt" = "1", "sl_plnt_hbvr" = "2", "sl_plnt_hbvr_prdt" = "3") %>% 
  # now pivot to longer format for plotting with ggplot2
  pivot_longer(., cols = sl_plnt:sl_plnt_hbvr_prdt, 
               names_to = "Scenario", 
               values_to = "RelImpI") %>% 
  # modify the structure to have a Scenario column for each modeling scenario, and an Eqn column that identifies which equation the parameters originate from, which will be used to group them along the y-axis then reorder column Parameter along the values of Relative Importance by Eqn group
  mutate(., 
         Scenario = as_factor(Scenario),
         Scenario = fct_relevel(.f = Scenario, 
                                 "sl_plnt", 
                                 "sl_plnt_hbvr", 
                                 "sl_plnt_hbvr_prdt"),
         Scenario = fct_recode(.f = Scenario, 
                               "(i) No animals" = "sl_plnt",
                               "(ii) Herbivores" = "sl_plnt_hbvr",
                               "(iii) Herbivores &\nPredators" = "sl_plnt_hbvr_prdt"),
         Eqn = ifelse(Parameter == "I" |
                         Parameter == "k" |
                         Parameter == "q",
                         "Soil", ifelse(Parameter == "α" |
                                        Parameter == "δ" |
                                        Parameter == "ap" |
                                        Parameter == "rp",
                                        "Plant", ifelse(Scenario == "S-Pl.-H" &
                                                        Parameter == "β" |
                                                        Parameter == "π" | 
                                                        Parameter == "ah" |
                                                        Parameter == "rh" ,
                                          "Herbivore", "Predator"))),
         Eqn = as_factor(Eqn),
         Eqn = fct_relevel(.f = Eqn, "Soil", "Plant", "Herbivore", "Predator"),
         Parameter = fct_reorder2(.f = Parameter, .x = RelImpI, .y = Eqn, .na_rm = F, .desc = FALSE)) 

NECBgsa_plot <- NECBgsa_res %>%
  replace_na(., 
             list(Parameter = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  # filter(., Scenario == "S-Pl.-H-Pr.") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Scenario, alpha = Scenario),
           position = position_dodge2(preserve = "single")) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) + 
  xlab("Relative Importance Index") + 
  ylab(" ") +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Modeling\nscenario") +
  theme_classic() 

NECBgsa_plot2 <- NECBgsa_plot +
  coord_flip(xlim = c(0,1), expand = T) +
  theme(panel.grid.major.y = element_line(linetype = 2),
        legend.justification = 'left', 
        legend.position = 'right', 
        legend.box = 'vertical', 
        legend.box.just = 'left')

# ggsave(NECBgsa_plot2, filename = "../Results/NECBgsaRI.svg", device = "svg", dpi = 300, width = 1.5*width, height = height)

NECBgsa_plot2
```

## Publication figures

Here we produce figures for the manuscript. These figures will try to summarize 
and capture as much information as possible in as few visuals as possible.

### Stocks

The next three Figures \@ref(fig:pf-no-herb-params-RI-carbon), 
\@ref(fig:pf-herb-params-RI-carbon), and \@ref(fig:pf-pred-params-RI-carbon) are 
re-works of Figures \@ref(fig:vd-gsa-herbivore-model-plot),
\@ref(fig:vd-gsa-no-herbivore-model-plot), and \@ref(fig:vd-gsa-pred-model-plot), 
highlighting the parameters that drive the Carbon content of each trophic 
compartment in the three modeling scenarios, respectively.. 

Figures \@ref(fig:pf-no-herb-params-RI-carbon), 
\@ref(fig:pf-herb-params-RI-carbon), and \@ref(fig:pf-pred-params-RI-carbon) provide 
evidence of the trophic rewiring that increasingly complex trophic food web, 
with primary and secondary consumers---i.e.,
herbivores and predators, respectively---elicit in ecosystems. 
Ultimately, this trophic rewiring underlies their cascading effects and control 
on an ecosystem's ability to capture and store atmospheric C.

```{r pf-no-herb-params-RI-carbon, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="This figure shows the results from the stability analysis for scenario (i), capturing which parameters in the model drive the C content of the soil and plant compartments when no animals are present in the ecosystem."}
noherbRI_C <- pairedRI %>% 
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  filter(., Scenario == "Scenario (i)\nNo animals", 
         Nutrient == "Carbon",
         Compartment != "Herbivore",
         Compartment != "Predator") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.25, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 14),
        panel.grid.major.y = element_line(linetype = 2))

noherbRI2_C <- noherbRI_C +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(noherbRI2_C, filename = "../Results/noherbRI_C.svg", device = "svg", dpi = 300, width = width, height = height)

noherbRI2_C
```

```{r pf-herb-params-RI-carbon, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="Parameters driving trophic compartment C content, as per the stability analyses results for scenario (ii). Notice how, while inorganic inputs (_I_) and leaching (_q_) are the main abiotic drivers of soil C content (pink columns), biotic effects are dominated by herbivore-related parameters (green) rather than plant-related ones (yellow)."}

herbRI_C <- pairedRI %>%
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>% 
  filter(., Scenario == "Scenario (ii)\nHerbivore",
         Nutrient == "Carbon",
         Compartment != "Predator") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.15, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 14),
        panel.grid.major.y = element_line(linetype = 2)) 

herbRI2_C <- herbRI_C +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(herbRI2_C, filename = "../Results/herbRI_C.svg", device = "svg", dpi = 300, width = width, height = height)

herbRI2_C
```

```{r pf-pred-params-RI-carbon, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="This figure shows the relative importance of each parameter in driving the C content of trophic compartments in scenario (iii). Notice how, with a complete food chain, aside from abiotic drivers (pink columns) soil C content is driven mostly by predator- (blue) and plant-related (yellow) parameters. This is a reflection of the trophic cascade eliciting top-down predator control on herbivore popoulation, in turn releasing plants from herbivore control. However, it is notable that predator top-down effects extend all the way to the soil compartment, and that herbivore-mediated effects (green) on soil carbon content still amount to about half of plant-mediated ones."}
predRI_C <- pairedRI %>% 
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  filter(., Scenario == "Scenario (iii)\nHerbivore & Predator", 
         Nutrient == "Carbon") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.15, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment, nrow = 1, ncol = 4) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 18),
        panel.grid.major.y = element_line(linetype = 2)) 

predRI2_C <- predRI_C +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(predRI2_C, filename = "../Results/predRI_C.svg", device = "svg", dpi = 300, width = 1.5*width, height = height)

predRI2_C
```

The next code chunk produces **Figure 2** in the **manuscript**, collating 
together results from the GSA across modeling scenario, focusing on which 
parameters drive C content in the soil and plants compartment. As such, we show
only the code used to produce it here but not the figure itself. Note that 
this figure was manipulated in Inkscape [@inkscape] before including in the 
**manuscript** to improve formatting of the x-axis across all panels.

```{r pf-summary-C-RII-soil-plants,echo=TRUE,tidy=TRUE,fig.show='hide'}
pairedRI %>% 
  # replace all NAs with 0 for plotting
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  # this next line adds a small increment to all values of RelImpI,
  # to avoid artefacts due to some of them being = 0 when saving the plot
  # as .svg
  mutate(., RelImpI_svg = RelImpI + 0.000000001) %>%
  filter(., Nutrient == "Carbon",
         Compartment != "Herbivore" & Compartment != "Predator") %>%
  ggplot(., aes(x = RelImpI_svg, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Scenario), alpha = 0.15, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_grid(Compartment~Scenario) +
  coord_flip(xlim = c(0, 1), expand = T) +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Modeling\nscenario") +
  theme_classic() +
  theme(panel.grid.major.y = element_line(linetype = 2, linewidth = 0.25),
        legend.position = 'top',
        panel.spacing.y = unit(1, "lines"),
        text = element_text(size = 18)) 

# ggsave(filename = "../Results/RI_Cpaired.svg", device = "svg", dpi = 300, width = width, height = height)
```

The following code chunk produces **Figure 3** in the **manuscript**, a summary
of the change in total ecosystem C content across modeling scenarios and of the 
changes in C distribution among trophic compartments in each scenario. As such, 
we show only the code used to produce it here but not the figure itself.

```{r pf-carbon-stocks-summary-fig,echo=TRUE,tidy=TRUE,fig.show='hide'}
Cstock <- randomI %>% 
    pivot_longer(., cols = c(Total_N, Total_C), 
                 names_to = "Compartment", 
                 values_to = "Stock") %>%
  # separate the name of elements in "Compartment" in "Compartment" 
  # and "Nutrient"
    separate(., col = "Compartment", 
             into = c("Compartment", "Nutrient"), 
             sep = "_") %>%
  # make sure "Compartment" and "herbivore" are factors
    mutate(., Compartment = as_factor(Compartment),
           herbivore = as_factor(herbivore),
           herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nNo animals" = "absent", 
                                "Scenario (ii)\nHerbivores" = "herbivore", 
                                "Scenario (iii)\nHerbivores & Predators" = "predator"),
           Nutrient = as_factor(Nutrient),
           Nutrient = fct_recode(.f = Nutrient, Nitrogen = "N", Carbon = "C"),
           Nutrient = fct_relevel(.f = Nutrient, "Carbon", "Nitrogen")) %>%
  # group by the three factors of interest
    dplyr::group_by(., herbivore, 
                    Compartment, 
                    Nutrient) %>% 
  # filter the top and bottom 5% of data points to remove outliers
    dplyr::filter(., Nutrient == "Carbon",
                  between(Stock, 
                          quantile(Stock, 0.05, na.rm = T), 
                          quantile(Stock, 0.95, na.rm = T)),
                  .preserve = TRUE) %>% 
  # plot the results
    ggplot(., aes(x = herbivore, y = Stock, col = herbivore)) + 
    gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05, fatten = 4) +
    gghalves::geom_half_point(shape = 21, alpha = 0.05, stroke = 1) +
    xlab(" ") +
    scale_color_met_d("Egypt", direction = 1) +
    scale_y_continuous(
      trans = "log10",
      breaks = function(x) {
        brks <- scales::extended_breaks(Q = c(0.1, 5))(log10(x))
        10^(brks[brks %% 1 == 0])
      },
      labels = scales::math_format(format = log10)
    ) +
    theme_classic() +
    theme(legend.position = "none")

stdBP_C <- randomI %>% 
  pivot_longer(., cols = c(Soil_Nstd:Plant_Cstd, Herbivore_Nstd, Herbivore_Cstd, Predator_Nstd, Predator_Cstd), 
               names_to = "Compartment", 
               values_to = "Stock") %>% 
  separate(., col = "Compartment", 
           into = c("Compartment", "Nutrient"), 
           sep = "_") %>%
  mutate(., Compartment = as_factor(Compartment),
         herbivore = as_factor(herbivore),
         herbivore = fct_recode(.f = herbivore, 
                                "Scenario (i)\nNo animals" = "absent", 
                                "Scenario (ii)\nHerbivores" = "herbivore", 
                                "Scenario (iii)\nHerbivores & Predators" = "predator"),
         Nutrient = as_factor(Nutrient),
         Nutrient = fct_recode(.f = Nutrient, Carbon = "Cstd", Nitrogen = "Nstd"),
         Nutrient = fct_relevel(.f = Nutrient, sort)) %>%
  dplyr::group_by(., herbivore, 
                  Compartment, 
                  Nutrient) %>% 
  dplyr::filter(., Nutrient == "Carbon",
                between(Stock, 
                        quantile(Stock, 0.05, na.rm = T), 
                        quantile(Stock, 0.95, na.rm = T)),
                .preserve = TRUE) %>% 
  ggplot(., aes(x = Compartment, y = Stock, col = Compartment)) + 
  gghalves::geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05, fatten = 4) +
  gghalves::geom_half_point(shape = 21, alpha = 0.05, stroke = 1) +
  ylab("Standardised nutrient content") + 
  xlab(" ") +
  scale_color_met_d("Isfahan2", direction = 1) + 
  guides(color = guide_legend(title = "Compartment", override.aes = list(alpha = 1, stroke = 1))) +
  facet_wrap(.~herbivore) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "top")

Cstock + stdBP_C + plot_layout(widths = c(1,1.3)) + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/Cstocks_AbsRel.svg", device = "svg", dpi = 300, width = width, height = height)
```

The following three figures complement Figures \@ref(fig:pf-no-herb-params-RI-carbon), 
\@ref(fig:pf-herb-params-RI-carbon), and \@ref(fig:pf-pred-params-RI-carbon) by showing
the relative importance of parameters in shaping N content of the trophic 
compartments across modeling scenarios.

```{r pf-scenario-1-params-RI-nitrogen, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="This figure shows the results from the stability analysis for the modeling scenario (i), an ecosystem without animals, capturing which parameters in the model drive the N content of the soil and plant compartments."}

noherbRI_N<- pairedRI %>%
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  filter(., Scenario == "Scenario (i)\nNo animals", 
         Nutrient == "Nitrogen",
         Compartment != "Herbivore",
         Compartment != "Predator") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.25, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 14),
        panel.grid.major.y = element_line(linetype = 2))

noherbRI2_N <- noherbRI_N +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(noherbRI2_N, filename = "../Results/noherbRI_N.svg", device = "svg", dpi = 300, width = width, height = height)

noherbRI2_N
```

```{r pf-herb-params-RI-nitrogen, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="This figure shows the results from the stability analyses for the modeling scenario (ii), an ecosystem with herbivores but no predators, capturing which parameters in the model drive the N content of the soil, plants, and herbivores compartments."}

herbRI_N<- pairedRI %>%
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  filter(., Scenario == "Scenario (ii)\nHerbivore", 
         Nutrient == "Nitrogen",
         Compartment != "Predator") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.25, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 14),
        panel.grid.major.y = element_line(linetype = 2))

herbRI2_N <- herbRI_N +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(herbRI2_N, filename = "../Results/herbRI_N.svg", device = "svg", dpi = 300, width = width, height = height)

herbRI2_N
```

```{r pf-pred-params-RI-nitrogen, echo=TRUE, tidy=TRUE, warning=FALSE, layout="l-body-outset", fig.width=8, fig.height=6, fig.cap="This figure shows the results from the stability analysis for the modeling scenario (iii), an ecosystem with herbivores and predators, capturing which parameters in the model drive the N content of all compartments in the model."}

predRI_N<- pairedRI %>%
  replace_na(., 
             list(Parameter = "unknown", Compartment = "unknown", 
                  Nutrient = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  filter(., Scenario == "Scenario (iii)\nHerbivore & Predator", Nutrient == "Nitrogen") %>%
  ggplot(., aes(x = RelImpI, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Eqn), alpha = 0.25, lwd = 1) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab("Relative Importance Index") + 
  ylab(" ") +
  facet_wrap(.~Compartment, nrow = 1, ncol = 4) +
  labs(fill = "Trophic Compartment", col = "Trophic Compartment") +
  theme_classic() +
  theme(text = element_text(size = 14),
        panel.grid.major.y = element_line(linetype = 2))

predRI2_N <- predRI_N +
  coord_flip(xlim = c(0, 1), expand = T) +
  theme(legend.position = "top")

# ggsave(predRI2_N, filename = "../Results/predRI_N.svg", device = "svg", dpi = 300, width = width, height = height)

predRI2_N
```

### Primary productivity

Moving to the results for [Primary Productivity] ($\Phi^*_{P_C}$, PP) at equilibrium,
here we show the code to produce **Figure 4** in the **manuscript**. As before, 
we do not show the figure itself since it features in the main text. Note that 
this figure was manipulated in Inkscape [@inkscape] before including in the 
**manuscript** to improve formatting of the x-axis in panel (b).

```{r pf-pp-summary-bp-rii, echo=TRUE, tidy=TRUE, layout="l-body-outset", fig.show='hide', fig.width=10, fig.height=6, fig.cap="Combined plot showing differences in primary productivity at equilibrium (panel (a)) and the relative weight of each parameter in shaping it (panel (b)) across the three modeling scenarios. In panel (b), bars are colored based on the equation each parameter originates from and colors are either transparent (scenario (i), animals absent), light-colored (scenario (ii), only herbivores present), or solid (scenario (iii), herbivores and predators present)."}
PPbp <- PrimProd %>%
  # make sure "Compartment" and "herbivore" are factors
    mutate(., 
           herbivore = as_factor(herbivore),
           herbivore = fct_recode(.f = herbivore, 
                                "(i)No animals" = "absent", 
                                "(ii) Herbivores" = "herbivore", 
                                "(iii) Herbivores &\nPredators" = "predator"),) %>%
  # group by the three factors of interest
    dplyr::group_by(., herbivore) %>% 
    ggplot(., aes(x = herbivore, y = PPc, col = herbivore)) + 
    geom_half_boxplot(center = T, outlier.color = NA, notch = T, errorbar.draw = F, nudge = 0.05, fatten = 4) +
    geom_half_point(shape = 21, alpha = 0.25, stroke = 1) +
    ylab(expression(Primary~Productivity~(Phi[P[C]]^{"*"}))) +
    xlab(" ") +
    scale_color_met_d("Egypt", direction = 1) +
    theme(legend.position = "none")


PPbp_pub <- PPbp + scale_y_continuous(
    trans = "log10",
    breaks = function(x) {
      brks <- scales::extended_breaks(Q = c(0.1, 5))(log10(x))
      10^(brks[brks %% 1 == 0])
    },
    labels = scales::math_format(format = log10)
  ) 

PPGSAplot_C3 <- PPGSAres_C %>%
  replace_na(., 
             list(Parameter = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>% 
  # add a microscopic increase to the values of relative parameter importance to 
  # ensure all parameters' bars "show up" on the graph
  mutate(., RelImpI_svg = RelImpI + 0.000000001) %>%
  ggplot(., aes(x = RelImpI_svg, y = Parameter)) + 
  geom_col(aes(fill = Eqn, color = Eqn, group = Scenario, alpha = Scenario),
           position = position_dodge2(preserve = "single")) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) +
  xlab(" ") + 
  ylab(" ") +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Modeling\nscenario") +
  coord_flip(xlim = c(0,1), expand = T) +
  theme(panel.grid.major.y = element_line(linetype = 2),
        legend.justification = 'left', 
        legend.position = 'right', 
        legend.box = 'vertical', 
        legend.box.just = 'left') 

PPbp_pub + PPGSAplot_C3 + plot_layout(widths = c(1,1.3)) + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") 

# ggsave(filename = "../Results/PrimProd_bpREI_pred.svg", device = "svg", dpi = 300, width = 1.15*width, height = height)
```

The following figure shows the change in $\Phi^*_P$ with herbivore uptake 
rate (top row) and with herbivore recycling rate (bottom row). Insets in each 
panel zoom in to show the area around `y = 0` in greater detail.

```{r pf--pp-summary-pd-insets, echo=TRUE, tidy=TRUE, message=FALSE, layout="l-body-outset", fig.width=10, fig.height=5, fig.cap = "Change in equilibrium primary productivity with herbivores' uptake (a~H~, **top row**) and recycling (r~H~, **bottom row**) rates. Data points in blue (red) identify instances in which---contrary to expectations---primary productivity increases (decreases) with respect to increasing values of uptake (recycling) rate. Insets show the region around _y = 0_ (dashed black line) for each panel in greater detail. Note the different y-axis scales."}
dPPahplot <- dPPah %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 2, size = 2) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_line(aes(y = 0), lty = 2) +
  ylab("Change in Primary Productivity") +
  xlab(expression(Uptake~rate~(a[H]))) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  scale_y_continuous(label = fancy_scientific) +
  guides(color = "none", alpha = "none") 

dPPahZoom <- dPPah %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 2, size = 2) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(" ") +
  xlab(" ") +
  scale_alpha_discrete(range = c(0.25, 1)) +
  scale_y_continuous(label = fancy_scientific) +
  coord_cartesian(ylim = c(-2000, 2000)) +
  guides(color = "none", alpha = "none") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 0.25))

dPPrhplot <- dPPrh %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 2, size = 2) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_line(aes(y = 0), lty = 2) +
  ylab("Change in Primary Productivity") +
  xlab(expression(Recycling~rate~(r[H]))) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  scale_y_continuous(label = fancy_scientific) +
  guides(color = "none", alpha = "none") 

dPPrhZoom <- dPPrh %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign, alpha = dPPsign), shape = 21, stroke = 2, size = 2) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(" ") +
  xlab(" ") +
  scale_alpha_discrete(range = c(0.25, 1)) +
  scale_y_discrete(labels = fancy_scientific) +
  coord_cartesian(ylim = c(-2000, 2000)) +
  guides(color = "none", alpha = "none") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 0.25))

# create inset plots
dPPahInset <- dPPahplot + inset_element(dPPahZoom, 0.15, 0.15, 0.95, 0.75, clip = T, ignore_tag = F) 

dPPrhInset <- dPPrhplot + inset_element(dPPrhZoom, 0.15, 0.15, 0.95, 0.75, clip = T, ignore_tag = F)

# assemble combined plot
dPPahInset + dPPrhInset

# ggsave(filename = "../Results/dPPvsHerbT_insets.svg", device = "svg", dpi = 300, width = 1.5*height, height = width)
```

Putting these two figures together as a summary fro Primary Productivity.

```{r pp-summary-bp-rii-pds, echo=TRUE, tidy=TRUE, fig.show='hide'}
# assemble combined figure
((PPbp_pub + PPGSAplot_C2) / (dPPahInset + dPPrhInset)) + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") 

# ggsave(filename = "../Results/PPsummary.svg", device = "svg", dpi = 300, width = 1.15*width, height = width)
```

### Net Ecosystem Carbon Balance

The next code chunk produces **Figure 5** in the **manuscript**. As above, we show the
code but not the figure itself. Note that this figure was manipulated in 
Inkscape [@inkscape] before including in the **manuscript** to improve 
formatting of the x-axis in panel (d).

```{r pf-necb-summary, echo=TRUE, tidy=TRUE, message = FALSE, warning=FALSE, fig.show='hide', layout="l-body-outset", fig.width=10, fig.height=8}
NECBbp_log <- NECBbp + scale_y_continuous(
    trans = "log10",
    breaks = function(x) {
      brks <- scales::extended_breaks(Q = c(0.1, 5))(log10(x))
      10^(brks[brks %% 1 == 0])
    },
    labels = scales::math_format(format = log10)
  ) 

herbNECBhm <- herbNECBhm + theme(legend.position = "right", axis.text = element_text(size = 7.5)) 

predNECBhm <- predNECBhm + theme(legend.position = "right", axis.text = element_text(size = 7.5))

NECBgsa_plot3 <- NECBgsa_res %>%
  replace_na(., 
             list(Parameter = "unknown", Scenario = "unknown", 
                  RelImpI = 0, Eqn = "unknown")) %>%
  # add a microscopic increase to the values of relative parameter importance to 
  # ensure all parameters' bars "show up" on the graph
  mutate(., RelImpI_svg = RelImpI + 0.000000001) %>%
  ggplot(., aes(x = RelImpI_svg, y = Parameter)) + 
  geom_col(aes(fill = Eqn, col = Eqn, group = Scenario, alpha = Scenario),
           position = position_dodge2(preserve = "single")) +
  scale_fill_met_d(name = "Isfahan2", direction = 1) +
  scale_color_met_d(name = "Isfahan2", direction = 1) + 
  xlab("Relative Importance Index") + 
  ylab(" ") +
  labs(fill = "Trophic\nCompartment", col = "Trophic\nCompartment", alpha = "Scenario") +
  theme_classic() +
  coord_flip(xlim = c(0,1), expand = T) +
  theme(panel.grid.major.y = element_line(linetype = 2),
        legend.justification = 'left', 
        legend.position = 'right', 
        legend.box = 'vertical', 
        legend.box.just = 'left')

# assemble combined plot
((NECBbp_log + herbNECBhm + predNECBhm) / NECBgsa_plot3) + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") 

# ggsave(filename = "../Results/NECBsummary_log_pred.svg", device = "svg", dpi = 300, width = 1.15*width, height = 1.15*height)
```

### Supplementary Information

Here, we present the code to produce **Figure S1**, **S2**, and **S3** in the 
**Supplementary Information**. As with figures featured in the manuscript, we do 
not show the figures themselves but only the code used to produce them.

This next code chunk produces **Figure S1**.

```{r pf-si-figS1-stock-contrast, echo=TRUE, tidy=TRUE,fig.show='hide'}
stockContrast + scale_y_continuous(
    trans = "log10",
    breaks = function(x) {
      brks <- scales::extended_breaks(Q = c(0.1, 5))(log10(x))
      10^(brks[brks %% 1 == 0])
    },
    labels = scales::math_format(format = log10)
  ) 

# ggsave(filename = "../Results/HerbivoreContrast_randomI.svg",
#        dpi = 300, path = "../Results/", device = "svg", 
#        height = height, width = width)
```

The code chunk below produces **Figure S2**.

```{r pf-si-figS2-prim-prod-pd-scenario-2-summary, echo=TRUE, tidy=TRUE, warning=FALSE, message = FALSE, fig.show='hide'}
dPPwrt_ah <- dPPah %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_point(data = subset(dPPah, dPPsign == "pos"), 
             color = "#00BFC4", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  guides(color = "none")

dPPwrt_ah_inset <- dPPwrt_ah + ggmagnify::geom_magnify(from = c(0, 10, -1500, 1500), to = c(3.5, 9.9, -7.5e11,-2.5e11), axes = "xy")

dPPwrt_rh <- dPPrh %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  geom_point(data = subset(dPPrh, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Herbivore~recycling~rate~(r[H]))) +
  guides(color = "none")

dPPwrt_rh_inset <- dPPwrt_rh + ggmagnify::geom_magnify(from = c(0, 10, -1500, 1500), to = c(3.5, 9.9, 6.5e11,2.5e11), axes = "xy")

dPPwrt_ah_inset + dPPwrt_rh_inset + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")

# ggsave(filename = "../Results/PrimProd_Scenario2PD_summary.eps",
#        dpi = 300, path = "../Results/", device = "eps", 
#        height = height, width = width)
```

Finally, the code chunk below produces **Figure S3**.

```{r pf-si-figS3-prim-prod-pd-scenario-3-summary, echo=TRUE, warning=FALSE, message = FALSE, tidy=TRUE, fig.show='hide'}
dPPwrt_ar <- dPPar %>%
  filter(., Nutrient == "Carbon") %>% 
  ggplot(., aes(x = ar, y = dPP)) +
  geom_point(aes(color = dPPsign), shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_pos) +
  geom_point(data = subset(dPPar, dPPsign == "pos"), color = "#00BFC4", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Predator~uptake~rate~(a[R]))) +
  guides(color = "none")

dPPwrt_ar_inset <- dPPwrt_ar + ggmagnify::geom_magnify(from = c(0, 10, -1500, 1500), to = c(4.5, 9.5, -1.25e08, -4e07), axes = "xy")

dPPwrt_rr <- dPPrr %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rr, y = dPP)) +
  geom_point(aes(color = dPPsign), 
             shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.25, 1)) +
  geom_point(data = subset(dPPrr, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Predator~recycling~rate~(r[R]))) +
  scale_alpha_continuous(range = c(0.5,0.25)) +
  guides(color = "none")

dPPwrt_rr_inset <- dPPwrt_rr + ggmagnify::geom_magnify(from = c(0, 10, -1500, 1500), to = c(0.5, 5, 130000, 560000), axes = "xy")

dPPwrt_ah_pred <- dPPah_pred %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = ah, y = dPP)) +
  geom_point(aes(color = dPPsign), shape = 21, stroke = 1) +
  geom_point(data = subset(dPPah_pred, dPPsign == "neg"), color = "#F8766D", shape = 21, stroke = 1) +
  scale_color_manual(values = pp_highlight_neg) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Herbivore~uptake~rate~(a[H]))) +
  guides(color = "none")

dPPwrt_ah_pred_inset <- dPPwrt_ah_pred + ggmagnify::geom_magnify(from = c(0, 10, -1000, 1000), to = c(0, 5, 2e+05, 4.5e+05), axes = "xy")

dPPwrt_rh_pred <- dPPrh_pred %>%
  filter(., Nutrient == "Carbon") %>%
  ggplot(., aes(x = rh, y = dPP)) +
  geom_point(aes(color = dPPsign), 
             shape = 21, stroke = 1) +
  geom_point(data = subset(dPPrh_pred, dPPsign == "neg"), 
             color = "#F8766D", shape = 21, stroke = 1) +
  geom_line(aes(y = 0), lty = 2) +
  ylab(expression(Phi[P]^{"*"})) +
  xlab(expression(Herbivore~recycling~rate~(r[H]))) +
  scale_color_manual(values = pp_highlight_neg) +
  guides(color = "none")

dPPwrt_rh_pred_inset <- dPPwrt_rh_pred + ggmagnify::geom_magnify(from = c(0.1, 9.9, -1000, 1000), to = c(0, 5, -20000, -57500), axes = "xy") +geom_line(aes(y = 0), lty = 2)

((dPPwrt_ar_inset + dPPwrt_rr_inset)/(dPPwrt_ah_pred_inset + dPPwrt_rh_pred_inset)) + plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") & theme(text = element_text(size = 14))

# ggsave(filename = "../Results/PrimProd_Scenario3PD_summary.eps",
#        dpi = 300, path = "../Results/", device = "eps", 
#        height = height, width = width)
```